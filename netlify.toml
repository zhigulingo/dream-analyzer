# netlify.toml

[functions]
  # Path to the bot functions folder
  directory = "bot/functions/"
  node_bundler = "esbuild"
  # Ensure RAG knowledge file is bundled with functions that reference it
  included_files = ["docs/dream_symbols_archetypes.json"]

# Schedules removed per request; flow is DB-triggered and reactive

# Build settings for root deployment (functions only)
[build]
  # No build needed for root, just functions
  command = "echo 'Root deployment - functions only'"
  # No publish directory for root
  publish = ""

# Environment variables needed for build
[build.environment]
  NODE_VERSION = "20"
  NPM_CONFIG_AUDIT = "false"
  NPM_CONFIG_FUND = "false"
  NPM_CONFIG_OPTIONAL = "true"

# Monitoring endpoints
[[redirects]]
  from = "/api/cache/*"
  to = "/.netlify/functions/cache-monitoring"
  status = 200

[[redirects]]
  from = "/api/health"
  to = "/.netlify/functions/health-check"
  status = 200

[[redirects]]
  from = "/api/metrics"
  to = "/.netlify/functions/performance-metrics"
  status = 200

[[redirects]]
  from = "/api/errors"
  to = "/.netlify/functions/error-monitoring"
  status = 200

[[redirects]]
  from = "/api/business"
  to = "/.netlify/functions/business-metrics"
  status = 200

[[redirects]]
  from = "/api/dashboard"
  to = "/.netlify/functions/monitoring-dashboard"
  status = 200

# Bot webhook redirect
[[redirects]]
  from = "/bot"
  to = "/.netlify/functions/bot"
  status = 200

[[redirects]]
  from = "/api/analyze-dream-background"
  to = "/.netlify/functions/analyze-dream-background"
  status = 200

[[redirects]]
  from = "/api/ingest-knowledge"
  to = "/.netlify/functions/ingest-knowledge"
  status = 200

[[redirects]]
  from = "/api/ingest-knowledge-background"
  to = "/.netlify/functions/ingest-knowledge-background"
  status = 200

[[redirects]]
  from = "/api/set-demographics"
  to = "/.netlify/functions/set-demographics"
  status = 200

# SPA fallback - все неизвестные роуты перенаправляем на index.html для Vue роутера
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
