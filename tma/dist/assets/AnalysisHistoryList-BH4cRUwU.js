import{d as Be,r as ne,c as b,a as r,o as i,b as s,s as je,M as gt,w as _t,e as E,t as H,F as ee,A as re,n as pe,m as xt,u as bt,N as wt,C as he,k as Le,q as Ye,l as we,D as Xe,z as Re,f as qe,h as kt,E as $t,G as Mt,j as St}from"./main-BDeUuytG.js";import{c as Oe,g as ze}from"./_commonjsHelpers-Cpj98o6Y.js";import{_ as Fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";var Ee={exports:{}},Ge;function Ke(){return Ge||(Ge=1,function(V,G){(function(a,P){V.exports=P()})(Oe,function(){var a=1e3,P=6e4,J=36e5,q="millisecond",T="second",B="minute",x="hour",I="day",W="week",N="month",k="quarter",R="year",g="date",f="Invalid Date",j=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,Y=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,l={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(C){var v=["th","st","nd","rd"],d=C%100;return"["+C+(v[(d-20)%10]||v[d]||v[0])+"]"}},y=function(C,v,d){var p=String(C);return!p||p.length>=v?C:""+Array(v+1-p.length).join(d)+C},w={s:y,z:function(C){var v=-C.utcOffset(),d=Math.abs(v),p=Math.floor(d/60),h=d%60;return(v<=0?"+":"-")+y(p,2,"0")+":"+y(h,2,"0")},m:function C(v,d){if(v.date()<d.date())return-C(d,v);var p=12*(d.year()-v.year())+(d.month()-v.month()),h=v.clone().add(p,N),z=d-h<0,F=v.clone().add(p+(z?-1:1),N);return+(-(p+(d-h)/(z?h-F:F-h))||0)},a:function(C){return C<0?Math.ceil(C)||0:Math.floor(C)},p:function(C){return{M:N,y:R,w:W,d:I,D:g,h:x,m:B,s:T,ms:q,Q:k}[C]||String(C||"").toLowerCase().replace(/s$/,"")},u:function(C){return C===void 0}},_="en",c={};c[_]=l;var m="$isDayjsObject",$=function(C){return C instanceof ve||!(!C||!C[m])},L=function C(v,d,p){var h;if(!v)return _;if(typeof v=="string"){var z=v.toLowerCase();c[z]&&(h=z),d&&(c[z]=d,h=z);var F=v.split("-");if(!h&&F.length>1)return C(F[0])}else{var Z=v.name;c[Z]=v,h=Z}return!p&&h&&(_=h),h||!p&&_},U=function(C,v){if($(C))return C.clone();var d=typeof v=="object"?v:{};return d.date=C,d.args=arguments,new ve(d)},M=w;M.l=L,M.i=$,M.w=function(C,v){return U(C,{locale:v.$L,utc:v.$u,x:v.$x,$offset:v.$offset})};var ve=function(){function C(d){this.$L=L(d.locale,null,!0),this.parse(d),this.$x=this.$x||d.x||{},this[m]=!0}var v=C.prototype;return v.parse=function(d){this.$d=function(p){var h=p.date,z=p.utc;if(h===null)return new Date(NaN);if(M.u(h))return new Date;if(h instanceof Date)return new Date(h);if(typeof h=="string"&&!/Z$/i.test(h)){var F=h.match(j);if(F){var Z=F[2]-1||0,X=(F[7]||"0").substring(0,3);return z?new Date(Date.UTC(F[1],Z,F[3]||1,F[4]||0,F[5]||0,F[6]||0,X)):new Date(F[1],Z,F[3]||1,F[4]||0,F[5]||0,F[6]||0,X)}}return new Date(h)}(d),this.init()},v.init=function(){var d=this.$d;this.$y=d.getFullYear(),this.$M=d.getMonth(),this.$D=d.getDate(),this.$W=d.getDay(),this.$H=d.getHours(),this.$m=d.getMinutes(),this.$s=d.getSeconds(),this.$ms=d.getMilliseconds()},v.$utils=function(){return M},v.isValid=function(){return this.$d.toString()!==f},v.isSame=function(d,p){var h=U(d);return this.startOf(p)<=h&&h<=this.endOf(p)},v.isAfter=function(d,p){return U(d)<this.startOf(p)},v.isBefore=function(d,p){return this.endOf(p)<U(d)},v.$g=function(d,p,h){return M.u(d)?this[p]:this.set(h,d)},v.unix=function(){return Math.floor(this.valueOf()/1e3)},v.valueOf=function(){return this.$d.getTime()},v.startOf=function(d,p){var h=this,z=!!M.u(p)||p,F=M.p(d),Z=function(ye,ie){var de=M.w(h.$u?Date.UTC(h.$y,ie,ye):new Date(h.$y,ie,ye),h);return z?de:de.endOf(I)},X=function(ye,ie){return M.w(h.toDate()[ye].apply(h.toDate("s"),(z?[0,0,0,0]:[23,59,59,999]).slice(ie)),h)},se=this.$W,te=this.$M,oe=this.$D,ce="set"+(this.$u?"UTC":"");switch(F){case R:return z?Z(1,0):Z(31,11);case N:return z?Z(1,te):Z(0,te+1);case W:var ue=this.$locale().weekStart||0,be=(se<ue?se+7:se)-ue;return Z(z?oe-be:oe+(6-be),te);case I:case g:return X(ce+"Hours",0);case x:return X(ce+"Minutes",1);case B:return X(ce+"Seconds",2);case T:return X(ce+"Milliseconds",3);default:return this.clone()}},v.endOf=function(d){return this.startOf(d,!1)},v.$set=function(d,p){var h,z=M.p(d),F="set"+(this.$u?"UTC":""),Z=(h={},h[I]=F+"Date",h[g]=F+"Date",h[N]=F+"Month",h[R]=F+"FullYear",h[x]=F+"Hours",h[B]=F+"Minutes",h[T]=F+"Seconds",h[q]=F+"Milliseconds",h)[z],X=z===I?this.$D+(p-this.$W):p;if(z===N||z===R){var se=this.clone().set(g,1);se.$d[Z](X),se.init(),this.$d=se.set(g,Math.min(this.$D,se.daysInMonth())).$d}else Z&&this.$d[Z](X);return this.init(),this},v.set=function(d,p){return this.clone().$set(d,p)},v.get=function(d){return this[M.p(d)]()},v.add=function(d,p){var h,z=this;d=Number(d);var F=M.p(p),Z=function(te){var oe=U(z);return M.w(oe.date(oe.date()+Math.round(te*d)),z)};if(F===N)return this.set(N,this.$M+d);if(F===R)return this.set(R,this.$y+d);if(F===I)return Z(1);if(F===W)return Z(7);var X=(h={},h[B]=P,h[x]=J,h[T]=a,h)[F]||1,se=this.$d.getTime()+d*X;return M.w(se,this)},v.subtract=function(d,p){return this.add(-1*d,p)},v.format=function(d){var p=this,h=this.$locale();if(!this.isValid())return h.invalidDate||f;var z=d||"YYYY-MM-DDTHH:mm:ssZ",F=M.z(this),Z=this.$H,X=this.$m,se=this.$M,te=h.weekdays,oe=h.months,ce=h.meridiem,ue=function(ie,de,ke,ge){return ie&&(ie[de]||ie(p,z))||ke[de].slice(0,ge)},be=function(ie){return M.s(Z%12||12,ie,"0")},ye=ce||function(ie,de,ke){var ge=ie<12?"AM":"PM";return ke?ge.toLowerCase():ge};return z.replace(Y,function(ie,de){return de||function(ke){switch(ke){case"YY":return String(p.$y).slice(-2);case"YYYY":return M.s(p.$y,4,"0");case"M":return se+1;case"MM":return M.s(se+1,2,"0");case"MMM":return ue(h.monthsShort,se,oe,3);case"MMMM":return ue(oe,se);case"D":return p.$D;case"DD":return M.s(p.$D,2,"0");case"d":return String(p.$W);case"dd":return ue(h.weekdaysMin,p.$W,te,2);case"ddd":return ue(h.weekdaysShort,p.$W,te,3);case"dddd":return te[p.$W];case"H":return String(Z);case"HH":return M.s(Z,2,"0");case"h":return be(1);case"hh":return be(2);case"a":return ye(Z,X,!0);case"A":return ye(Z,X,!1);case"m":return String(X);case"mm":return M.s(X,2,"0");case"s":return String(p.$s);case"ss":return M.s(p.$s,2,"0");case"SSS":return M.s(p.$ms,3,"0");case"Z":return F}return null}(ie)||F.replace(":","")})},v.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},v.diff=function(d,p,h){var z,F=this,Z=M.p(p),X=U(d),se=(X.utcOffset()-this.utcOffset())*P,te=this-X,oe=function(){return M.m(F,X)};switch(Z){case R:z=oe()/12;break;case N:z=oe();break;case k:z=oe()/3;break;case W:z=(te-se)/6048e5;break;case I:z=(te-se)/864e5;break;case x:z=te/J;break;case B:z=te/P;break;case T:z=te/a;break;default:z=te}return h?z:M.a(z)},v.daysInMonth=function(){return this.endOf(N).$D},v.$locale=function(){return c[this.$L]},v.locale=function(d,p){if(!d)return this.$L;var h=this.clone(),z=L(d,p,!0);return z&&(h.$L=z),h},v.clone=function(){return M.w(this.$d,this)},v.toDate=function(){return new Date(this.valueOf())},v.toJSON=function(){return this.isValid()?this.toISOString():null},v.toISOString=function(){return this.$d.toISOString()},v.toString=function(){return this.$d.toUTCString()},C}(),xe=ve.prototype;return U.prototype=xe,[["$ms",q],["$s",T],["$m",B],["$H",x],["$W",I],["$M",N],["$y",R],["$D",g]].forEach(function(C){xe[C[1]]=function(v){return this.$g(v,C[0],C[1])}}),U.extend=function(C,v){return C.$i||(C(v,ve,U),C.$i=!0),U},U.locale=L,U.isDayjs=$,U.unix=function(C){return U(1e3*C)},U.en=c[_],U.Ls=c,U.p={},U})}(Ee)),Ee.exports}var Dt=Ke();const ae=ze(Dt);var Qe={exports:{}};(function(V,G){(function(a,P){V.exports=P()})(Oe,function(){return function(a,P,J){a=a||{};var q=P.prototype,T={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function B(I,W,N,k){return q.fromToBase(I,W,N,k)}J.en.relativeTime=T,q.fromToBase=function(I,W,N,k,R){for(var g,f,j,Y=N.$locale().relativeTime||T,l=a.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],y=l.length,w=0;w<y;w+=1){var _=l[w];_.d&&(g=k?J(I).diff(N,_.d,!0):N.diff(I,_.d,!0));var c=(a.rounding||Math.round)(Math.abs(g));if(j=g>0,c<=_.r||!_.r){c<=1&&w>0&&(_=l[w-1]);var m=Y[_.l];R&&(c=R(""+c)),f=typeof m=="string"?m.replace("%d",c):m(c,W,_.l,j);break}}if(W)return f;var $=j?Y.future:Y.past;return typeof $=="function"?$(f):$.replace("%s",f)},q.to=function(I,W){return B(I,W,this,!0)},q.from=function(I,W){return B(I,W,this)};var x=function(I){return I.$u?J.utc():J()};q.toNow=function(I){return this.to(x(this),I)},q.fromNow=function(I){return this.from(x(this),I)}}})})(Qe);var Ct=Qe.exports;const Tt=ze(Ct);var et={exports:{}};(function(V,G){(function(a,P){V.exports=P()})(Oe,function(){var a="minute",P=/[+-]\d\d(?::?\d\d)?/g,J=/([+-]|\d\d)/g;return function(q,T,B){var x=T.prototype;B.utc=function(f){var j={date:f,utc:!0,args:arguments};return new T(j)},x.utc=function(f){var j=B(this.toDate(),{locale:this.$L,utc:!0});return f?j.add(this.utcOffset(),a):j},x.local=function(){return B(this.toDate(),{locale:this.$L,utc:!1})};var I=x.parse;x.parse=function(f){f.utc&&(this.$u=!0),this.$utils().u(f.$offset)||(this.$offset=f.$offset),I.call(this,f)};var W=x.init;x.init=function(){if(this.$u){var f=this.$d;this.$y=f.getUTCFullYear(),this.$M=f.getUTCMonth(),this.$D=f.getUTCDate(),this.$W=f.getUTCDay(),this.$H=f.getUTCHours(),this.$m=f.getUTCMinutes(),this.$s=f.getUTCSeconds(),this.$ms=f.getUTCMilliseconds()}else W.call(this)};var N=x.utcOffset;x.utcOffset=function(f,j){var Y=this.$utils().u;if(Y(f))return this.$u?0:Y(this.$offset)?N.call(this):this.$offset;if(typeof f=="string"&&(f=function(_){_===void 0&&(_="");var c=_.match(P);if(!c)return null;var m=(""+c[0]).match(J)||["-",0,0],$=m[0],L=60*+m[1]+ +m[2];return L===0?0:$==="+"?L:-L}(f),f===null))return this;var l=Math.abs(f)<=16?60*f:f;if(l===0)return this.utc(j);var y=this.clone();if(j)return y.$offset=l,y.$u=!1,y;var w=this.$u?this.toDate().getTimezoneOffset():-1*this.utcOffset();return(y=this.local().add(l+w,a)).$offset=l,y.$x.$localOffset=w,y};var k=x.format;x.format=function(f){var j=f||(this.$u?"YYYY-MM-DDTHH:mm:ss[Z]":"");return k.call(this,j)},x.valueOf=function(){var f=this.$utils().u(this.$offset)?0:this.$offset+(this.$x.$localOffset||this.$d.getTimezoneOffset());return this.$d.valueOf()-6e4*f},x.isUTC=function(){return!!this.$u},x.toISOString=function(){return this.toDate().toISOString()},x.toString=function(){return this.toDate().toUTCString()};var R=x.toDate;x.toDate=function(f){return f==="s"&&this.$offset?B(this.format("YYYY-MM-DD HH:mm:ss:SSS")).toDate():R.call(this)};var g=x.diff;x.diff=function(f,j,Y){if(f&&this.$u===f.$u)return g.call(this,f,j,Y);var l=this.local(),y=B(f).local();return g.call(l,y,j,Y)}}})})(et);var jt=et.exports;const tt=ze(jt);var st={exports:{}};(function(V,G){(function(a,P){V.exports=P()})(Oe,function(){var a={year:0,month:1,day:2,hour:3,minute:4,second:5},P={};return function(J,q,T){var B,x=function(k,R,g){g===void 0&&(g={});var f=new Date(k),j=function(Y,l){l===void 0&&(l={});var y=l.timeZoneName||"short",w=Y+"|"+y,_=P[w];return _||(_=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:Y,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:y}),P[w]=_),_}(R,g);return j.formatToParts(f)},I=function(k,R){for(var g=x(k,R),f=[],j=0;j<g.length;j+=1){var Y=g[j],l=Y.type,y=Y.value,w=a[l];w>=0&&(f[w]=parseInt(y,10))}var _=f[3],c=_===24?0:_,m=f[0]+"-"+f[1]+"-"+f[2]+" "+c+":"+f[4]+":"+f[5]+":000",$=+k;return(T.utc(m).valueOf()-($-=$%1e3))/6e4},W=q.prototype;W.tz=function(k,R){k===void 0&&(k=B);var g,f=this.utcOffset(),j=this.toDate(),Y=j.toLocaleString("en-US",{timeZone:k}),l=Math.round((j-new Date(Y))/1e3/60),y=15*-Math.round(j.getTimezoneOffset()/15)-l;if(!Number(y))g=this.utcOffset(0,R);else if(g=T(Y,{locale:this.$L}).$set("millisecond",this.$ms).utcOffset(y,!0),R){var w=g.utcOffset();g=g.add(f-w,"minute")}return g.$x.$timezone=k,g},W.offsetName=function(k){var R=this.$x.$timezone||T.tz.guess(),g=x(this.valueOf(),R,{timeZoneName:k}).find(function(f){return f.type.toLowerCase()==="timezonename"});return g&&g.value};var N=W.startOf;W.startOf=function(k,R){if(!this.$x||!this.$x.$timezone)return N.call(this,k,R);var g=T(this.format("YYYY-MM-DD HH:mm:ss:SSS"),{locale:this.$L});return N.call(g,k,R).tz(this.$x.$timezone,!0)},T.tz=function(k,R,g){var f=g&&R,j=g||R||B,Y=I(+T(),j);if(typeof k!="string")return T(k).tz(j);var l=function(c,m,$){var L=c-60*m*1e3,U=I(L,$);if(m===U)return[L,m];var M=I(L-=60*(U-m)*1e3,$);return U===M?[L,U]:[c-60*Math.min(U,M)*1e3,Math.max(U,M)]}(T.utc(k,f).valueOf(),Y,j),y=l[0],w=l[1],_=T(y).utcOffset(w);return _.$x.$timezone=j,_},T.tz.guess=function(){return Intl.DateTimeFormat().resolvedOptions().timeZone},T.tz.setDefault=function(k){B=k}}})})(st);var Ot=st.exports;const nt=ze(Ot);var At={exports:{}};(function(V,G){(function(a,P){V.exports=P(Ke())})(Oe,function(a){function P(g){return g&&typeof g=="object"&&"default"in g?g:{default:g}}var J=P(a),q="января_февраля_марта_апреля_мая_июня_июля_августа_сентября_октября_ноября_декабря".split("_"),T="январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_"),B="янв._февр._мар._апр._мая_июня_июля_авг._сент._окт._нояб._дек.".split("_"),x="янв._февр._март_апр._май_июнь_июль_авг._сент._окт._нояб._дек.".split("_"),I=/D[oD]?(\[[^[\]]*\]|\s)+MMMM?/;function W(g,f,j){var Y,l;return j==="m"?f?"минута":"минуту":g+" "+(Y=+g,l={mm:f?"минута_минуты_минут":"минуту_минуты_минут",hh:"час_часа_часов",dd:"день_дня_дней",MM:"месяц_месяца_месяцев",yy:"год_года_лет"}[j].split("_"),Y%10==1&&Y%100!=11?l[0]:Y%10>=2&&Y%10<=4&&(Y%100<10||Y%100>=20)?l[1]:l[2])}var N=function(g,f){return I.test(f)?q[g.month()]:T[g.month()]};N.s=T,N.f=q;var k=function(g,f){return I.test(f)?B[g.month()]:x[g.month()]};k.s=x,k.f=B;var R={name:"ru",weekdays:"воскресенье_понедельник_вторник_среда_четверг_пятница_суббота".split("_"),weekdaysShort:"вск_пнд_втр_срд_чтв_птн_сбт".split("_"),weekdaysMin:"вс_пн_вт_ср_чт_пт_сб".split("_"),months:N,monthsShort:k,weekStart:1,yearStart:4,formats:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY г.",LLL:"D MMMM YYYY г., H:mm",LLLL:"dddd, D MMMM YYYY г., H:mm"},relativeTime:{future:"через %s",past:"%s назад",s:"несколько секунд",m:W,mm:W,h:"час",hh:W,d:"день",dd:W,M:"месяц",MM:W,y:"год",yy:W},ordinal:function(g){return g},meridiem:function(g){return g<4?"ночи":g<12?"утра":g<17?"дня":"вечера"}};return J.default.locale(R,null,!0),R})})(At);const Ht={class:"dynamics-chart-container"},Yt={class:"text-sm font-semibold mb-2 flex items-center justify-between"},Lt={class:"text-xs opacity-70"},Bt={class:"chart-svg-container"},zt={class:"y-axis-labels"},Ft={class:"y-label"},It={class:"y-label"},Nt={class:"y-label"},Ut={class:"chart-svg-wrapper"},Wt=["viewBox"],Rt=["y1","y2"],Et=["y"],Pt=["y1","y2"],Zt=["points"],Vt=["cx","cy"],qt={key:0,class:"mt-4"},Gt={class:"dynamics-analysis"},Jt={class:"analysis-text"},Xt={key:0,class:"insight-box"},Kt={class:"insight-text"},Qt={key:1,class:"mt-3 text-xs opacity-80 leading-relaxed"},es={class:"pagination-dots"},ts=["onClick"],Ce=300,Te=80,Se=6,ss=Be({__name:"DynamicsChart",props:{dynamics:{},userAge:{},userGender:{}},setup(V){const G=V,a=ne(0),P=ne(0),J=ne(0),q=ne("slide-left"),T=b(()=>G.dynamics[a.value]||{metric:"",values:[],interpretation:""}),B=b(()=>T.value.values||[]),x=b(()=>{if(!G.dynamics||G.dynamics.length===0)return{min:0,max:10,labels:[10,5,0]};const l=[];if(G.dynamics.forEach(c=>{Array.isArray(c.values)&&l.push(...c.values)}),l.length===0)return{min:0,max:10,labels:[10,5,0]};const y=Math.floor(Math.min(...l)),w=Math.ceil(Math.max(...l)),_=[w,Math.round((w+y)/2),y];return{min:y,max:w,labels:_}}),I=b(()=>{var c;const l=T.value.metric;if(!G.userAge||!G.userGender)return null;const w=(c={Персонажи:{"18-24":{male:6.5,female:7},"25-34":{male:6,female:6.5},"35-44":{male:5.5,female:6},"45+":{male:5,female:5.5}},Эмоции:{"18-24":{male:6,female:7},"25-34":{male:5.5,female:6.5},"35-44":{male:5,female:6},"45+":{male:4.5,female:5.5}},Действия:{"18-24":{male:7,female:6.5},"25-34":{male:6.5,female:6},"35-44":{male:6,female:5.5},"45+":{male:5.5,female:5}},Сцены:{"18-24":{male:6.5,female:6.5},"25-34":{male:6,female:6},"35-44":{male:5.5,female:5.5},"45+":{male:5,female:5}}}[l])==null?void 0:c[G.userAge];if(!w)return null;const _=w[G.userGender];return _===void 0?null:_}),W=b(()=>{const l=I.value;if(l===null)return null;const{min:y,max:w}=x.value,_=Te-Se*2,c=(l-y)/(w-y);return Se+_-c*_}),N=b(()=>{const l=B.value;if(l.length===0)return[];const{min:y,max:w}=x.value,_=Ce-Se*2,c=Te-Se*2,m=l.length>1?_/(l.length-1):0;return l.map(($,L)=>{const U=($-y)/(w-y);return{x:Se+L*m,y:Se+c-U*c}})}),k=b(()=>N.value.map(l=>`${l.x},${l.y}`).join(" "));function R(l){P.value=l.touches[0].clientX}function g(l){J.value=l.touches[0].clientX}function f(){const l=P.value-J.value;Math.abs(l)>50&&(l>0&&a.value<G.dynamics.length-1?(q.value="slide-left",a.value++,Y()):l<0&&a.value>0&&(q.value="slide-right",a.value--,Y())),P.value=0,J.value=0}function j(l){l!==a.value&&(q.value=l>a.value?"slide-left":"slide-right",a.value=l,Y())}function Y(){window.triggerHaptic&&window.triggerHaptic("light")}return(l,y)=>(i(),r("div",Ht,[s("div",{class:"chart-wrapper",onTouchstart:R,onTouchmove:g,onTouchend:f},[je(gt,{name:q.value,mode:"out-in"},{default:_t(()=>[(i(),r("div",{key:a.value,class:"chart-content"},[s("div",Yt,[s("span",null,H(T.value.category||T.value.metric),1),s("span",Lt,H(B.value[B.value.length-1]),1)]),s("div",Bt,[s("div",zt,[s("span",Ft,H(x.value.labels[0]),1),s("span",It,H(x.value.labels[1]),1),s("span",Nt,H(x.value.labels[2]),1)]),s("div",Ut,[(i(),r("svg",{viewBox:`0 0 ${Ce} ${Te}`,class:"chart-svg",preserveAspectRatio:"xMidYMid meet"},[(i(),r(ee,null,re(3,w=>s("line",{key:`grid-${w}`,x1:0,x2:Ce,y1:Te/2*(w-1),y2:Te/2*(w-1),stroke:"white","stroke-opacity":"0.15","stroke-width":"1"},null,8,Rt)),64)),W.value!==null?(i(),r("rect",{key:0,x:0,y:W.value-8,width:Ce,height:16,fill:"yellow",opacity:"0.15"},null,8,Et)):E("",!0),W.value!==null?(i(),r("line",{key:1,x1:0,x2:Ce,y1:W.value,y2:W.value,stroke:"yellow","stroke-opacity":"0.6","stroke-width":"1.5","stroke-dasharray":"4,3"},null,8,Pt)):E("",!0),s("polyline",{points:k.value,fill:"none",stroke:"white","stroke-width":"2.5","stroke-linejoin":"round","stroke-linecap":"round"},null,8,Zt),(i(!0),r(ee,null,re(N.value,(w,_)=>(i(),r("circle",{key:`point-${_}`,cx:w.x,cy:w.y,r:"4",fill:"white","vector-effect":"non-scaling-stroke"},null,8,Vt))),128))],8,Wt))])]),T.value.analysis?(i(),r("div",qt,[s("div",Gt,[s("p",Jt,H(T.value.analysis),1),T.value.insight?(i(),r("div",Xt,[y[0]||(y[0]=s("span",{class:"insight-icon"},"💡",-1)),s("p",Kt,H(T.value.insight),1)])):E("",!0)])])):T.value.interpretation?(i(),r("div",Qt,H(T.value.interpretation),1)):E("",!0)]))]),_:1},8,["name"])],32),s("div",es,[(i(!0),r(ee,null,re(V.dynamics,(w,_)=>(i(),r("button",{key:`dot-${_}`,class:pe(["dot",{active:_===a.value}]),onClick:c=>j(_)},null,10,ts))),128))])]))}}),Je=Fe(ss,[["__scopeId","data-v-ac484404"]]),ns=[{keys:["вода","море","река","волна","дожд","океан"],emoji:"🌊"},{keys:["лет","полет","полетать","летать","небо","птиц","самолет"],emoji:"🕊️"},{keys:["погон","убег","догон","преслед"],emoji:"🏃‍♂️"},{keys:["экзам","контрол","тест","урок","школ","учеб","универ"],emoji:"📝"},{keys:["деньг","кошелек","кошель","кошелёк","банк","кредит"],emoji:"💰"},{keys:["любов","поцел","роман","пар","серд"],emoji:"❤️"},{keys:["дом","квартир","комнат","двор","жиль"],emoji:"🏠"},{keys:["работ","офис","началь","коллег"],emoji:"💼"},{keys:["школ","класс","урок"],emoji:"🏫"},{keys:["кот","кошка"],emoji:"🐱"},{keys:["собак","пёс","пес"],emoji:"🐶"},{keys:["зуб","зубы"],emoji:"🦷"},{keys:["темнот","ноч","тьма"],emoji:"🌑"},{keys:["смерт","похорон","кладбищ"],emoji:"🕯️"},{keys:["рожд","младен","ребен","малыш","дет"],emoji:"👶"},{keys:["лес","дерев","парк","природ"],emoji:"🌲"},{keys:["огонь","пожар","жар"],emoji:"🔥"},{keys:["зме","дракон"],emoji:"🐍"},{keys:["путешеств","дорог","путь","троп"],emoji:"🧭"}];function is(V){try{const G=String(V||"").toLowerCase();for(const a of ns)if(a.keys.some(P=>G.includes(P)))return a.emoji;return"💤"}catch{return"💤"}}const rs={key:0,class:"flex items-center gap-3 py-1 min-h-[2.5rem]"},os={class:"text-2xl shrink-0"},as={class:"flex-1 min-w-0"},ls={class:"truncate font-semibold leading-tight"},cs={class:"text-xs opacity-80 leading-tight mt-1"},us={key:1,class:"mt-4 space-y-4 text-sm fade-seq is-open"},ds={key:0,class:"space-y-1"},fs={class:"text-2xl font-semibold leading-tight"},ms={class:"text-sm opacity-80"},hs={key:1,class:"flex flex-wrap gap-2"},ps={key:0,class:"space-y-3"},vs={class:"text-white/90 leading-snug space-y-4"},ys={key:0,class:"text-base opacity-90 leading-relaxed pb-3 border-b border-white/10"},gs={class:"flex items-baseline gap-2"},_s={class:"font-semibold text-lg"},xs={class:"text-sm opacity-70 bg-white/15 px-2 py-0.5 rounded-full"},bs={class:"text-base opacity-90 leading-relaxed"},ws={class:"text-base opacity-75 italic leading-relaxed bg-white/5 rounded-lg px-3 py-2"},ks={key:1,class:"space-y-3"},$s={class:"text-white/90 leading-snug"},Ms={key:2,class:"space-y-3"},Ss={class:"text-white/90 leading-snug space-y-4"},Ds={key:0,class:"text-base opacity-90 leading-relaxed"},Cs={key:1,class:"text-base opacity-90 leading-relaxed"},Ts={key:2,class:"text-base opacity-90 leading-relaxed"},js={key:3,class:"bg-white/10 rounded-lg p-4 space-y-3 mt-4"},Os={class:"font-semibold text-lg opacity-95 flex items-center gap-2"},As={class:"text-base opacity-90 leading-relaxed"},Hs={key:0,class:"text-base opacity-75 italic leading-relaxed"},Ys={class:"rounded-lg bg-white/10"},Ls={class:"px-3 pb-3 text-white/90 leading-snug space-y-2"},Bs=["innerHTML"],zs={key:0,class:"rounded-lg bg-white/10"},Fs={class:"px-3 pb-3"},Is={class:"flex flex-wrap gap-2"},Ns={key:1,class:"rounded-lg bg-white/10"},Us={class:"px-3 pb-3 text-white/90 leading-snug"},Ws={key:2,class:"rounded-lg bg-white/10"},Rs={class:"px-3 pb-3 text-white/90 leading-snug"},Es={class:"list-decimal pl-5 space-y-2"},Ps={key:3,class:"rounded-lg bg-white/10"},Zs={class:"px-3 pb-3 text-white/90 leading-snug"},Vs={class:"list-decimal pl-5 space-y-3"},qs={key:0},Gs={class:"font-semibold mb-1"},Js={class:"opacity-90"},Xs={key:0,class:"opacity-80 mt-1 italic"},Ks={key:1},Qs={key:0,class:"rounded-lg bg-white/10"},en={class:"px-3 pb-3 text-white/90 leading-snug"},tn={class:"list-decimal pl-5 space-y-2"},sn={key:1,class:"rounded-lg bg-white/10"},nn={class:"px-3 pb-3 text-white/90 leading-snug"},rn={class:"list-decimal pl-5 space-y-3"},on={key:0},an={class:"font-semibold mb-1"},ln={class:"opacity-90"},cn={key:0,class:"opacity-80 mt-1 italic"},un={key:1},dn={class:"rounded-lg bg-white/10 border-l-4 border-pink-400"},fn={class:"px-3 pb-3 text-white/90 leading-relaxed"},mn={class:"text-base opacity-90"},hn={class:"space-y-2"},pn={class:"text-xl font-semibold px-3 py-2"},vn={class:"px-3 pb-3 text-white/90 leading-snug space-y-2"},yn=["innerHTML"],gn={key:0,class:"space-y-3"},_n={class:"flex justify-between text-base opacity-80"},xn={class:"relative h-2 w-full bg-white/10 rounded overflow-hidden"},bn={class:"pt-2 text-sm opacity-80 flex flex-wrap items-center gap-4"},wn={class:"inline-flex items-center gap-2"},kn={class:"mt-4 flex gap-2"},$n={key:4,class:"mt-3 text-xs bg-black/20 rounded-lg p-2 font-mono whitespace-pre-wrap break-words"},Mn={class:"mt-2 flex justify-end"},Sn={key:0,class:"space-y-3"},Dn={class:"grid grid-cols-2 gap-2"},Cn=["onClick"],Tn={class:"flex justify-end gap-2 pt-2"},jn=["disabled"],On={key:1,class:"space-y-3"},An={class:"grid grid-cols-2 gap-2"},Hn={class:"flex justify-end gap-2 pt-2"},Yn=["disabled"],Ln=48,Bn=Be({__name:"DreamCard",props:{dream:{},active:{type:Boolean},overlayMode:{type:Boolean}},emits:["toggle","open"],setup(V,{emit:G}){ae.extend(Tt),ae.locale("ru"),ae.extend(tt),ae.extend(nt);const a=V,P=G,J=ne(null),q=()=>{const e=(()=>{var t;try{return Math.round(((t=J.value)==null?void 0:t.getBoundingClientRect().top)??0)}catch{return 0}})();P("open",{y:e})},T=()=>{a.overlayMode||(q(),window.triggerHaptic&&window.triggerHaptic("light"))},B=xt(),x=bt(),I=b(()=>{var e;return!!((e=a.dream)!=null&&e.is_deep_analysis)}),W=b(()=>is(c.value)),N=b({get:()=>{var e,t,n;return((e=a.dream)==null?void 0:e.user_feedback)??((n=(t=a.dream)==null?void 0:t.deep_source)==null?void 0:n.user_feedback)??0},set:e=>{a.dream&&(a.dream.user_feedback=e,a.dream.deep_source||(a.dream.deep_source={}),a.dream.deep_source.user_feedback=e)}}),k={like:!1,dislike:!1,delete:!1},R=async e=>{if(k.like||k.dislike)return;const t=e===1?N.value===1?0:1:N.value===2?0:2,n=N.value;N.value=t;try{window.triggerHaptic&&window.triggerHaptic("medium"),e===1?k.like=!0:k.dislike=!0,await Re.postAnalysisFeedback(a.dream.id,t),t===0?x.info("Оценка снята"):t===1?x.success("Добавлено: нравится"):t===2&&x.success("Добавлено: не нравится")}catch(u){N.value=n,console.error("Feedback error",u),x.error("Не удалось сохранить оценку")}finally{k.like=k.dislike=!1}},g=()=>R(1),f=()=>R(2),j=async()=>{var n;if(k.delete)return;const e=(n=window.Telegram)==null?void 0:n.WebApp;if(await new Promise(u=>{e!=null&&e.showPopup?e.showPopup({title:"Удалить запись?",message:"Действие необратимо",buttons:[{id:"yes",type:"destructive",text:"Удалить"},{id:"no",type:"cancel",text:"Отмена"}]},S=>u(S==="yes")):u(window.confirm("Удалить запись?"))}))try{k.delete=!0,window.triggerHaptic&&window.triggerHaptic("heavy"),await Re.deleteAnalysis(a.dream.id);const u=B.history.findIndex(S=>S.id===a.dream.id);u>-1&&B.history.splice(u,1),B.fetchProfile(),x.success("Запись удалена")}catch(u){console.error("Delete error",u),x.error("Не удалось удалить запись")}finally{k.delete=!1}},Y=new Set(["и","в","во","не","что","он","на","я","с","со","как","а","то","все","она","так","его","но","да","ты","к","у","же","вы","за","бы","по","ее","мне","было","вот","от","меня","еще","нет","о","из","ему","теперь","когда","даже","ну","вдруг","ли","если","уже","или","ни","быть","был","него","до","вас","нибудь","опять","уж","вам","ведь","там","потом","себя","ничего","ей","может","они","тут","где","есть","надо","ней","для","мы","тебя","их","чем","была","сам","чтоб","без","будто","чего","раз","тоже","себе","под","будет","ж","тогда","кто","этот","того","потому","этого","какой","совсем","ним","здесь","этом","один","почти","мой","тем","чтобы","нее","кажется","сейчас","были","куда","зачем","всех","никогда","можно","при","наконец","два","об","другой","хоть","после","над","больше","тот","через","эти","нас","про","всего","них","какая","много","разве","три","эту","моя","впрочем","хорошо","свою","этой","перед","иногда","лучше","чуть","том","нельзя","такой","им","более","всегда","конечно","всю","между"]);function l(e){return e.replace(/\s+/g," ").trim().split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function y(e){if(!e)return"";const t=String(e).split(/[.!?\n]/)[0],u=t.toLowerCase().replace(/[^\p{L}\p{N}\s-]/gu,"").split(/\s+/).filter(S=>S&&!Y.has(S)&&S.length>3).slice(0,3);return u.length===0?t.slice(0,40):l(u.join(" "))}function w(e){if(!e)return"";let t=String(e).toLowerCase().replace(/["'«»]/g,"").trim();t=t.replace(/^(приснилось|снилось|сон о|сон про|сон|мне снится|мне приснилось)\s+/i,""),t=t.replace(/\s+/g," ").trim();const n=t.split(" ").filter(Boolean).slice(0,3);return n.length?n.join(" "):""}function _(e){if(!e)return"";const t=String(e).toLowerCase();return t.charAt(0).toUpperCase()+t.slice(1)}const c=b(()=>{var O,o,D,A,Q;const e=w((o=(O=a.dream)==null?void 0:O.deep_source)==null?void 0:o.title);if(e)return _(e);const t=(((A=(D=a.dream)==null?void 0:D.deep_source)==null?void 0:A.tags)||[]).filter(Boolean),n=fe=>{var me;let le=String(fe||"").trim();return le=((me=le.split(/[\\/,(;:—–-]/)[0])==null?void 0:me.trim())||"",le?le.charAt(0).toUpperCase()+le.slice(1).toLowerCase():""},u=t.map(n).filter(Boolean);if(u.length){const fe=u.slice(0,2).join(" и ");return _(fe||"Без названия")}const S=w(y((Q=a.dream)==null?void 0:Q.dream_text));return _(S||"Без названия")}),m=b(()=>{var n,u;const e=(u=(n=a.dream)==null?void 0:n.deep_source)==null?void 0:u.tags;if(!Array.isArray(e))return[];const t=S=>{var o;let O=String(S||"").trim();return O=((o=O.split(/[\\/,(;:—–-]/)[0])==null?void 0:o.trim())||"",O?O.charAt(0).toUpperCase()+O.slice(1).toLowerCase():""};return e.map(t).filter(Boolean).slice(0,5)});function $(e){return String(e||"").replace(/^```[\s\S]*?\n/,"").replace(/```$/,"").replace(/\(\s*\d+\s*\)/g,"").replace(/\s\[\s*\d+\s*\]/g,"").replace(/[\u00B9\u00B2\u00B3\u2070-\u2079]/g,"")}ne("context");const L=b(()=>{var e;return $(((e=a.dream)==null?void 0:e.analysis)||"")}),U=b(()=>{var e,t;return((t=(e=a.dream)==null?void 0:e.deep_source)==null?void 0:t.overallContext)||{}});b(()=>{const e=U.value;return!!(e!=null&&e.narrative||e!=null&&e.psychologicalFunction||e!=null&&e.emotionalJourney)});const M=b(()=>{var e,t;return((t=(e=a.dream)==null?void 0:e.deep_source)==null?void 0:t.symbolsIntro)||""}),ve=b(()=>{var t,n;const e=(n=(t=a.dream)==null?void 0:t.deep_source)==null?void 0:n.recurringSymbols;return Array.isArray(e)?e:[]}),xe=b(()=>ve.value.filter(e=>e.frequency>=2)),C=b(()=>xe.value.length>0),v=b(()=>{var t,n;const e=(n=(t=a.dream)==null?void 0:t.deep_source)==null?void 0:n.dynamicsContext;return Array.isArray(e)?e:[]}),d=b(()=>v.value.length>0),p=b(()=>{var e,t;return((t=(e=a.dream)==null?void 0:e.deep_source)==null?void 0:t.conclusion)||{}}),h=b(()=>{const e=p.value;return!!(e!=null&&e.periodThemes||e!=null&&e.dreamFunctionsAnalysis||e!=null&&e.psychologicalSupport||e!=null&&e.integrationExercise)}),z=b(()=>{var t,n;const e=(n=(t=a.dream)==null?void 0:t.deep_source)==null?void 0:n.dynamics;return Array.isArray(e)&&e.length>0?e:[]});b(()=>z.value.length>0);const F=b(()=>{var t,n;const e=(n=(t=a.dream)==null?void 0:t.deep_source)==null?void 0:n.conclusions;return Array.isArray(e)&&e.length>0?e:[]});b(()=>F.value.length>0);const Z=b(()=>{var o,D;const e=(D=(o=a.dream)==null?void 0:o.deep_source)==null?void 0:D.recommendations;if(Array.isArray(e)&&e.length>0&&typeof e[0]=="object")return e;if(Array.isArray(e)&&e.length>0)return e.map((A,Q)=>({title:`Рекомендация ${Q+1}`,description:String(A),rationale:""}));const t=ce.value;if(t.length===0)return[];const n=[0,0,0,0];for(const A of t)for(let Q=0;Q<4;Q++)n[Q]+=A[Q];const u=Math.max(1,t.length);for(let A=0;A<4;A++)n[A]=Math.round(n[A]/u);const S=[["Персонажи","Обрати внимание на отношения и роли; практикуй честную коммуникацию."],["Эмоции","Добавь ежедневную регуляцию эмоций (дыхание, дневник, прогулка)."],["Действия","Определи 1 маленький шаг на неделю и заверши его."],["Сцены","Проверь границы и режим: место/время, где тебе спокойнее."]],O=n.map((A,Q)=>({i:Q,v:A})).sort((A,Q)=>Q.v-A.v).map(A=>A.i);return[{title:S[O[0]][0],description:S[O[0]][1],rationale:""},{title:S[O[1]][0],description:S[O[1]][1],rationale:""}]});b(()=>Z.value.length>0);function X(e,t){var n;try{let u=e;const S=Array.from(new Set((t||[]).filter(Boolean))).sort((O,o)=>o.length-O.length);for(const O of S){const o=(n=String(O).split(/[\\/,(;:—–-]/)[0])==null?void 0:n.trim();if(!o)continue;const D=new RegExp(`(\b${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\b)`,"gi");u=u.replace(D,'<mark class="bg-white/20 px-1 rounded">$1</mark>')}return u.replace(/\n\n+/g,'</p><p class="mt-2">').replace(/\n/g,"<br>").replace(/^(.+)$/,"<p>$1")}catch{return e}}const se=b(()=>{var e,t;return X(L.value,((t=(e=a.dream)==null?void 0:e.deep_source)==null?void 0:t.tags)||[])});function te(e){try{return new Date(e).getTime()||0}catch{return 0}}const oe=b(()=>(B.history||[]).filter(e=>{var t;return!e.is_deep_analysis&&((t=e==null?void 0:e.deep_source)==null?void 0:t.hvdc)&&(e==null?void 0:e.created_at)}).sort((e,t)=>te(e.created_at)>te(t.created_at)?-1:1)),ce=b(()=>{var u;const e=te(((u=a.dream)==null?void 0:u.created_at)||""),t=oe.value.filter(S=>!I.value||(e?te(S.created_at)<=e:!0)).slice(0,5).reverse(),n=["characters","emotions","actions","settings"];return t.map(S=>n.map(O=>{var o,D;return Number(((D=(o=S.deep_source.hvdc)==null?void 0:o.distribution)==null?void 0:D[O])||0)}))}),ue=b(()=>ce.value.length),be=b(()=>ue.value>=2),ye=b(()=>Math.max(60,(ue.value-1)*28+8));function ie(e){const t=e.length,n=ye.value,u=Ln,S=t>1?(n-8)/(t-1):0,O=[];for(let D=0;D<t;D++){const A=D*S,Q=u-Math.round(e[D]/100*u);O.push({x:A,y:Q})}return{str:O.map(D=>`${D.x},${D.y}`).join(" "),pts:O}}b(()=>{const e=[{key:"characters",label:"Персонажи",idx:0,opacity:.95},{key:"emotions",label:"Эмоции",idx:1,opacity:.75},{key:"actions",label:"Действия",idx:2,opacity:.55},{key:"settings",label:"Сцены",idx:3,opacity:.35}],t=[],n=ce.value;for(const u of e){const S=n.map(D=>D[u.idx]),{str:O,pts:o}=ie(S);t.push({key:u.key,label:u.label,values:S,points:O,pointList:o,opacity:u.opacity})}return t});const de=b(()=>{if(!be.value)return[];if(d.value)return v.value.map(n=>({metric:n.category||n.metric,values:n.values||[],interpretation:n.analysis||n.interpretation||"",insight:n.insight||""}));const e=[{key:"characters",label:"Персонажи",idx:0},{key:"emotions",label:"Эмоции",idx:1},{key:"actions",label:"Действия",idx:2},{key:"settings",label:"Сцены",idx:3}],t=ce.value;return e.map(n=>({metric:n.label,values:t.map(u=>u[n.idx]),interpretation:`Динамика "${n.label}" по последним ${ue.value} снам`}))});function ke(e){const n=e.split(/\n+/).map(u=>u.trim()).filter(Boolean).filter(u=>/^\d+\./.test(u)).map(u=>u.replace(/^\d+\.\s*/,"")).slice(0,3);return n.length?n:e.split(/[.!?]\s+/).map(u=>u.trim()).filter(Boolean).slice(0,3)}const ge=b(()=>ke(L.value));function it(e){try{const t=String(e||"").toLowerCase(),n=$e=>$e.reduce((We,yt)=>We+(t.includes(yt)?1:0),0),u=["страх","ужас","паник","тревог","стыд","гнев","плак","слез","кошмар","тоска","грусть"],S=["экзам","выступл","собесед","защит","проект","подготов","завтра","ожидан","волнен","поездк","путешеств","нов","интервью"],O=["вчера","сегодня","работ","школ","универ","дом","улиц","друг","родител","коллег","город"],o=n(u),D=n(S),A=n(O);let Q=o>0?Math.min(1,o/3):0,fe=D>0?Math.min(1,D/3):0,le=A>0?Math.min(1,.5+A/5):0;Q===0&&fe===0&&le===0&&(le=.6,Q=.2,fe=.2);const me={schema:"dream_type_v1",scores:{memory:+le.toFixed(2),emotion:+Q.toFixed(2),anticipation:+fe.toFixed(2)}},K=[["memory",me.scores.memory],["emotion",me.scores.emotion],["anticipation",me.scores.anticipation]];K.sort(($e,We)=>We[1]-$e[1]);const _e=+Math.max(0,K[0][1]-K[1][1]).toFixed(2);return{...me,dominant:K[0][0],confidence:_e}}catch{return null}}const rt=b(()=>{var e,t,n;return((t=(e=a.dream)==null?void 0:e.deep_source)==null?void 0:t.dream_type)||it((n=a.dream)==null?void 0:n.dream_text)||null});function ot(){const e=rt.value;if(!e||!e.dominant)return['<div class="space-y-2">','<div class="font-semibold">🛠 Небольшая работа со сном</div>','<ol class="list-decimal pl-5 space-y-1">','<li><span class="font-semibold">Заметь:</span> Какие 2–3 образа из сна самые сильные? Запиши их коротко.</li>','<li><span class="font-semibold">Шаг:</span> Выбери один маленький шаг в реальности, который поддержит тебя по теме сна.</li>',"</ol>","</div>"].join("");const t=String(e.dominant).toLowerCase();return t==="memory"?['<div class="space-y-2">','<div class="font-semibold">🌙 Сон-Память</div>','<p class="opacity-90">Переработка недавнего опыта, соединение нового с прошлым.</p>','<ol class="list-decimal pl-5 space-y-1">','<li><span class="font-semibold">Отрази:</span> Вспомни, что происходило последние 1–2 дня. Какие события могли попасть в сон?</li>','<li><span class="font-semibold">Соедини:</span> Отметь, какие элементы сна перекликаются с реальностью — это завершает «архивацию» опыта.</li>',"</ol>","</div>"].join(""):t==="emotion"?['<div class="space-y-2">','<div class="font-semibold">⚡️ Сон-Эмоция</div>','<p class="opacity-90">Проживание и нейтрализация сильных чувств.</p>','<ol class="list-decimal pl-5 space-y-1">','<li><span class="font-semibold">Почувствуй:</span> Определи, какая эмоция была самой сильной во сне. Где она чувствуется в теле сейчас?</li>','<li><span class="font-semibold">Услышь:</span> Представь, что главный персонаж сна говорит тебе что-то. Что он хочет, чтобы ты понял?</li>',"</ol>","</div>"].join(""):['<div class="space-y-2">','<div class="font-semibold">🔮 Сон-Предвосхищение</div>','<p class="opacity-90">Тренировка будущих ситуаций и реакций.</p>','<ol class="list-decimal pl-5 space-y-1">','<li><span class="font-semibold">Представь:</span> Как бы ты хотел повести себя, если бы это произошло в реальности?</li>','<li><span class="font-semibold">Расшифруй:</span> Какой символ кажется ключевым? Что он может говорить о твоих страхах или намерениях?</li>',"</ol>","</div>"].join("")}const at=b(()=>{var fe,le,me;const e=$(((fe=a.dream)==null?void 0:fe.analysis)||"");if(!e)return[];const t={arch:{key:"arch",title:"Архетипическая история",text:""},func:{key:"func",title:"Возможная функция сна",text:""},freud:{key:"freud",title:"По Фрейду",text:""},jung:{key:"jung",title:"По Юнгу",text:""}},n=[],u=/\*\*([^*]+)\*\*/g;let S;for(;S=u.exec(e);)n.push({title:S[1].trim(),start:S.index,end:S.index+S[0].length});const O=((le=n[0])==null?void 0:le.start)??e.length;t.arch.text=e.slice(0,O).trim();for(let K=0;K<n.length;K++){const _e=n[K].title.toLowerCase(),$e=e.slice(n[K].end,((me=n[K+1])==null?void 0:me.start)??e.length).trim();_e.includes("возможная функция")?t.func.text=$e:_e.includes("по фрейду")?t.freud.text=$e:_e.includes("по юнгу")&&(t.jung.text=$e)}const o=K=>K.replace(/\n\n+/g,'</p><p class="mt-2">').replace(/\n/g,"<br>").replace(/^(.+)$/,"<p>$1"),D=Object.values(t).map(K=>({...K,html:o(K.text||"")}));D.some(K=>K.key==="func")||D.push({key:"func",title:"Возможная функция сна",text:"",html:""});const A=D.findIndex(K=>K.key==="arch");A!==-1&&D.splice(A+1,0,{key:"hvdc",title:"Контент анализ",text:"",html:""});const Q=ot();if(Q){const K=D.findIndex(_e=>_e.key==="func");if(K!==-1){const _e=['<div class="mt-3 pt-2 border-t border-white/10 space-y-1">','<div class="font-semibold">Функциональное упражнение</div>',Q,"</div>"].join("");D[K].html=(D[K].html||"")+_e}}return D});wt({arch:!0,hvdc:!1,func:!1,freud:!1,jung:!1,symbols:!0,dynamics:!0,conclusion:!0});const Ze=b(()=>{try{return new URLSearchParams(window.location.search).get("debug")==="1"||localStorage.getItem("da_debug")==="1"}catch{return!1}});function lt(){var e,t,n,u,S;try{const O=JSON.stringify(Ie.value,null,2);(e=navigator.clipboard)==null||e.writeText(O),(t=x==null?void 0:x.success)==null||t.call(x,"Скопировано")}catch{try{(S=(u=(n=window.Telegram)==null?void 0:n.WebApp)==null?void 0:u.showPopup)==null||S.call(u,{title:"Debug",message:"Скопируйте из блока ниже вручную",buttons:[{id:"ok",type:"default",text:"OK"}]})}catch{}}}function ct(e){var n;let t=String(e||"").trim();return t=((n=t.split(/[\\/,(;:—–-]/)[0])==null?void 0:n.trim())||"",t?t.charAt(0).toUpperCase()+t.slice(1).toLowerCase():""}const Ie=b(()=>{var n,u,S,O;if(!Ze.value)return null;const e=a.dream||{},t=Array.isArray((n=e==null?void 0:e.deep_source)==null?void 0:n.tags)?e.deep_source.tags:[];return{id:e.id,created_at:e.created_at,is_deep_analysis:!!e.is_deep_analysis,title_raw:((u=e==null?void 0:e.deep_source)==null?void 0:u.title)||null,tags_raw:t,tags_norm:t.map(ct),dream_type:((S=e==null?void 0:e.deep_source)==null?void 0:S.dream_type)||null,hvdc_present:!!((O=e==null?void 0:e.deep_source)!=null&&O.hvdc)}}),Ne=ne(!1),Ve=ne(1),ut=["0-20","20-30","30-40","40-50","50+"],Ae=ne(""),Me=ne("");function Ue(){Ne.value=!1}async function dt(){try{await Re.setDemographics(Ae.value,Me.value);try{await B.fetchProfile()}catch{}x.success("Готово! Дальнейшие анализы будут учитывать эти данные"),Ne.value=!1}catch{x.error("Не удалось сохранить")}}b(()=>{const e=B.profile||{};return!!(e.age_range&&e.gender)});const De=b(()=>{var e,t;return((t=(e=a.dream)==null?void 0:e.deep_source)==null?void 0:t.hvdc)||null}),ft=b(()=>{var S,O,o;const e=[{key:"characters",label:"Персонажи"},{key:"emotions",label:"Эмоции"},{key:"actions",label:"Действия"},{key:"settings",label:"Сцены"}],t=((S=De.value)==null?void 0:S.distribution)||{},n=((O=De.value)==null?void 0:O.norm)||null,u=((o=De.value)==null?void 0:o.comparison)||null;return e.map(D=>({key:D.key,label:D.label,value:Number(t[D.key]??0),norm:n?Number(n[D.key]??0):null,delta:u?Number(u[D.key]??0):null}))}),mt=b(()=>{var o;const e=((o=De.value)==null?void 0:o.norm_group)||null;if(!e)return"общая статистика";const t=String(e.gender||"").toLowerCase(),n=t==="male"?"муж.":t==="female"?"жен.":"",u=e.age_range||"",S=u?`${u} лет`:"",O=[n,S].filter(Boolean).join(" ");return O?`общая статистика* для ${O}`:"общая статистика"});function He(e,t){const n=Math.abs(e)%100,u=n%10;return n>10&&n<20?t[2]:u>1&&u<5?t[1]:u===1?t[0]:t[2]}const ht=b(()=>{if(!a.dream.created_at)return"";try{const e=Intl.DateTimeFormat().resolvedOptions().timeZone||ae.tz.guess(),t=ae.utc(a.dream.created_at).tz(e).startOf("day"),u=ae().tz(e).startOf("day").diff(t,"day");if(u===0)return"сегодня";if(u===1)return"вчера";if(u<7){const A=He(u,["день","дня","дней"]);return`${u} ${A} назад`}const S=Math.floor(u/7);if(u<30){const A=He(S,["неделя","недели","недель"]);return`${S} ${A} назад`}const O=Math.floor(u/30);if(u<365){const A=He(O,["месяц","месяца","месяцев"]);return`${O} ${A} назад`}const o=Math.floor(u/365),D=He(o,["год","года","лет"]);return`${o} ${D} назад`}catch{return a.dream.created_at}}),pt=b(()=>{var t;const e=(t=a.dream)==null?void 0:t.created_at;if(!e)return"";try{const n=Intl.DateTimeFormat().resolvedOptions().timeZone||ae.tz.guess();return ae.utc(e).tz(n).format("D MMMM YYYY, HH:mm")}catch{return e}}),vt=b(()=>{var e;return(e=a.dream)!=null&&e.is_deep_analysis?"from-[#9C41FF] to-[#C03AFF]":"from-[#4A58FF] to-[#5664FF]"});return(e,t)=>{var n,u,S,O;return i(),r("article",{ref_key:"rootRef",ref:J,class:pe(["rounded-xl bg-gradient-to-br text-white px-8 md:px-16 transition-all overflow-hidden py-4",[vt.value,V.overlayMode?"":"cursor-pointer min-h-[4.5rem]"]]),onClick:T},[V.overlayMode?E("",!0):(i(),r("div",rs,[s("div",os,H(W.value),1),s("div",as,[s("div",ls,H(c.value),1),s("div",cs,H(ht.value),1)]),s("button",{class:"shrink-0 w-6 h-6 opacity-80 hover:opacity-100 flex items-center justify-center",onClick:t[0]||(t[0]=he(o=>q(),["stop"])),"aria-label":"Открыть"},[...t[7]||(t[7]=[s("span",{class:"text-lg font-semibold leading-none select-none"},">",-1)])])])),V.active?(i(),r("div",us,[V.overlayMode?(i(),r("div",ds,[s("h2",fs,H(c.value),1),s("div",ms,H(pt.value),1)])):E("",!0),m.value.length&&!I.value?(i(),r("div",hs,[(i(!0),r(ee,null,re(m.value,o=>(i(),r("span",{key:o,class:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-white/15 text-white"},H(o),1))),128))])):E("",!0),I.value?(i(),r(ee,{key:2},[C.value?(i(),r("div",ps,[t[9]||(t[9]=s("h3",{class:"text-xl font-semibold"},"Повторяющиеся символы",-1)),s("div",vs,[M.value?(i(),r("p",ys,H(M.value),1)):E("",!0),(i(!0),r(ee,null,re(xe.value,(o,D)=>(i(),r("div",{key:`symbol-${D}`,class:"space-y-2"},[s("div",gs,[s("h4",_s,H(o.symbol),1),s("span",xs,"×"+H(o.frequency),1)]),s("p",bs,H(o.description),1),s("div",ws,[t[8]||(t[8]=s("span",{class:"font-medium"},"В ваших снах:",-1)),we(" "+H(o.userContext),1)])]))),128))])])):E("",!0),d.value?(i(),r("div",ks,[t[10]||(t[10]=s("h3",{class:"text-xl font-semibold"},"Динамика контекста",-1)),s("div",$s,[je(Je,{dynamics:v.value,userAge:(n=Ye(B).profile)==null?void 0:n.age_range,userGender:(u=Ye(B).profile)==null?void 0:u.gender},null,8,["dynamics","userAge","userGender"])])])):E("",!0),h.value?(i(),r("div",Ms,[t[12]||(t[12]=s("h3",{class:"text-xl font-semibold"},"Заключение",-1)),s("div",Ss,[p.value.periodThemes?(i(),r("p",Ds,H(p.value.periodThemes),1)):E("",!0),p.value.dreamFunctionsAnalysis?(i(),r("p",Cs,H(p.value.dreamFunctionsAnalysis),1)):E("",!0),p.value.psychologicalSupport?(i(),r("p",Ts,H(p.value.psychologicalSupport),1)):E("",!0),p.value.integrationExercise?(i(),r("div",js,[s("h4",Os,[t[11]||(t[11]=s("span",null,"💫",-1)),s("span",null,H(p.value.integrationExercise.title||"Практическое упражнение"),1)]),s("p",As,H(p.value.integrationExercise.description),1),p.value.integrationExercise.rationale?(i(),r("p",Hs,H(p.value.integrationExercise.rationale),1)):E("",!0)])):E("",!0)])])):E("",!0),!C.value&&!d.value&&!h.value?(i(),r(ee,{key:3},[s("div",Ys,[t[13]||(t[13]=s("div",{class:"px-3 py-2 font-semibold"},"Общий контекст серии",-1)),s("div",Ls,[s("div",{innerHTML:se.value},null,8,Bs)])]),m.value.length?(i(),r("div",zs,[t[14]||(t[14]=s("div",{class:"px-3 py-2 font-semibold"},"Повторяющиеся символы",-1)),s("div",Fs,[s("div",Is,[(i(!0),r(ee,null,re(m.value,o=>(i(),r("span",{key:"deep-"+o,class:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-white/15 text-white"},H(o),1))),128))])])])):E("",!0),be.value?(i(),r("div",Ns,[t[15]||(t[15]=s("div",{class:"px-3 py-2 font-semibold"},"Динамика",-1)),s("div",Us,[je(Je,{dynamics:de.value,userAge:(S=Ye(B).profile)==null?void 0:S.age_range,userGender:(O=Ye(B).profile)==null?void 0:O.gender},null,8,["dynamics","userAge","userGender"])])])):E("",!0),ge.value.length?(i(),r("div",Ws,[t[16]||(t[16]=s("div",{class:"px-3 py-2 font-semibold"},"Ключевые инсайты",-1)),s("div",Rs,[s("ol",Es,[(i(!0),r(ee,null,re(ge.value,(o,D)=>(i(),r("li",{key:"in"+D,class:"text-xs leading-relaxed"},H(o),1))),128))])])])):E("",!0),Z.value.length?(i(),r("div",Ps,[t[17]||(t[17]=s("div",{class:"px-3 py-2 font-semibold"},"Рекомендации",-1)),s("div",Zs,[s("ol",Vs,[(i(!0),r(ee,null,re(Z.value,(o,D)=>(i(),r("li",{key:"rec"+D,class:"text-xs leading-relaxed"},[typeof o=="object"&&o.title?(i(),r("div",qs,[s("div",Gs,H(o.title),1),s("div",Js,H(o.description),1),o.rationale?(i(),r("div",Xs,H(o.rationale),1)):E("",!0)])):(i(),r("div",Ks,H(typeof o=="string"?o:o.title),1))]))),128))])])])):E("",!0)],64)):E("",!0),(C.value||d.value)&&!h.value?(i(),r(ee,{key:4},[ge.value.length?(i(),r("div",Qs,[t[18]||(t[18]=s("div",{class:"px-3 py-2 font-semibold"},"Ключевые инсайты",-1)),s("div",en,[s("ol",tn,[(i(!0),r(ee,null,re(ge.value,(o,D)=>(i(),r("li",{key:"in"+D,class:"text-xs leading-relaxed"},H(o),1))),128))])])])):E("",!0),Z.value.length?(i(),r("div",sn,[t[19]||(t[19]=s("div",{class:"px-3 py-2 font-semibold"},"Рекомендации",-1)),s("div",nn,[s("ol",rn,[(i(!0),r(ee,null,re(Z.value,(o,D)=>(i(),r("li",{key:"rec"+D,class:"text-xs leading-relaxed"},[typeof o=="object"&&o.title?(i(),r("div",on,[s("div",an,H(o.title),1),s("div",ln,H(o.description),1),o.rationale?(i(),r("div",cn,H(o.rationale),1)):E("",!0)])):(i(),r("div",un,H(typeof o=="string"?o:o.title),1))]))),128))])])])):E("",!0)],64)):E("",!0)],64)):(i(),r(ee,{key:3},[s("div",dn,[t[20]||(t[20]=s("h3",{class:"px-3 py-2 text-xl font-semibold flex items-center justify-between"},[s("span",null,"Сон"),s("span",{class:"opacity-80 text-pink-400",style:{"font-size":"130%","font-family":"ui-rounded, -apple-system, system-ui, 'SF Pro Rounded', 'Segoe UI', Roboto, Arial"}},"“")],-1)),s("div",fn,[s("p",mn,H(V.dream.dream_text),1)])]),s("div",hn,[(i(!0),r(ee,null,re(at.value,(o,D)=>(i(),r("div",{key:o.key,class:"rounded-lg bg-white/10"},[s("h3",pn,H(o.title),1),s("div",vn,[o.key!=="hvdc"?(i(),r("div",{key:0,innerHTML:o.html,class:"text-base space-y-2 leading-relaxed"},null,8,yn)):(i(),r(ee,{key:1},[De.value?(i(),r("div",gn,[(i(!0),r(ee,null,re(ft.value,A=>(i(),r("div",{key:A.key},[s("div",_n,[s("span",null,H(A.label),1),s("span",null,[we(H(A.value)+"% ",1),A.norm!==null?(i(),r(ee,{key:0},[we(" / "+H(A.norm)+"%",1)],64)):E("",!0),A.delta!==null?(i(),r("span",{key:1,class:pe(A.delta>0?"text-green-300":A.delta<0?"text-red-300":"text-white/70")}," ("+H(A.delta>0?"+"+A.delta:A.delta)+"pp) ",3)):E("",!0)])]),s("div",xn,[A.norm!==null?(i(),r("div",{key:0,class:"absolute inset-y-0 left-0 bg-white/20",style:qe({width:A.norm+"%"})},null,4)):E("",!0),s("div",{class:"relative h-full bg-white/70",style:qe({width:A.value+"%"})},null,4)])]))),128)),s("div",bn,[t[22]||(t[22]=s("span",{class:"inline-flex items-center gap-2"},[s("span",{class:"w-2 h-2 rounded-full inline-block bg-white/70 shrink-0"}),we(" ваш сон")],-1)),s("span",wn,[t[21]||(t[21]=s("span",{class:"w-2 h-2 rounded-full inline-block bg-white/20 shrink-0"},null,-1)),we(" "+H(mt.value),1)])]),t[23]||(t[23]=s("div",{class:"text-sm opacity-70 flex items-start gap-2"},[s("span",{class:"inline-flex items-center justify-center w-4 h-4 rounded-full bg-white/20 text-white text-[10px]"},"i"),s("span",null,"Контент‑анализ по схеме HVdC; сравнение с демографическими нормами (DreamBank, SDDB).")],-1))])):E("",!0)],64))])]))),128))])],64)),s("div",kn,[s("button",{class:pe(["flex-1 rounded-xl py-2 text-sm font-medium text-center transition-colors",N.value===1?"bg-green-500/30 text-white ring-2 ring-green-400/60":"bg-white/20 hover:bg-white/30 text-white"]),onClick:he(g,["stop"])}," 👍 ",2),s("button",{class:pe(["flex-1 rounded-xl py-2 text-sm font-medium text-center transition-colors",N.value===2?"bg-red-500/30 text-white ring-2 ring-red-400/60":"bg-white/20 hover:bg-white/30 text-white"]),onClick:he(f,["stop"])}," 👎 ",2),s("button",{class:"flex-1 bg-red-500/20 hover:bg-red-500/30 text-white rounded-xl py-2 text-sm font-medium text-center transition-colors",onClick:he(j,["stop"])}," 🗑️ ")]),Ze.value&&Ie.value?(i(),r("div",$n,[t[24]||(t[24]=s("div",{class:"mb-2 opacity-80"},"Debug payload",-1)),we(" "+H(JSON.stringify(Ie.value,null,2))+" ",1),s("div",Mn,[s("button",{class:"px-3 py-1 rounded bg-white/10 hover:bg-white/20",onClick:he(lt,["stop"])},"Скопировать")])])):E("",!0),(i(),Le(Xe,{to:"body"},[Ne.value?(i(),r("div",{key:0,class:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/70",onClick:he(Ue,["self"]),onWheel:t[5]||(t[5]=he(()=>{},["prevent"])),onTouchmove:t[6]||(t[6]=he(()=>{},["prevent"]))},[s("div",{class:"w-[92vw] max-w-[440px] rounded-2xl bg-[var(--tg-theme-secondary-bg-color,#0c110c)] text-white p-4 shadow-2xl border border-white/10",onClick:t[4]||(t[4]=he(()=>{},["stop"]))},[t[27]||(t[27]=s("h3",{class:"text-lg font-semibold mb-2"},"Уточнить данные",-1)),Ve.value===1?(i(),r("div",Sn,[t[25]||(t[25]=s("p",{class:"opacity-90"},"Ваш возрастной диапазон:",-1)),s("div",Dn,[(i(),r(ee,null,re(ut,o=>s("button",{key:o,class:pe(["px-4 py-3 rounded-xl text-sm",Ae.value===o?"bg-white/25":"bg-white/10 hover:bg-white/15"]),onClick:D=>Ae.value=o},H(o),11,Cn)),64))]),s("div",Tn,[s("button",{class:"px-4 py-2 rounded-xl bg-white/10",onClick:Ue},"Отмена"),s("button",{class:"px-4 py-2 rounded-xl bg-white/20",disabled:!Ae.value,onClick:t[1]||(t[1]=o=>Ve.value=2)},"Далее",8,jn)])])):(i(),r("div",On,[t[26]||(t[26]=s("p",{class:"opacity-90"},"Ваш пол:",-1)),s("div",An,[s("button",{class:pe(["px-4 py-3 rounded-xl text-sm",Me.value==="male"?"bg-white/25":"bg-white/10 hover:bg-white/15"]),onClick:t[2]||(t[2]=o=>Me.value="male")},"Мужской",2),s("button",{class:pe(["px-4 py-3 rounded-xl text-sm",Me.value==="female"?"bg-white/25":"bg-white/10 hover:bg-white/15"]),onClick:t[3]||(t[3]=o=>Me.value="female")},"Женский",2)]),s("div",Hn,[s("button",{class:"px-4 py-2 rounded-xl bg-white/10",onClick:Ue},"Отмена"),s("button",{class:"px-4 py-2 rounded-xl bg-white/20",disabled:!Me.value,onClick:dt},"Сохранить",8,Yn)])]))])],32)):E("",!0)]))])):E("",!0)],2)}}}),Pe=Fe(Bn,[["__scopeId","data-v-78d187f9"]]),zn={class:"pb-6 overlay-pad"},Fn=Be({__name:"DreamOverlay",props:{dream:{},anchorY:{}},emits:["close"],setup(V,{emit:G}){ae.locale("ru"),ae.extend(tt),ae.extend(nt);const a=V,P=G,J=new Set(["и","в","во","не","что","он","на","я","с","со","как","а","то","все","она","так","его","но","да","ты","к","у","же","вы","за","бы","по","ее","мне","было","вот","от","меня","еще","нет","о","из","ему","теперь","когда","даже","ну","вдруг","ли","если","уже","или","ни","быть","был","него","до","вас","нибудь","опять","уж","вам","ведь","там","потом","себя","ничего","ей","может","они","тут","где","есть","надо","ней","для","мы","тебя","их","чем","была","сам","чтоб","без","будто","чего","раз","тоже","себе","под","будет","ж","тогда","кто","этот","того","потому","этого","какой","совсем","ним","здесь","этом","один","почти","мой","тем","чтобы","нее","кажется","сейчас","были","куда","зачем","всех","никогда","можно","при","наконец","два","об","другой","хоть","после","над","больше","тот","через","эти","нас","про","всего","них","какая","много","разве","три","эту","моя","впрочем","хорошо","свою","этой","перед","иногда","лучше","чуть","том","нельзя","такой","им","более","всегда","конечно","всю","между"]),q=c=>String(c||"").replace(/\s+/g," ").trim().split(" ").map(m=>m.charAt(0).toUpperCase()+m.slice(1)).join(" "),T=c=>{if(!c)return"";const m=String(c).split(/[.!?\n]/)[0],L=m.toLowerCase().replace(/[^\p{L}\p{N}\s-]/gu,"").split(/\s+/).filter(U=>U&&!J.has(U)&&U.length>3).slice(0,3);return L.length===0?m.slice(0,40):q(L.join(" "))},B=c=>{if(!c)return"";let m=String(c).toLowerCase().replace(/["'«»]/g,"").trim();m=m.replace(/^(приснилось|снилось|сон о|сон про|сон|мне снится|мне приснилось)\s+/i,""),m=m.replace(/\s+/g," ").trim();const $=m.split(" ").filter(Boolean).slice(0,3);return $.length?$.join(" "):""},x=c=>{if(!c)return"";const m=String(c).toLowerCase();return m.charAt(0).toUpperCase()+m.slice(1)};b(()=>{var M,ve,xe,C,v;const c=B(String(((ve=(M=a.dream)==null?void 0:M.deep_source)==null?void 0:ve.title)||""));if(c)return x(c);const m=(((C=(xe=a.dream)==null?void 0:xe.deep_source)==null?void 0:C.tags)||[]).filter(Boolean),$=d=>{var h;let p=String(d||"").trim();return p=((h=p.split(/[\\/,(;:—–-]/)[0])==null?void 0:h.trim())||"",p?p.charAt(0).toUpperCase()+p.slice(1).toLowerCase():""},L=m.map($).filter(Boolean);if(L.length){const d=L.slice(0,2).join(" и ");return x(d||"Без названия")}const U=B(T(String(((v=a.dream)==null?void 0:v.dream_text)||"")));return x(U||"Без названия")}),b(()=>{var m;const c=(m=a.dream)==null?void 0:m.created_at;if(!c)return"";try{const $=Intl.DateTimeFormat().resolvedOptions().timeZone||ae.tz.guess();return ae.utc(c).tz($).format("D MMMM YYYY, HH:mm")}catch{return c}});function I(){var c,m,$,L,U;try{const M=(c=window==null?void 0:window.Telegram)==null?void 0:c.WebApp;($=(m=M==null?void 0:M.BackButton)==null?void 0:m.show)==null||$.call(m),(U=(L=M==null?void 0:M.BackButton)==null?void 0:L.onClick)==null||U.call(L,N)}catch{}}function W(){var c,m,$,L,U;try{const M=(c=window==null?void 0:window.Telegram)==null?void 0:c.WebApp;($=(m=M==null?void 0:M.BackButton)==null?void 0:m.hide)==null||$.call(m),(U=(L=M==null?void 0:M.BackButton)==null?void 0:L.offClick)==null||U.call(L,N)}catch{}}function N(){P("close")}const k=ne(null);function R(c){const m=k.value;m&&m.contains(c.target)||P("close")}kt(()=>{$t(()=>a.dream,c=>{if(c){try{document.body.style.overflow="hidden"}catch{}I()}else{W();try{document.body.style.overflow=""}catch{}}},{immediate:!0})}),Mt(()=>{W();try{document.body.style.overflow=""}catch{}});const g=ne(null);let f=0,j=!1,Y=!1,l=0;function y(c){try{const m=g.value;if(!m||(Y=m.scrollTop<=0,!Y))return;f=c.touches[0].clientY,l=0,j=!0}catch{}}function w(c){if(!j||!Y)return;const m=c.touches[0].clientY;if(l=Math.max(0,m-f),l>0){c.preventDefault();const $=k.value;$&&($.style.transform=`translateY(${Math.min(120,l)}px)`)}}function _(){if(j&&Y&&l>=120)P("close");else{const c=k.value;c&&(c.style.transform="")}j=!1,Y=!1,f=0,l=0}return(c,m)=>(i(),Le(Xe,{to:"body"},[V.dream?(i(),r("div",{key:0,class:"fixed inset-0 z-[9998] bg-black/70",onClick:R},[s("div",{class:"absolute inset-0 overflow-y-auto",ref_key:"scrollerRef",ref:g,onTouchstart:y,onTouchmove:w,onTouchend:_},[s("div",zn,[s("div",{ref_key:"cardRef",ref:k,onClick:m[0]||(m[0]=he(()=>{},["stop"]))},[je(Pe,{dream:V.dream,active:!0,overlayMode:!0},null,8,["dream"])],512)])],544)])):E("",!0)]))}}),In=Fe(Fn,[["__scopeId","data-v-19174b42"]]),Nn={class:"flex items-center gap-8 mb-6 border-b border-white/10"},Un={key:0,class:"absolute bottom-0 left-0 right-0 h-0.5 bg-white rounded-full"},Wn={key:0,class:"absolute bottom-0 left-0 right-0 h-0.5 bg-white rounded-full"},Rn={key:0,class:"flex flex-col gap-4 pb-[5vh]"},En={key:1,class:"text-center text-red-400 py-8"},Pn={key:2},Zn={key:0,class:"text-center text-white/60 py-8"},Vn={key:1,class:"flex flex-col gap-4 pb-[5vh]"},qn={key:3},Gn={key:0,class:"text-center text-white/60 py-8"},Jn={key:1,class:"flex flex-col gap-4 pb-[5vh]"},Xn=Be({__name:"AnalysisHistoryList",props:["userStore"],setup(V){const G=V,a=ne(null),P=ne(null),J=ne(5),q=ne(5),T=ne("history"),B=b(()=>{var l;return(l=G.userStore)!=null&&l.history?G.userStore.history.filter(y=>!y.is_deep_analysis):[]}),x=b(()=>{var l;return(l=G.userStore)!=null&&l.history?G.userStore.history.filter(y=>y.is_deep_analysis):[]}),I=b(()=>B.value.slice(0,J.value)),W=b(()=>x.value.slice(0,q.value)),N=b(()=>B.value.length>J.value),k=b(()=>x.value.length>q.value),R=()=>{window.triggerHaptic&&window.triggerHaptic("light"),J.value+=5},g=()=>{window.triggerHaptic&&window.triggerHaptic("light"),q.value+=5},f=l=>{window.triggerHaptic&&window.triggerHaptic("light"),T.value=l,a.value=null},j=(l,y)=>{var w,_,c,m,$;a.value=l,P.value=typeof(y==null?void 0:y.y)=="number"?Math.max(0,Math.round(y.y)):null;try{const L=(w=window==null?void 0:window.Telegram)==null?void 0:w.WebApp;(c=(_=L==null?void 0:L.BackButton)==null?void 0:_.onClick)==null||c.call(_,()=>Y()),($=(m=L==null?void 0:L.BackButton)==null?void 0:m.show)==null||$.call(m)}catch{}},Y=()=>{var l,y,w;try{const _=(l=window==null?void 0:window.Telegram)==null?void 0:l.WebApp;(w=(y=_==null?void 0:_.BackButton)==null?void 0:y.hide)==null||w.call(y)}catch{}a.value=null,P.value=null};return(l,y)=>{var w,_,c,m;return i(),r("div",null,[s("div",Nn,[s("button",{onClick:y[0]||(y[0]=$=>f("history")),class:pe(["relative pb-3 text-lg font-semibold transition-all duration-200",[T.value==="history"?"text-white":"text-white/40 hover:text-white/60"]])},[y[2]||(y[2]=we(" Дневник снов ",-1)),T.value==="history"?(i(),r("div",Un)):E("",!0)],2),s("button",{onClick:y[1]||(y[1]=$=>f("deep")),class:pe(["relative pb-3 text-lg font-semibold transition-all duration-200",[T.value==="deep"?"text-white":"text-white/40 hover:text-white/60"]])},[y[3]||(y[3]=we(" Глубокий анализ ",-1)),T.value==="deep"?(i(),r("div",Wn)):E("",!0)],2)]),(w=V.userStore)!=null&&w.isLoadingHistory?(i(),r("div",Rn,[(i(),r(ee,null,re(3,$=>s("div",{key:$,class:"rounded-xl bg-white/10 px-8 md:px-16 py-6"},[...y[4]||(y[4]=[St('<div class="flex justify-between items-center py-2 min-h-[2.5rem]" data-v-cb63dade><div class="shimmer h-4 w-32 rounded" data-v-cb63dade></div><div class="shimmer h-4 w-12 rounded" data-v-cb63dade></div></div><div class="mt-4 space-y-2" data-v-cb63dade><div class="shimmer h-3 w-full rounded" data-v-cb63dade></div><div class="shimmer h-3 w-5/6 rounded" data-v-cb63dade></div><div class="shimmer h-3 w-2/3 rounded" data-v-cb63dade></div></div><div class="mt-4 grid grid-cols-3 gap-2" data-v-cb63dade><div class="shimmer h-6 rounded-full" data-v-cb63dade></div><div class="shimmer h-6 rounded-full" data-v-cb63dade></div><div class="shimmer h-6 rounded-full" data-v-cb63dade></div></div>',3)])])),64))])):(_=V.userStore)!=null&&_.errorHistory?(i(),r("div",En," Ошибка загрузки: "+H(V.userStore.errorHistory),1)):T.value==="history"?(i(),r("div",Pn,[(c=B.value)!=null&&c.length?(i(),r("div",Vn,[(i(!0),r(ee,null,re(I.value,$=>(i(),Le(Pe,{key:$.id,dream:$,onOpen:L=>j($,L)},null,8,["dream","onOpen"]))),128)),N.value?(i(),r("button",{key:0,class:"self-center rounded-full px-4 py-2 text-sm font-medium transition-colors my-2 themed-button",onClick:R}," Загрузить ещё ")):E("",!0)])):(i(),r("div",Zn," У вас пока нет сохраненных анализов "))])):T.value==="deep"?(i(),r("div",qn,[(m=x.value)!=null&&m.length?(i(),r("div",Jn,[(i(!0),r(ee,null,re(W.value,$=>(i(),Le(Pe,{key:$.id,dream:$,onOpen:L=>j($,L)},null,8,["dream","onOpen"]))),128)),k.value?(i(),r("button",{key:0,class:"self-center rounded-full px-4 py-2 text-sm font-medium transition-colors my-2 themed-button",onClick:g}," Загрузить ещё ")):E("",!0)])):(i(),r("div",Gn," Пока нет глубоких анализов "))])):E("",!0),je(In,{dream:a.value,"anchor-y":P.value,onClose:Y},null,8,["dream","anchor-y"])])}}}),ti=Fe(Xn,[["__scopeId","data-v-cb63dade"]]);export{ti as default};
