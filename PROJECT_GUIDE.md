# Dream Analyzer - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø—Ä–æ–µ–∫—Ç—É

> **–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Droid AI**  
> –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 19 –æ–∫—Ç—è–±—Ä—è 2025

---

## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
4. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ñ–∞–π–ª–æ–≤)
5. [–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
6. [Backend —Ñ—É–Ω–∫—Ü–∏–∏](#backend-—Ñ—É–Ω–∫—Ü–∏–∏)
7. [Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#frontend-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
8. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
9. [–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–Ω–æ–≤](#–≥–ª—É–±–æ–∫–∏–π-–∞–Ω–∞–ª–∏–∑-—Å–Ω–æ–≤)
10. [–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π](#–∏—Å—Ç–æ—Ä–∏—è-–∏–∑–º–µ–Ω–µ–Ω–∏–π)
11. [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—Ä–æ–µ–∫—Ç–æ–º](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞—Ç—å-—Å-–ø—Ä–æ–µ–∫—Ç–æ–º)

---

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

**Dream Analyzer** - —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–Ω–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI (Google Gemini), —Å–æ—Å—Ç–æ—è—â–∞—è –∏–∑ —Ç—Ä–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

1. **Telegram Bot** 
   - Grammy.js framework
   - Serverless functions (Netlify)
   - Webhook handler –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

2. **TMA (Telegram Mini App)**
   - Vue.js 3 –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ Telegram
   - –ú–æ–±–∏–ª—å–Ω—ã–π UX (–±–µ–∑ hover —Å–æ—Å—Ç–æ—è–Ω–∏–π)

3. **Web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
   - Vue.js 3 –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
   - JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
   - Desktop/Mobile –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å

### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

- ‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–Ω–æ–≤ —á–µ—Ä–µ–∑ Google Gemini AI
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤ (–æ–±—ã—á–Ω—ã–µ + –≥–ª—É–±–æ–∫–∏–µ)
- ‚úÖ –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–Ω–æ–≤
- ‚úÖ HVdC –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º–∏ –Ω–æ—Ä–º–∞–º–∏
- ‚úÖ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏–∫–∏ —Å–Ω–æ–≤ (–≥—Ä–∞—Ñ–∏–∫–∏)
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ (Telegram Stars)
- ‚úÖ –ö—Ä–µ–¥–∏—Ç—ã –Ω–∞ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑
- ‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Frontend
- **Framework:** Vue.js 3 (Composition API)
- **State Management:** Pinia
- **HTTP Client:** Axios
- **Build Tool:** Vite
- **Styling:** 
  - TailwindCSS (TMA)
  - CSS Modules (Web)
- **UI/UX:** Mobile-first (TMA), Responsive (Web)

### Backend
- **Runtime:** Node.js 20
- **Functions:** Netlify Serverless Functions
- **Bot Framework:** Grammy.js
- **AI Provider:** Google Gemini API
  - Model: `gemini-2.5-flash` (fallback: `gemini-2.0-flash`)
  - **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è**: `temperature=0`, `topK=1`, `topP=0.1`
- **Authentication:**
  - JWT + httpOnly cookies (Web)
  - Telegram InitData validation (TMA)

### Database & Storage
- **Database:** Supabase (PostgreSQL)
- **Caching:** In-memory cache service
- **File Storage:** Netlify CDN

### Deployment
- **Hosting:** Netlify
  - Bot: `sparkling-cupcake-940504.netlify.app`
  - TMA: `tourmaline-eclair-9d40ea.netlify.app`
  - Web: `bot.dreamstalk.ru`
- **CI/CD:** Auto-deploy on git push
- **Testing:** Production testing approach

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### High-Level Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Users / Clients                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ               ‚îÇ               ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ   Telegram  ‚îÇ ‚îÇ TMA (Vue)  ‚îÇ ‚îÇ Web (Vue)  ‚îÇ
       ‚îÇ     Bot     ‚îÇ ‚îÇ   Client   ‚îÇ ‚îÇ   Client   ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ               ‚îÇ               ‚îÇ
              ‚îÇ      HTTPS API Calls          ‚îÇ
              ‚îÇ               ‚îÇ               ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ Netlify Functions   ‚îÇ
                   ‚îÇ  (Backend Services) ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ               ‚îÇ               ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ   Supabase  ‚îÇ ‚îÇ  Gemini AI ‚îÇ ‚îÇ  Telegram  ‚îÇ
       ‚îÇ  PostgreSQL ‚îÇ ‚îÇ     API    ‚îÇ ‚îÇ  Bot API   ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Data Flow: Dream Analysis

```
User ‚Üí TMA/Web ‚Üí analyze-dream.js ‚Üí Gemini API ‚Üí Database ‚Üí Response
                      ‚Üì
                Cache Service
                      ‚Üì
                  HVdC Analysis
```

### Data Flow: Deep Analysis (Background)

```
User ‚Üí TMA ‚Üí deep-analysis.js ‚Üí Trigger Background Job
                                        ‚Üì
                             deep-analysis-background.js
                                        ‚Üì
                                   Gemini API
                                   (15+ min)
                                        ‚Üì
                              Save to Database
                                        ‚Üì
                            Send Telegram Notification
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### Root Structure

```
dream-analyzer/
‚îú‚îÄ‚îÄ bot/                    # Backend (Netlify Functions)
‚îú‚îÄ‚îÄ tma/                    # Telegram Mini App (Vue)
‚îú‚îÄ‚îÄ web/                    # Web Application (Vue)
‚îú‚îÄ‚îÄ scripts/                # Utility scripts
‚îú‚îÄ‚îÄ tests/                  # Test files
‚îú‚îÄ‚îÄ docs/                   # Documentation
‚îú‚îÄ‚îÄ coverage/               # Test coverage reports
‚îú‚îÄ‚îÄ netlify.toml           # Netlify configuration
‚îú‚îÄ‚îÄ package.json           # Root dependencies
‚îî‚îÄ‚îÄ PROJECT_GUIDE.md       # This file
```

### Backend Structure (`/bot`)

```
bot/
‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îú‚îÄ‚îÄ analyze-dream.js              # Single dream analysis
‚îÇ   ‚îú‚îÄ‚îÄ deep-analysis.js              # Trigger deep analysis (202 response)
‚îÇ   ‚îú‚îÄ‚îÄ deep-analysis-background.js   # Long-running deep analysis
‚îÇ   ‚îú‚îÄ‚îÄ user-profile.js               # Get user profile
‚îÇ   ‚îú‚îÄ‚îÄ analyses-history.js           # Get analysis history
‚îÇ   ‚îú‚îÄ‚îÄ create-invoice.js             # Telegram Stars payments
‚îÇ   ‚îú‚îÄ‚îÄ claim-channel-token.js        # Channel reward
‚îÇ   ‚îú‚îÄ‚îÄ bot.js                        # Telegram bot webhook
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ shared/
‚îÇ       ‚îú‚îÄ‚îÄ auth/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ telegram-validator.js  # InitData validation
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ database/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ queries.js             # Optimized DB queries
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ services/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ gemini-service.js      # AI analysis (deterministic)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ hvdc-service.js        # HVdC content analysis
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cache-service.js       # Caching layer
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ embedding-service.js   # Text embeddings
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ middleware/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cors.js                # CORS headers
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ error-handler.js       # Error processing
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ api-wrapper.js         # API response wrapper
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ prompts/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ dream-prompts.js       # Gemini prompts
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ utils/
‚îÇ           ‚îî‚îÄ‚îÄ logger.js              # Logging utility
‚îÇ
‚îú‚îÄ‚îÄ auth-test.html         # Test page for auth
‚îî‚îÄ‚îÄ netlify.toml          # Function-specific config
```

### Frontend Structure (`/tma`)

```
tma/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AnalysisHistoryList.vue   # Main history with tabs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DreamCard.vue              # Dream display card
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeepAnalysisCard.vue       # Deep analysis trigger
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserInfoCard.vue           # User info + credits
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DynamicsChart.vue          # HVdC visualization
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SymbolCard.vue             # Recurring symbols
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Onboarding.vue             # First-time tour
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.js                    # User state + API calls
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notifications.js           # Toast notifications
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.js                     # Axios API client
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ errorService.js            # Error handling
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ composables/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useOfflineDetection.js     # Network status
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PersonalAccount.vue        # Main page
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ App.vue                        # Root component
‚îÇ   ‚îî‚îÄ‚îÄ main.js                        # Entry point
‚îÇ
‚îú‚îÄ‚îÄ public/                # Static assets
‚îú‚îÄ‚îÄ dist/                  # Build output
‚îú‚îÄ‚îÄ package.json          # Dependencies
‚îú‚îÄ‚îÄ vite.config.js        # Vite config
‚îî‚îÄ‚îÄ netlify.toml          # Deploy config
```

---

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Gemini Service (AI Core)

**–§–∞–π–ª:** `bot/functions/shared/services/gemini-service.js`

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Singleton pattern –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- Retry mechanism —Å exponential backoff
- Model fallback chain: `gemini-2.5-flash` ‚Üí `gemini-2.0-flash` ‚Üí `gemini-1.5-flash`
- **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å–Ω—ã ‚Üí –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç):
  ```javascript
  generationConfig: {
      temperature: 0,     // Deterministic output
      topK: 1,           // Only most probable token
      topP: 0.1,         // Minimal randomness
  }
  ```
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (1-2 —á–∞—Å–∞ TTL)
- JSON structured output parsing

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `analyzeDream(dreamText, promptKey)` - –∞–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ —Å–Ω–∞
- `deepAnalyzeDreamsJSON(combinedDreams, useFast)` - –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ 5 —Å–Ω–æ–≤
- `analyzeDreamJSON(dreamText)` - –∞–Ω–∞–ª–∏–∑ —Å JSON –ø–∞—Ä—Å–∏–Ω–≥–æ–º

**–ü—Ä–æ–º–ø—Ç—ã:**
- `basic_json` - –æ–±—ã—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- `deep_json` - –ø–æ–ª–Ω—ã–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ (35-45 —Å–µ–∫)
- `deep_json_fast` - –±—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑ (15-20 —Å–µ–∫)

### 2. HVdC Service (Content Analysis)

**–§–∞–π–ª:** `bot/functions/shared/services/hvdc-service.js`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ö–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ Hall & Van de Castle
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: –ü–µ—Ä—Å–æ–Ω–∞–∂–∏, –≠–º–æ—Ü–∏–∏, –î–µ–π—Å—Ç–≤–∏—è, –°—Ü–µ–Ω—ã
- –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ (0-100%)
- –î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –Ω–æ—Ä–º—ã (–º—É–∂—á–∏–Ω—ã/–∂–µ–Ω—â–∏–Ω—ã)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º–∏

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```javascript
const hvdcResult = await hvdcService.analyzeWithDemographics(
    dreamText, 
    userDemographics
);
```

### 3. User Store (State Management)

**–§–∞–π–ª:** `tma/src/stores/user.js`

**–û—Å–Ω–æ–≤–Ω–æ–π state:**
```javascript
{
    profile: {
        tokens: Number,
        subscription_type: String,
        deep_analysis_credits: Number,
        deep_analyses_count: Number,
        total_dreams_count: Number,
    },
    history: Array,
    deepAnalysisProcessing: Boolean,  // –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    deepAnalysisSuccess: Boolean,
    deepAnalysisError: String,
}
```

**–ö–ª—é—á–µ–≤—ã–µ actions:**
- `fetchProfile()` - –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
- `fetchHistory()` - –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
- `performDeepAnalysis()` - –∑–∞–ø—É—Å–∫ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- `startDeepAnalysisPolling()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞

**UX –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –ù–µ—Ç —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- Polling –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –ë–∞–Ω–Ω–µ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ snackbar

---

## Backend —Ñ—É–Ω–∫—Ü–∏–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ Endpoints

#### 1. `analyze-dream.js`
**Purpose:** –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ —Å–Ω–∞

**Request:**
```javascript
POST /analyze-dream
Headers: {
    'X-Telegram-Init-Data': <telegram_init_data>
}
Body: {
    dreamText: String
}
```

**Response:**
```javascript
{
    title: String,          // 2-3 —Å–ª–æ–≤–∞
    tags: [String],         // 3-5 —Ç–µ–≥–æ–≤
    analysis: String,       // –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    hvdc: {                 // HVdC –∞–Ω–∞–ª–∏–∑
        characters: Number,
        emotions: Number,
        actions: Number,
        settings: Number,
        demographics: {...}
    }
}
```

#### 2. `deep-analysis.js`
**Purpose:** –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ 5 —Å–Ω–æ–≤

**Flow:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ (–ø–ª–∞—Ç–Ω—ã–µ –∏–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
2. –°–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞
3. –ü–æ–ª—É—á–µ–Ω–∏–µ 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–Ω–æ–≤
4. Trigger background function
5. **–í–æ–∑–≤—Ä–∞—Ç 202 Accepted** (–Ω–µ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)

**Request:**
```javascript
POST /deep-analysis
Headers: {
    'X-Telegram-Init-Data': <telegram_init_data>
}
```

**Response (202):**
```javascript
{
    processing: true,
    message: "–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ"
}
```

#### 3. `deep-analysis-background.js`
**Purpose:** Long-running deep analysis (–¥–æ 15 –º–∏–Ω—É—Ç)

**Process:**
1. –ü–æ–ª—É—á–∞–µ—Ç combinedDreamsText –∏–∑ trigger
2. –í—ã–∑—ã–≤–∞–µ—Ç Gemini —Å –ø–æ–ª–Ω—ã–º `deep_json` –ø—Ä–æ–º–ø—Ç–æ–º
3. –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `deep_analyses`)
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å deep link

**Output Structure:**
```javascript
{
    title: String,
    tags: [String],
    analysis: String,
    symbolsIntro: String,
    recurringSymbols: [
        {
            symbol: String,
            frequency: Number,      // 2-5 (–∏–∑ 5 —Å–Ω–æ–≤)
            description: String,
            userContext: String
        }
    ],
    dynamicsContext: [
        {
            category: "–ü–µ—Ä—Å–æ–Ω–∞–∂–∏" | "–≠–º–æ—Ü–∏–∏" | "–î–µ–π—Å—Ç–≤–∏—è" | "–°—Ü–µ–Ω—ã",
            values: [Number],       // 5 –∑–Ω–∞—á–µ–Ω–∏–π (0-100%)
            analysis: String,
            insight: String
        }
    ],
    conclusion: {
        periodThemes: String,
        dreamFunctionsAnalysis: String,
        psychologicalSupport: String,
        integrationExercise: {
            title: String,
            description: String,
            rationale: String
        }
    }
}
```

#### 4. `user-profile.js`
**Purpose:** –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Response:**
```javascript
{
    id: Number,
    telegram_user_id: Number,
    tokens: Number,
    subscription_type: String,
    subscription_end: Date,
    deep_analysis_credits: Number,
    free_deep_analysis: Number,
    deep_analyses_count: Number,
    total_dreams_count: Number,
    onboarding_stage: String
}
```

#### 5. `create-invoice.js`
**Purpose:** –°–æ–∑–¥–∞–Ω–∏–µ Telegram Stars invoice

**Request:**
```javascript
POST /create-invoice
Body: {
    plan: "premium" | "deep_analysis",
    duration: Number,        // –ú–µ—Å—è—Ü—ã (–¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏)
    amount: Number,          // –ó–≤–µ–∑–¥—ã
    payload: String          // Unique identifier
}
```

---

## Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. AnalysisHistoryList.vue

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å —Ç–∞–±–∞–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```vue
<template>
  <!-- –¢–∞–±—ã –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è -->
  <div class="tabs">
    <button @click="switchTab('history')">
      –î–Ω–µ–≤–Ω–∏–∫ —Å–Ω–æ–≤
    </button>
    <button @click="switchTab('deep')">
      –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑
    </button>
  </div>
  
  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
  <div v-if="activeTab === 'history'">
    <DreamCard v-for="dream in regularDreams" />
  </div>
  
  <div v-else-if="activeTab === 'deep'">
    <DreamCard v-for="dream in deepAnalyses" />
  </div>
</template>
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ UI:**
- –ê–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±: –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç + –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ —Å–Ω–∏–∑—É
- –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±: –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—ã–π (40% opacity)
- –ü–ª–∞–≤–Ω—ã–µ transition –∞–Ω–∏–º–∞—Ü–∏–∏ (200ms)
- Haptic feedback –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏

### 2. DreamCard.vue

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Å–Ω–∞ –∏–ª–∏ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

**–†–µ–∂–∏–º—ã:**
1. **–û–±—ã—á–Ω—ã–π —Å–æ–Ω:**
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫
   - –¢–µ–≥–∏
   - –ê–Ω–∞–ª–∏–∑
   - HVdC –≥—Ä–∞—Ñ–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)

2. **–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑:**
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫
   - –°–∏–º–≤–æ–ª—ã (collapsible block)
   - –î–∏–Ω–∞–º–∏–∫–∞ (DynamicsChart)
   - –ó–∞–∫–ª—é—á–µ–Ω–∏–µ (collapsible block)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫–æ–≤:**
```vue
<!-- –°–∏–º–≤–æ–ª—ã -->
<div class="collapsible-block">
  <h4>–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã</h4>
  <ul>
    <li v-for="symbol in recurringSymbols">
      <span class="frequency">√ó{{ symbol.frequency }}</span>
      {{ symbol.symbol }}
      <p>{{ symbol.description }}</p>
      <p>{{ symbol.userContext }}</p>
    </li>
  </ul>
</div>

<!-- –î–∏–Ω–∞–º–∏–∫–∞ -->
<DynamicsChart :data="dynamicsContext" />

<!-- –ó–∞–∫–ª—é—á–µ–Ω–∏–µ -->
<div class="collapsible-block">
  <div>{{ conclusion.periodThemes }}</div>
  <div>{{ conclusion.dreamFunctionsAnalysis }}</div>
  <div>{{ conclusion.psychologicalSupport }}</div>
  <div>{{ conclusion.integrationExercise }}</div>
</div>
```

### 3. DynamicsChart.vue

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ HVdC –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Pagination —Å swipe –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
- 4 –≥—Ä–∞—Ñ–∏–∫–∞ (–ü–µ—Ä—Å–æ–Ω–∞–∂–∏, –≠–º–æ—Ü–∏–∏, –î–µ–π—Å—Ç–≤–∏—è, –°—Ü–µ–Ω—ã)
- –î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã (–∂–µ–ª—Ç—ã–µ –ø–æ–ª–æ—Å—ã)
- Dynamic Y-axis –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–æ–¥–ø–∏—Å–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º –∏ insights

**Props:**
```vue
props: {
  data: Array<{
    category: String,
    values: Array<Number>,      // 5 —Ç–æ—á–µ–∫
    analysis: String,
    insight: String
  }>,
  demographics: Object
}
```

### 4. DeepAnalysisCard.vue

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ë–∞–Ω–Ω–µ—Ä –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
1. **–î–æ—Å—Ç—É–ø–µ–Ω –∞–Ω–∞–ª–∏–∑:**
   - –ö–Ω–æ–ø–∫–∞ "–í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑" (–µ—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–µ–¥–∏—Ç—ã)
   - –ö–Ω–æ–ø–∫–∞ "–ü–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑ (1 ‚≠êÔ∏è)" (–µ—Å–ª–∏ –Ω–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤)

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞:** 
   - –ë–∞–Ω–Ω–µ—Ä —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
   - "–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω! –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ..."

3. **–ì–æ—Ç–æ–≤:**
   - –ó–µ–ª–µ–Ω—ã–π –±–∞–Ω–Ω–µ—Ä "–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤!"

4. **–û—à–∏–±–∫–∞:**
   - –ö—Ä–∞—Å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—à–∏–±–∫–∏

**UX improvements:**
- –ë–µ–∑ snackbar —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –¢–æ–ª—å–∫–æ –±–∞–Ω–Ω–µ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–µ—Ç —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- Polling –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. Telegram Bot API

**Grammy.js Framework**

**Webhook URL:** `https://sparkling-cupcake-940504.netlify.app/bot`

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**
- `/start` - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- Text message - –∞–Ω–∞–ª–∏–∑ —Å–Ω–∞
- Payment handlers - –æ–±—Ä–∞–±–æ—Ç–∫–∞ Telegram Stars

**–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
```javascript
bot.api.sendMessage(chatId, message, {
    parse_mode: 'HTML',
    reply_markup: {
        inline_keyboard: [[{
            text: '–û—Ç–∫—Ä—ã—Ç—å –∞–Ω–∞–ª–∏–∑',
            url: tmaDeepLink
        }]]
    }
});
```

### 2. Telegram Mini Apps (TMA)

**InitData Validation:**
```javascript
// bot/functions/shared/auth/telegram-validator.js
const validationResult = validateTelegramData(initDataHeader, BOT_TOKEN);

if (!validationResult.valid) {
    throw new Error('Invalid InitData');
}

const userId = validationResult.data.id;
```

**Frontend Integration:**
```javascript
// tma/src/main.js
const tg = window.Telegram?.WebApp;
tg.ready();
tg.expand();

// API calls with InitData
axios.defaults.headers.common['X-Telegram-Init-Data'] = tg.initData;
```

### 3. Supabase Database

**Schema (–æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã):**

```sql
-- Users
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    telegram_user_id BIGINT UNIQUE,
    tokens INTEGER DEFAULT 1,
    subscription_type VARCHAR DEFAULT 'free',
    subscription_end TIMESTAMP,
    deep_analysis_credits INTEGER DEFAULT 0,
    free_deep_analysis INTEGER DEFAULT 1,
    deep_analyses_count INTEGER DEFAULT 0,
    total_dreams_count INTEGER DEFAULT 0
);

-- Dreams (single analyses)
CREATE TABLE dreams (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    dream_text TEXT,
    title VARCHAR(100),
    tags VARCHAR[],
    analysis TEXT,
    hvdc_data JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Deep Analyses
CREATE TABLE deep_analyses (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    deep_source JSONB,              -- Full structured output
    dreams_analyzed INTEGER DEFAULT 5,
    created_at TIMESTAMP DEFAULT NOW()
);
```

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**
```javascript
// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–Ω–æ–≤
const { data: dreams } = await supabase
    .from('dreams')
    .select('id, dream_text, created_at')
    .eq('user_id', userId)
    .order('created_at', { ascending: false })
    .limit(5);
```

**RPC —Ñ—É–Ω–∫—Ü–∏–∏:**
```sql
-- –°–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞
CREATE OR REPLACE FUNCTION decrement_deep_analysis_credits_safe(user_tg_id BIGINT)
RETURNS TABLE(success BOOLEAN, remaining_credits INTEGER);

-- –û—Ç–∫–∞—Ç –∫—Ä–µ–¥–∏—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
CREATE OR REPLACE FUNCTION increment_deep_analysis_credits(user_tg_id BIGINT, amount INTEGER)
RETURNS VOID;
```

### 4. Google Gemini AI

**Model Configuration:**
```javascript
const model = genAI.getGenerativeModel({
    model: 'gemini-2.5-flash',
    generationConfig: {
        temperature: 0,      // –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
        topK: 1,
        topP: 0.1,
    }
});
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã** (`bot/functions/shared/prompts/dream-prompts.js`):

**basic_json** - –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ —Å–Ω–∞:
```javascript
{
    title: "2-3 —Å–ª–æ–≤–∞",
    tags: ["—Ç–µ–≥1", "—Ç–µ–≥2", "—Ç–µ–≥3"],
    analysis: "2-4 –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞ –∞–Ω–∞–ª–∏–∑–∞"
}
```

**deep_json** - –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ 5 —Å–Ω–æ–≤:
```javascript
{
    title: String,
    tags: [String],
    analysis: String,
    symbolsIntro: String,
    recurringSymbols: [...],
    dynamicsContext: [...],
    conclusion: {...}
}
```

**–ö–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–º–ø—Ç–µ:**
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–°–ï 4 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ HVdC
- –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ (0-100) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–Ω–∞
- –ß–∞—Å—Ç–æ—Ç–∞ —Å–∏–º–≤–æ–ª–æ–≤ ‚â• 2 –∏–∑ 5 —Å–Ω–æ–≤
- –≠–º–ø–∞—Ç–∏—á–Ω—ã–π —Ç–æ–Ω –±–µ–∑ –º–æ—Ä–∞–ª–∏–∑–∞—Ü–∏–∏

---

## –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–Ω–æ–≤

### –ü–æ–ª–Ω—ã–π Flow

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ù–∞–∂–∏–º–∞–µ—Ç "–í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑"
   ‚Üì
2. TMA ‚Üí performDeepAnalysis()
   ‚Üì
3. API /deep-analysis
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤
   ‚îú‚îÄ –°–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞
   ‚îú‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–Ω–æ–≤
   ‚îú‚îÄ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ (–æ—Ç —Å—Ç–∞—Ä–æ–≥–æ –∫ –Ω–æ–≤–æ–º—É)
   ‚îî‚îÄ Trigger background function
   ‚Üì
4. Return 202 Accepted
   ‚îú‚îÄ deepAnalysisProcessing = true
   ‚îî‚îÄ Start polling (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫)
   ‚Üì
5. Background function (deep-analysis-background.js)
   ‚îú‚îÄ –í—ã–∑–æ–≤ Gemini API (35-45 —Å–µ–∫)
   ‚îú‚îÄ –ü–∞—Ä—Å–∏–Ω–≥ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
   ‚îî‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   ‚Üì
6. Polling –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
   ‚îú‚îÄ deep_analyses_count —É–≤–µ–ª–∏—á–∏–ª—Å—è
   ‚îú‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ (fetchHistory)
   ‚îî‚îÄ deepAnalysisSuccess = true
   ‚Üì
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≥–æ—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
```

### Background Processing

**Netlify Functions Timeout:**
- –û–±—ã—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: 10-26 —Å–µ–∫—É–Ω–¥
- Background —Ñ—É–Ω–∫—Ü–∏–∏: –¥–æ **15 –º–∏–Ω—É—Ç**

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`netlify.toml`):
```toml
[functions]
  directory = "bot/functions"
  node_bundler = "esbuild"

[[functions]]
  path = "/deep-analysis-background"
  schedule = "manual"
```

**Trigger –º–µ—Ö–∞–Ω–∏–∑–º:**
```javascript
// deep-analysis.js
const backgroundUrl = `${NETLIFY_FUNCTIONS_URL}/deep-analysis-background`;
await fetch(backgroundUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        tgUserId,
        userDbId,
        chatId,
        combinedDreamsText,
        requiredDreams: 5,
        usedFree
    })
});
```

### Credit System

**–¢–∏–ø—ã –∫—Ä–µ–¥–∏—Ç–æ–≤:**
1. **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫—Ä–µ–¥–∏—Ç:** `free_deep_analysis = 1` (–≤—ã–¥–∞–µ—Ç—Å—è –ø—Ä–∏ 5 —Å–Ω–∞—Ö)
2. **–ü–ª–∞—Ç–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã:** `deep_analysis_credits` (–ø–æ–∫—É–ø–∫–∞ –∑–∞ 1 ‚≠êÔ∏è)

**Rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ:**
```javascript
try {
    const analysis = await geminiService.deepAnalyzeDreamsJSON(...);
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
} catch (error) {
    // Rollback –∫—Ä–µ–¥–∏—Ç–∞
    if (usedFree) {
        await supabase.rpc('restore_free_deep_credit', { user_tg_id });
    } else {
        await supabase.rpc('increment_deep_analysis_credits', { 
            user_tg_id, 
            amount: 1 
        });
    }
    throw error;
}
```

### UX Optimizations (–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ß–∞—Å—Ç—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. **–£–±—Ä–∞–Ω–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è fetchProfile()** –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
2. **Polling –∏—Å–ø–æ–ª—å–∑—É–µ—Ç getUserProfileFresh()** –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ fetchProfile()
3. **–ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ** –∫–æ–≥–¥–∞ `deep_analyses_count` —É–≤–µ–ª–∏—á–∏–ª—Å—è
4. **–£–¥–∞–ª–µ–Ω—ã snackbar —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - —Ç–æ–ª—å–∫–æ –±–∞–Ω–Ω–µ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
5. **–§–ª–∞–≥ deepAnalysisProcessing** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

```javascript
// –î–æ
performDeepAnalysis() {
    await api.getDeepAnalysis();
    await this.fetchProfile();        // ‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
    this.notificationStore.success(); // ‚ùå Snackbar
}

// –ü–æ—Å–ª–µ
performDeepAnalysis() {
    await api.getDeepAnalysis();
    this.deepAnalysisProcessing = true;  // ‚úÖ –§–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    this.startDeepAnalysisPolling();     // ‚úÖ Polling
}

startDeepAnalysisPolling() {
    setInterval(async () => {
        const { data: freshProfile } = await api.getUserProfileFresh();
        if (freshProfile.deep_analyses_count > initialCount) {
            await this.fetchHistory();       // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å
            this.deepAnalysisSuccess = true; // ‚úÖ –ë–∞–Ω–Ω–µ—Ä
            this.deepAnalysisProcessing = false;
        }
    }, 10000);
}
```

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –û–∫—Ç—è–±—Ä—å 2025

#### 19.10.2025 - Session 3: UX Improvements & Documentation

**1. –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ Gemini API** (PR #8)
- **–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ 5 —Å–Ω–æ–≤ –¥–∞–≤–∞–ª–∏ —Ä–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ
- **–ü—Ä–∏—á–∏–Ω–∞:** –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Gemini (temperature > 0) - —Å–ª—É—á–∞–π–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- **–†–µ—à–µ–Ω–∏–µ:**
  ```javascript
  generationConfig: {
      temperature: 0,      // –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥
      topK: 1,            // –¢–æ–ª—å–∫–æ —Å–∞–º—ã–π –≤–µ—Ä–æ—è—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω
      topP: 0.1,          // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å
  }
  ```
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–µ –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã
- **–¢–µ—Å—Ç—ã:** ‚úÖ 28/28 passed

**2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∏—Å—Ç–æ—Ä–∏–∏ - –¢–∞–±—ã –≤–º–µ—Å—Ç–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞** (PR #9)
- **–†–µ—Ñ–µ—Ä–µ–Ω—Å:** –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –¥–∏–∑–∞–π–Ω —Å –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ–º –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞–±–∞
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
  - –£–¥–∞–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–ò—Å—Ç–æ—Ä–∏—è" + dropdown —Å–µ–ª–µ–∫—Ç–æ—Ä
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±—ã: "–î–Ω–µ–≤–Ω–∏–∫ —Å–Ω–æ–≤" | "–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑"
  - –ê–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±: –±–µ–ª—ã–π —Ü–≤–µ—Ç + –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ (0.5px)
  - –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±: –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—ã–π (40% opacity) + hover (60%)
  - –ü–ª–∞–≤–Ω—ã–µ transition –∞–Ω–∏–º–∞—Ü–∏–∏ (200ms)
- **–§–∞–π–ª—ã:** `tma/src/components/AnalysisHistoryList.vue`

**3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞**
- –°–æ–∑–¥–∞–Ω `PROJECT_GUIDE.md` - comprehensive —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- –°–æ–±—Ä–∞–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –≤—Å–µ—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–µ—Å—Å–∏–π
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, —Ñ—É–Ω–∫—Ü–∏–∏, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ best practices

#### 18.10.2025 - Session 2: Deep Analysis Optimization

**1. Background Functions –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞**
- **–ü—Ä–æ–±–ª–µ–º–∞:** Netlify Functions timeout (10-26 —Å–µ–∫) vs Gemini –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (35-45 —Å–µ–∫)
- **–†–µ—à–µ–Ω–∏–µ:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å background —Ñ—É–Ω–∫—Ü–∏—è–º–∏ (–¥–æ 15 –º–∏–Ω—É—Ç)
  - `deep-analysis.js` - trigger (202 Accepted)
  - `deep-analysis-background.js` - long-running processing
- **–ú–µ—Ö–∞–Ω–∏–∑–º:**
  - –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç 202
  - Background –æ–±—Ä–∞–±–æ—Ç–∫–∞
  - Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
  - Polling –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**2. Credit Rollback –º–µ—Ö–∞–Ω–∏–∑–º**
- SQL —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö:
  - `increment_deep_analysis_credits(user_tg_id, amount)`
  - `restore_free_deep_credit(user_tg_id)`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ —Å–±–æ–µ Gemini API

**3. –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞**
- **–ù–æ–≤—ã–µ –ø–æ–ª—è –≤ deep_json:**
  - `symbolsIntro` - –≤–≤–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –æ —Å–∏–º–≤–æ–ª–∞—Ö
  - `recurringSymbols` - –º–∞—Å—Å–∏–≤ —Å frequency, description, userContext
  - `dynamicsContext` - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ HVdC —Å analysis –∏ insight
  - `conclusion` - –µ–¥–∏–Ω—ã–π –±–ª–æ–∫ —Å —Ç–µ–º–∞–º–∏, —Ñ—É–Ω–∫—Ü–∏—è–º–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ–º
- **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
  - Collapsible blocks –¥–ª—è —Å–∏–º–≤–æ–ª–æ–≤ –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
  - DynamicsChart —Å pagination –∏ swipe
  - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

**4. –§–∏–∫—Å—ã UI –∏ –¥–∞–Ω–Ω—ã—Ö**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–∞—Å—à—Ç–∞–± dynamicsContext: 0-10 ‚Üí 0-100% (HVdC –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è Y-axis –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã —Å—Ç–∏–ª–∏ –±–ª–æ–∫–æ–≤ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö

**5. UX –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**
- –£–¥–∞–ª–µ–Ω—ã —á–∞—Å—Ç—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏
- Polling –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –£–±—Ä–∞–Ω—ã snackbar —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Üí —Ç–æ–ª—å–∫–æ –±–∞–Ω–Ω–µ—Ä—ã
- –§–ª–∞–≥ `deepAnalysisProcessing` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

#### –†–∞–Ω–µ–µ (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–µ—Å—Å–∏–π)

**–ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Telegram Bot (Grammy.js)
- ‚úÖ TMA –∏ Web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Vue.js)
- ‚úÖ Google Gemini AI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–Ω–æ–≤
- ‚úÖ HVdC –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- ‚úÖ Supabase –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ (Telegram Stars)
- ‚úÖ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è Web
- ‚úÖ Cache —Å–∏—Å—Ç–µ–º–∞
- ‚úÖ Error handling –∏ logging

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—Ä–æ–µ–∫—Ç–æ–º

### –î–ª—è Droid AI

**–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:**

1. **–ò–∑—É—á–∏—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `PROJECT_GUIDE.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
   - –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ `ARCHITECTURE.md` –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
   - –ò–∑—É—á–∏—Ç–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

2. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:**
   ```
   1. –ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏
   2. –ü–ª–∞–Ω –∏–∑–º–µ–Ω–µ–Ω–∏–π (TODO list)
   3. –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
   4. –í–Ω–µ—Å–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (npm run build)
   6. –°–æ–∑–¥–∞–Ω–∏–µ PR —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
   7. Merge –≤ main
   ```

3. **Best Practices:**
   - ‚úÖ –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ feature branch
   - ‚úÖ –ó–∞–ø—É—Å–∫–∞–π—Ç–µ build —Ç–µ—Å—Ç—ã –ø–µ—Ä–µ–¥ PR
   - ‚úÖ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ PR –æ–ø–∏—Å–∞–Ω–∏—è
   - ‚úÖ –û–±–Ω–æ–≤–ª—è–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–∏ –∑–Ω–∞—á–∏–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ TODO list –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
   - ‚úÖ Merge –≤ main –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ build

4. **–ß–∞—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏:**

   **–ò–∑–º–µ–Ω–µ–Ω–∏–µ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:**
   ```bash
   1. git checkout -b feature/ui-update
   2. –ò–∑–º–µ–Ω–∏—Ç—å tma/src/components/ComponentName.vue
   3. cd tma && npm run build
   4. git add + commit + push
   5. gh pr create + merge
   ```

   **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Backend —Ñ—É–Ω–∫—Ü–∏–∏:**
   ```bash
   1. git checkout -b feature/backend-update
   2. –ò–∑–º–µ–Ω–∏—Ç—å bot/functions/function-name.js
   3. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –æ–±–Ω–æ–≤–∏—Ç—å shared services
   4. npm test (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç—ã)
   5. git add + commit + push + PR
   ```

   **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ Gemini:**
   ```bash
   1. –ò–∑–º–µ–Ω–∏—Ç—å bot/functions/shared/prompts/dream-prompts.js
   2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
   3. –î–µ–ø–ª–æ–π ‚Üí —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ production
   ```

### –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –≤ deep analysis**
```javascript
// 1. –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç
bot/functions/shared/prompts/dream-prompts.js
// –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É deep_json

// 2. –û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
bot/functions/deep-analysis-background.js
// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ deep_source

// 3. –û–±–Ω–æ–≤–∏—Ç—å frontend
tma/src/components/DreamCard.vue
// –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ UI
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞**
```javascript
// 1. –ù–∞–π—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
tma/src/components/ComponentName.vue

// 2. –ò–∑–º–µ–Ω–∏—Ç—å CSS/Tailwind –∫–ª–∞—Å—Å—ã
<div class="new-classes">

// 3. Build test
cd tma && npm run build

// 4. Deploy —á–µ—Ä–µ–∑ PR
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```javascript
// 1. –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —É–∑–∫–æ–µ –º–µ—Å—Ç–æ
// - Gemini API –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
// - –†–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤
// - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

// 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ
// - Background functions
// - –£–≤–µ–ª–∏—á–∏—Ç—å TTL –∫—ç—à–∞
// - –£–º–µ–Ω—å—à–∏—Ç—å payload

// 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
// - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Netlify Functions
// - –ò–∑–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
```

### Debugging

**Backend (Netlify Functions):**
```bash
# –õ–æ–≥–∏ –≤ Netlify Dashboard
https://app.netlify.com/sites/sparkling-cupcake-940504/logs

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
console.error('[FunctionName]', error);
```

**Frontend (TMA):**
```javascript
// Browser DevTools –≤ Telegram Desktop
// –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ console.log
console.log('[Component]', data);
```

**Database (Supabase):**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
SELECT * FROM users WHERE telegram_user_id = XXX;
SELECT * FROM deep_analyses ORDER BY created_at DESC LIMIT 5;
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# Frontend build
cd tma && npm run build
cd web && npm run build

# –¢–µ—Å—Ç—ã
npm test
npm test -- tests/gemini-service.test.js

# Git workflow
git checkout -b feature/name
git add .
git commit -m "feat: description"
git push -u origin feature/name
gh pr create --title "Title" --body "Description" --base main
gh pr merge NUMBER --merge --delete-branch

# Netlify CLI (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
netlify functions:list
netlify functions:invoke function-name
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `ARCHITECTURE.md` - –î–µ—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- `QUICK_START_GUIDE.md` - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- `ERROR_HANDLING_GUIDE.md` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- `DEPLOYMENT_INSTRUCTIONS.md` - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é

### API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- Gemini AI: https://ai.google.dev/docs
- Grammy.js: https://grammy.dev/
- Telegram Bot API: https://core.telegram.org/bots/api
- Telegram Mini Apps: https://core.telegram.org/bots/webapps
- Supabase: https://supabase.com/docs
- Netlify Functions: https://docs.netlify.com/functions/overview/

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- Netlify Dashboard: https://app.netlify.com/
- Supabase Dashboard: https://supabase.com/dashboard
- Telegram Bot: @BotFather

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–µ–∫—Ç–æ–º **Dream Analyzer**. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏–ª–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π - –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç.

**–î–ª—è Droid AI:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∫–∞–∫ reference –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ–µ–∫—Ç–æ–º. –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ best practices –æ–ø–∏—Å–∞–Ω—ã –∑–¥–µ—Å—å.

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 19.10.2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–ê–≤—Ç–æ—Ä:** Droid AI + Gleb Zhigulin
