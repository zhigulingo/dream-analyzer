import{d as Pe,r as ae,c as y,a,o as n,b as s,s as We,M as pt,w as mt,e as z,t as S,F as X,A as re,n as ye,m as ht,u as vt,N as yt,k as Ee,C as le,l as Se,q as je,f as qe,D as gt,z as Ue,O as xt,P as _t,j as bt}from"./main-pKPFPzmm.js";import{c as Oe,g as Ye}from"./_commonjsHelpers-Cpj98o6Y.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";var Be={exports:{}},Ge;function Ke(){return Ge||(Ge=1,function(q,K){(function(u,W){q.exports=W()})(Oe,function(){var u=1e3,W=6e4,G=36e5,F="millisecond",h="second",I="minute",M="hour",O="day",H="week",B="month",Y="quarter",N="year",m="date",d="Invalid Date",_=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,$=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,p={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(k){var o=["th","st","nd","rd"],c=k%100;return"["+k+(o[(c-20)%10]||o[c]||o[0])+"]"}},C=function(k,o,c){var v=String(k);return!v||v.length>=o?k:""+Array(o+1-v.length).join(c)+k},A={s:C,z:function(k){var o=-k.utcOffset(),c=Math.abs(o),v=Math.floor(c/60),f=c%60;return(o<=0?"+":"-")+C(v,2,"0")+":"+C(f,2,"0")},m:function k(o,c){if(o.date()<c.date())return-k(c,o);var v=12*(c.year()-o.year())+(c.month()-o.month()),f=o.clone().add(v,B),D=c-f<0,L=o.clone().add(v+(D?-1:1),B);return+(-(v+(c-f)/(D?f-L:L-f))||0)},a:function(k){return k<0?Math.ceil(k)||0:Math.floor(k)},p:function(k){return{M:B,y:N,w:H,d:O,D:m,h:M,m:I,s:h,ms:F,Q:Y}[k]||String(k||"").toLowerCase().replace(/s$/,"")},u:function(k){return k===void 0}},g="en",x={};x[g]=p;var R="$isDayjsObject",te=function(k){return k instanceof ge||!(!k||!k[R])},se=function k(o,c,v){var f;if(!o)return g;if(typeof o=="string"){var D=o.toLowerCase();x[D]&&(f=D),c&&(x[D]=c,f=D);var L=o.split("-");if(!f&&L.length>1)return k(L[0])}else{var P=o.name;x[P]=o,f=P}return!v&&f&&(g=f),f||!v&&g},E=function(k,o){if(te(k))return k.clone();var c=typeof o=="object"?o:{};return c.date=k,c.args=arguments,new ge(c)},U=A;U.l=se,U.i=te,U.w=function(k,o){return E(k,{locale:o.$L,utc:o.$u,x:o.$x,$offset:o.$offset})};var ge=function(){function k(c){this.$L=se(c.locale,null,!0),this.parse(c),this.$x=this.$x||c.x||{},this[R]=!0}var o=k.prototype;return o.parse=function(c){this.$d=function(v){var f=v.date,D=v.utc;if(f===null)return new Date(NaN);if(U.u(f))return new Date;if(f instanceof Date)return new Date(f);if(typeof f=="string"&&!/Z$/i.test(f)){var L=f.match(_);if(L){var P=L[2]-1||0,V=(L[7]||"0").substring(0,3);return D?new Date(Date.UTC(L[1],P,L[3]||1,L[4]||0,L[5]||0,L[6]||0,V)):new Date(L[1],P,L[3]||1,L[4]||0,L[5]||0,L[6]||0,V)}}return new Date(f)}(c),this.init()},o.init=function(){var c=this.$d;this.$y=c.getFullYear(),this.$M=c.getMonth(),this.$D=c.getDate(),this.$W=c.getDay(),this.$H=c.getHours(),this.$m=c.getMinutes(),this.$s=c.getSeconds(),this.$ms=c.getMilliseconds()},o.$utils=function(){return U},o.isValid=function(){return this.$d.toString()!==d},o.isSame=function(c,v){var f=E(c);return this.startOf(v)<=f&&f<=this.endOf(v)},o.isAfter=function(c,v){return E(c)<this.startOf(v)},o.isBefore=function(c,v){return this.endOf(v)<E(c)},o.$g=function(c,v,f){return U.u(c)?this[v]:this.set(f,c)},o.unix=function(){return Math.floor(this.valueOf()/1e3)},o.valueOf=function(){return this.$d.getTime()},o.startOf=function(c,v){var f=this,D=!!U.u(v)||v,L=U.p(c),P=function(he,ie){var oe=U.w(f.$u?Date.UTC(f.$y,ie,he):new Date(f.$y,ie,he),f);return D?oe:oe.endOf(O)},V=function(he,ie){return U.w(f.toDate()[he].apply(f.toDate("s"),(D?[0,0,0,0]:[23,59,59,999]).slice(ie)),f)},ee=this.$W,Q=this.$M,ne=this.$D,pe="set"+(this.$u?"UTC":"");switch(L){case N:return D?P(1,0):P(31,11);case B:return D?P(1,Q):P(0,Q+1);case H:var me=this.$locale().weekStart||0,xe=(ee<me?ee+7:ee)-me;return P(D?ne-xe:ne+(6-xe),Q);case O:case m:return V(pe+"Hours",0);case M:return V(pe+"Minutes",1);case I:return V(pe+"Seconds",2);case h:return V(pe+"Milliseconds",3);default:return this.clone()}},o.endOf=function(c){return this.startOf(c,!1)},o.$set=function(c,v){var f,D=U.p(c),L="set"+(this.$u?"UTC":""),P=(f={},f[O]=L+"Date",f[m]=L+"Date",f[B]=L+"Month",f[N]=L+"FullYear",f[M]=L+"Hours",f[I]=L+"Minutes",f[h]=L+"Seconds",f[F]=L+"Milliseconds",f)[D],V=D===O?this.$D+(v-this.$W):v;if(D===B||D===N){var ee=this.clone().set(m,1);ee.$d[P](V),ee.init(),this.$d=ee.set(m,Math.min(this.$D,ee.daysInMonth())).$d}else P&&this.$d[P](V);return this.init(),this},o.set=function(c,v){return this.clone().$set(c,v)},o.get=function(c){return this[U.p(c)]()},o.add=function(c,v){var f,D=this;c=Number(c);var L=U.p(v),P=function(Q){var ne=E(D);return U.w(ne.date(ne.date()+Math.round(Q*c)),D)};if(L===B)return this.set(B,this.$M+c);if(L===N)return this.set(N,this.$y+c);if(L===O)return P(1);if(L===H)return P(7);var V=(f={},f[I]=W,f[M]=G,f[h]=u,f)[L]||1,ee=this.$d.getTime()+c*V;return U.w(ee,this)},o.subtract=function(c,v){return this.add(-1*c,v)},o.format=function(c){var v=this,f=this.$locale();if(!this.isValid())return f.invalidDate||d;var D=c||"YYYY-MM-DDTHH:mm:ssZ",L=U.z(this),P=this.$H,V=this.$m,ee=this.$M,Q=f.weekdays,ne=f.months,pe=f.meridiem,me=function(ie,oe,_e,ke){return ie&&(ie[oe]||ie(v,D))||_e[oe].slice(0,ke)},xe=function(ie){return U.s(P%12||12,ie,"0")},he=pe||function(ie,oe,_e){var ke=ie<12?"AM":"PM";return _e?ke.toLowerCase():ke};return D.replace($,function(ie,oe){return oe||function(_e){switch(_e){case"YY":return String(v.$y).slice(-2);case"YYYY":return U.s(v.$y,4,"0");case"M":return ee+1;case"MM":return U.s(ee+1,2,"0");case"MMM":return me(f.monthsShort,ee,ne,3);case"MMMM":return me(ne,ee);case"D":return v.$D;case"DD":return U.s(v.$D,2,"0");case"d":return String(v.$W);case"dd":return me(f.weekdaysMin,v.$W,Q,2);case"ddd":return me(f.weekdaysShort,v.$W,Q,3);case"dddd":return Q[v.$W];case"H":return String(P);case"HH":return U.s(P,2,"0");case"h":return xe(1);case"hh":return xe(2);case"a":return he(P,V,!0);case"A":return he(P,V,!1);case"m":return String(V);case"mm":return U.s(V,2,"0");case"s":return String(v.$s);case"ss":return U.s(v.$s,2,"0");case"SSS":return U.s(v.$ms,3,"0");case"Z":return L}return null}(ie)||L.replace(":","")})},o.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},o.diff=function(c,v,f){var D,L=this,P=U.p(v),V=E(c),ee=(V.utcOffset()-this.utcOffset())*W,Q=this-V,ne=function(){return U.m(L,V)};switch(P){case N:D=ne()/12;break;case B:D=ne();break;case Y:D=ne()/3;break;case H:D=(Q-ee)/6048e5;break;case O:D=(Q-ee)/864e5;break;case M:D=Q/G;break;case I:D=Q/W;break;case h:D=Q/u;break;default:D=Q}return f?D:U.a(D)},o.daysInMonth=function(){return this.endOf(B).$D},o.$locale=function(){return x[this.$L]},o.locale=function(c,v){if(!c)return this.$L;var f=this.clone(),D=se(c,v,!0);return D&&(f.$L=D),f},o.clone=function(){return U.w(this.$d,this)},o.toDate=function(){return new Date(this.valueOf())},o.toJSON=function(){return this.isValid()?this.toISOString():null},o.toISOString=function(){return this.$d.toISOString()},o.toString=function(){return this.$d.toUTCString()},k}(),$e=ge.prototype;return E.prototype=$e,[["$ms",F],["$s",h],["$m",I],["$H",M],["$W",O],["$M",B],["$y",N],["$D",m]].forEach(function(k){$e[k[1]]=function(o){return this.$g(o,k[0],k[1])}}),E.extend=function(k,o){return k.$i||(k(o,ge,E),k.$i=!0),E},E.locale=se,E.isDayjs=te,E.unix=function(k){return E(1e3*k)},E.en=x[g],E.Ls=x,E.p={},E})}(Be)),Be.exports}var wt=Ke();const we=Ye(wt);var Qe={exports:{}};(function(q,K){(function(u,W){q.exports=W()})(Oe,function(){return function(u,W,G){u=u||{};var F=W.prototype,h={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function I(O,H,B,Y){return F.fromToBase(O,H,B,Y)}G.en.relativeTime=h,F.fromToBase=function(O,H,B,Y,N){for(var m,d,_,$=B.$locale().relativeTime||h,p=u.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],C=p.length,A=0;A<C;A+=1){var g=p[A];g.d&&(m=Y?G(O).diff(B,g.d,!0):B.diff(O,g.d,!0));var x=(u.rounding||Math.round)(Math.abs(m));if(_=m>0,x<=g.r||!g.r){x<=1&&A>0&&(g=p[A-1]);var R=$[g.l];N&&(x=N(""+x)),d=typeof R=="string"?R.replace("%d",x):R(x,H,g.l,_);break}}if(H)return d;var te=_?$.future:$.past;return typeof te=="function"?te(d):te.replace("%s",d)},F.to=function(O,H){return I(O,H,this,!0)},F.from=function(O,H){return I(O,H,this)};var M=function(O){return O.$u?G.utc():G()};F.toNow=function(O){return this.to(M(this),O)},F.fromNow=function(O){return this.from(M(this),O)}}})})(Qe);var $t=Qe.exports;const kt=Ye($t);var et={exports:{}};(function(q,K){(function(u,W){q.exports=W()})(Oe,function(){var u="minute",W=/[+-]\d\d(?::?\d\d)?/g,G=/([+-]|\d\d)/g;return function(F,h,I){var M=h.prototype;I.utc=function(d){var _={date:d,utc:!0,args:arguments};return new h(_)},M.utc=function(d){var _=I(this.toDate(),{locale:this.$L,utc:!0});return d?_.add(this.utcOffset(),u):_},M.local=function(){return I(this.toDate(),{locale:this.$L,utc:!1})};var O=M.parse;M.parse=function(d){d.utc&&(this.$u=!0),this.$utils().u(d.$offset)||(this.$offset=d.$offset),O.call(this,d)};var H=M.init;M.init=function(){if(this.$u){var d=this.$d;this.$y=d.getUTCFullYear(),this.$M=d.getUTCMonth(),this.$D=d.getUTCDate(),this.$W=d.getUTCDay(),this.$H=d.getUTCHours(),this.$m=d.getUTCMinutes(),this.$s=d.getUTCSeconds(),this.$ms=d.getUTCMilliseconds()}else H.call(this)};var B=M.utcOffset;M.utcOffset=function(d,_){var $=this.$utils().u;if($(d))return this.$u?0:$(this.$offset)?B.call(this):this.$offset;if(typeof d=="string"&&(d=function(g){g===void 0&&(g="");var x=g.match(W);if(!x)return null;var R=(""+x[0]).match(G)||["-",0,0],te=R[0],se=60*+R[1]+ +R[2];return se===0?0:te==="+"?se:-se}(d),d===null))return this;var p=Math.abs(d)<=16?60*d:d;if(p===0)return this.utc(_);var C=this.clone();if(_)return C.$offset=p,C.$u=!1,C;var A=this.$u?this.toDate().getTimezoneOffset():-1*this.utcOffset();return(C=this.local().add(p+A,u)).$offset=p,C.$x.$localOffset=A,C};var Y=M.format;M.format=function(d){var _=d||(this.$u?"YYYY-MM-DDTHH:mm:ss[Z]":"");return Y.call(this,_)},M.valueOf=function(){var d=this.$utils().u(this.$offset)?0:this.$offset+(this.$x.$localOffset||this.$d.getTimezoneOffset());return this.$d.valueOf()-6e4*d},M.isUTC=function(){return!!this.$u},M.toISOString=function(){return this.toDate().toISOString()},M.toString=function(){return this.toDate().toUTCString()};var N=M.toDate;M.toDate=function(d){return d==="s"&&this.$offset?I(this.format("YYYY-MM-DD HH:mm:ss:SSS")).toDate():N.call(this)};var m=M.diff;M.diff=function(d,_,$){if(d&&this.$u===d.$u)return m.call(this,d,_,$);var p=this.local(),C=I(d).local();return m.call(p,C,_,$)}}})})(et);var Mt=et.exports;const St=Ye(Mt);var tt={exports:{}};(function(q,K){(function(u,W){q.exports=W()})(Oe,function(){var u={year:0,month:1,day:2,hour:3,minute:4,second:5},W={};return function(G,F,h){var I,M=function(Y,N,m){m===void 0&&(m={});var d=new Date(Y),_=function($,p){p===void 0&&(p={});var C=p.timeZoneName||"short",A=$+"|"+C,g=W[A];return g||(g=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:$,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:C}),W[A]=g),g}(N,m);return _.formatToParts(d)},O=function(Y,N){for(var m=M(Y,N),d=[],_=0;_<m.length;_+=1){var $=m[_],p=$.type,C=$.value,A=u[p];A>=0&&(d[A]=parseInt(C,10))}var g=d[3],x=g===24?0:g,R=d[0]+"-"+d[1]+"-"+d[2]+" "+x+":"+d[4]+":"+d[5]+":000",te=+Y;return(h.utc(R).valueOf()-(te-=te%1e3))/6e4},H=F.prototype;H.tz=function(Y,N){Y===void 0&&(Y=I);var m,d=this.utcOffset(),_=this.toDate(),$=_.toLocaleString("en-US",{timeZone:Y}),p=Math.round((_-new Date($))/1e3/60),C=15*-Math.round(_.getTimezoneOffset()/15)-p;if(!Number(C))m=this.utcOffset(0,N);else if(m=h($,{locale:this.$L}).$set("millisecond",this.$ms).utcOffset(C,!0),N){var A=m.utcOffset();m=m.add(d-A,"minute")}return m.$x.$timezone=Y,m},H.offsetName=function(Y){var N=this.$x.$timezone||h.tz.guess(),m=M(this.valueOf(),N,{timeZoneName:Y}).find(function(d){return d.type.toLowerCase()==="timezonename"});return m&&m.value};var B=H.startOf;H.startOf=function(Y,N){if(!this.$x||!this.$x.$timezone)return B.call(this,Y,N);var m=h(this.format("YYYY-MM-DD HH:mm:ss:SSS"),{locale:this.$L});return B.call(m,Y,N).tz(this.$x.$timezone,!0)},h.tz=function(Y,N,m){var d=m&&N,_=m||N||I,$=O(+h(),_);if(typeof Y!="string")return h(Y).tz(_);var p=function(x,R,te){var se=x-60*R*1e3,E=O(se,te);if(R===E)return[se,R];var U=O(se-=60*(E-R)*1e3,te);return E===U?[se,E]:[x-60*Math.min(E,U)*1e3,Math.max(E,U)]}(h.utc(Y,d).valueOf(),$,_),C=p[0],A=p[1],g=h(C).utcOffset(A);return g.$x.$timezone=_,g},h.tz.guess=function(){return Intl.DateTimeFormat().resolvedOptions().timeZone},h.tz.setDefault=function(Y){I=Y}}})})(tt);var Dt=tt.exports;const Ct=Ye(Dt);var Tt={exports:{}};(function(q,K){(function(u,W){q.exports=W(Ke())})(Oe,function(u){function W(m){return m&&typeof m=="object"&&"default"in m?m:{default:m}}var G=W(u),F="января_февраля_марта_апреля_мая_июня_июля_августа_сентября_октября_ноября_декабря".split("_"),h="январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_"),I="янв._февр._мар._апр._мая_июня_июля_авг._сент._окт._нояб._дек.".split("_"),M="янв._февр._март_апр._май_июнь_июль_авг._сент._окт._нояб._дек.".split("_"),O=/D[oD]?(\[[^[\]]*\]|\s)+MMMM?/;function H(m,d,_){var $,p;return _==="m"?d?"минута":"минуту":m+" "+($=+m,p={mm:d?"минута_минуты_минут":"минуту_минуты_минут",hh:"час_часа_часов",dd:"день_дня_дней",MM:"месяц_месяца_месяцев",yy:"год_года_лет"}[_].split("_"),$%10==1&&$%100!=11?p[0]:$%10>=2&&$%10<=4&&($%100<10||$%100>=20)?p[1]:p[2])}var B=function(m,d){return O.test(d)?F[m.month()]:h[m.month()]};B.s=h,B.f=F;var Y=function(m,d){return O.test(d)?I[m.month()]:M[m.month()]};Y.s=M,Y.f=I;var N={name:"ru",weekdays:"воскресенье_понедельник_вторник_среда_четверг_пятница_суббота".split("_"),weekdaysShort:"вск_пнд_втр_срд_чтв_птн_сбт".split("_"),weekdaysMin:"вс_пн_вт_ср_чт_пт_сб".split("_"),months:B,monthsShort:Y,weekStart:1,yearStart:4,formats:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY г.",LLL:"D MMMM YYYY г., H:mm",LLLL:"dddd, D MMMM YYYY г., H:mm"},relativeTime:{future:"через %s",past:"%s назад",s:"несколько секунд",m:H,mm:H,h:"час",hh:H,d:"день",dd:H,M:"месяц",MM:H,y:"год",yy:H},ordinal:function(m){return m},meridiem:function(m){return m<4?"ночи":m<12?"утра":m<17?"дня":"вечера"}};return G.default.locale(N,null,!0),N})})(Tt);const Ht={class:"dynamics-chart-container"},Ot={class:"text-sm font-semibold mb-2 flex items-center justify-between"},At={class:"text-xs opacity-70"},Lt={class:"chart-svg-container"},jt={class:"y-axis-labels"},Yt={class:"y-label"},zt={class:"y-label"},Ft={class:"y-label"},Nt={class:"chart-svg-wrapper"},It=["viewBox"],Ut=["y1","y2"],Bt=["y"],Wt=["y1","y2"],Et=["points"],Pt=["cx","cy"],Vt={key:0,class:"mt-4"},Rt={class:"dynamics-analysis"},Zt={class:"analysis-text"},qt={key:0,class:"insight-box"},Gt={class:"insight-text"},Jt={key:1,class:"mt-3 text-xs opacity-80 leading-relaxed"},Xt={class:"pagination-dots"},Kt=["onClick"],Te=300,He=80,De=6,Qt=Pe({__name:"DynamicsChart",props:{dynamics:{},userAge:{},userGender:{}},setup(q){const K=q,u=ae(0),W=ae(0),G=ae(0),F=ae("slide-left"),h=y(()=>K.dynamics[u.value]||{metric:"",values:[],interpretation:""}),I=y(()=>h.value.values||[]),M=y(()=>{if(!K.dynamics||K.dynamics.length===0)return{min:0,max:10,labels:[10,5,0]};const p=[];if(K.dynamics.forEach(x=>{Array.isArray(x.values)&&p.push(...x.values)}),p.length===0)return{min:0,max:10,labels:[10,5,0]};const C=Math.floor(Math.min(...p)),A=Math.ceil(Math.max(...p)),g=[A,Math.round((A+C)/2),C];return{min:C,max:A,labels:g}}),O=y(()=>{var x;const p=h.value.metric;if(!K.userAge||!K.userGender)return null;const A=(x={Персонажи:{"18-24":{male:6.5,female:7},"25-34":{male:6,female:6.5},"35-44":{male:5.5,female:6},"45+":{male:5,female:5.5}},Эмоции:{"18-24":{male:6,female:7},"25-34":{male:5.5,female:6.5},"35-44":{male:5,female:6},"45+":{male:4.5,female:5.5}},Действия:{"18-24":{male:7,female:6.5},"25-34":{male:6.5,female:6},"35-44":{male:6,female:5.5},"45+":{male:5.5,female:5}},Сцены:{"18-24":{male:6.5,female:6.5},"25-34":{male:6,female:6},"35-44":{male:5.5,female:5.5},"45+":{male:5,female:5}}}[p])==null?void 0:x[K.userAge];if(!A)return null;const g=A[K.userGender];return g===void 0?null:g}),H=y(()=>{const p=O.value;if(p===null)return null;const{min:C,max:A}=M.value,g=He-De*2,x=(p-C)/(A-C);return De+g-x*g}),B=y(()=>{const p=I.value;if(p.length===0)return[];const{min:C,max:A}=M.value,g=Te-De*2,x=He-De*2,R=p.length>1?g/(p.length-1):0;return p.map((te,se)=>{const E=(te-C)/(A-C);return{x:De+se*R,y:De+x-E*x}})}),Y=y(()=>B.value.map(p=>`${p.x},${p.y}`).join(" "));function N(p){W.value=p.touches[0].clientX}function m(p){G.value=p.touches[0].clientX}function d(){const p=W.value-G.value;Math.abs(p)>50&&(p>0&&u.value<K.dynamics.length-1?(F.value="slide-left",u.value++,$()):p<0&&u.value>0&&(F.value="slide-right",u.value--,$())),W.value=0,G.value=0}function _(p){p!==u.value&&(F.value=p>u.value?"slide-left":"slide-right",u.value=p,$())}function $(){window.triggerHaptic&&window.triggerHaptic("light")}return(p,C)=>(n(),a("div",Ht,[s("div",{class:"chart-wrapper",onTouchstart:N,onTouchmove:m,onTouchend:d},[We(pt,{name:F.value,mode:"out-in"},{default:mt(()=>[(n(),a("div",{key:u.value,class:"chart-content"},[s("div",Ot,[s("span",null,S(h.value.category||h.value.metric),1),s("span",At,S(I.value[I.value.length-1]),1)]),s("div",Lt,[s("div",jt,[s("span",Yt,S(M.value.labels[0]),1),s("span",zt,S(M.value.labels[1]),1),s("span",Ft,S(M.value.labels[2]),1)]),s("div",Nt,[(n(),a("svg",{viewBox:`0 0 ${Te} ${He}`,class:"chart-svg",preserveAspectRatio:"xMidYMid meet"},[(n(),a(X,null,re(3,A=>s("line",{key:`grid-${A}`,x1:0,x2:Te,y1:He/2*(A-1),y2:He/2*(A-1),stroke:"white","stroke-opacity":"0.15","stroke-width":"1"},null,8,Ut)),64)),H.value!==null?(n(),a("rect",{key:0,x:0,y:H.value-8,width:Te,height:16,fill:"yellow",opacity:"0.15"},null,8,Bt)):z("",!0),H.value!==null?(n(),a("line",{key:1,x1:0,x2:Te,y1:H.value,y2:H.value,stroke:"yellow","stroke-opacity":"0.6","stroke-width":"1.5","stroke-dasharray":"4,3"},null,8,Wt)):z("",!0),s("polyline",{points:Y.value,fill:"none",stroke:"white","stroke-width":"2.5","stroke-linejoin":"round","stroke-linecap":"round"},null,8,Et),(n(!0),a(X,null,re(B.value,(A,g)=>(n(),a("circle",{key:`point-${g}`,cx:A.x,cy:A.y,r:"4",fill:"white","vector-effect":"non-scaling-stroke"},null,8,Pt))),128))],8,It))])]),h.value.analysis?(n(),a("div",Vt,[s("div",Rt,[s("p",Zt,S(h.value.analysis),1),h.value.insight?(n(),a("div",qt,[C[0]||(C[0]=s("span",{class:"insight-icon"},"💡",-1)),s("p",Gt,S(h.value.insight),1)])):z("",!0)])])):h.value.interpretation?(n(),a("div",Jt,S(h.value.interpretation),1)):z("",!0)]))]),_:1},8,["name"])],32),s("div",Xt,[(n(!0),a(X,null,re(q.dynamics,(A,g)=>(n(),a("button",{key:`dot-${g}`,class:ye(["dot",{active:g===u.value}]),onClick:x=>_(g)},null,10,Kt))),128))])]))}}),Je=Ve(Qt,[["__scopeId","data-v-ac484404"]]),es={class:"flex justify-between items-center py-2 min-h-[2.5rem]"},ts={class:"truncate"},ss={class:"bg-white/10 rounded-full px-2 py-1 text-sm min-w-[3rem] text-center whitespace-nowrap"},ns={key:0,class:"mt-4 space-y-4 text-sm fade-seq is-open"},is={key:0,class:"flex flex-wrap gap-2"},rs={key:0,class:"rounded-lg bg-white/10"},as={class:"opacity-80 inline-block",style:{fontSize:"130%"}},os={key:0,class:"px-3 pb-3 text-white/90 leading-snug space-y-4"},ls={key:0,class:"text-sm opacity-90 leading-relaxed pb-2 border-b border-white/10"},cs={class:"flex items-baseline gap-2"},us={class:"font-semibold text-sm"},ds={class:"text-xs opacity-70 bg-white/15 px-2 py-0.5 rounded-full"},fs={class:"text-xs opacity-90 leading-relaxed"},ps={class:"text-xs opacity-75 italic leading-relaxed bg-white/5 rounded px-2 py-1"},ms={key:1,class:"rounded-lg bg-white/10"},hs={class:"opacity-80 inline-block",style:{fontSize:"130%"}},vs={key:0,class:"px-3 pb-3 text-white/90 leading-snug"},ys={key:2,class:"rounded-lg bg-white/10"},gs={class:"opacity-80 inline-block",style:{fontSize:"130%"}},xs={key:0,class:"px-3 pb-3 text-white/90 leading-snug space-y-3"},_s={key:0,class:"text-sm opacity-90 leading-relaxed"},bs={key:1,class:"text-sm opacity-90 leading-relaxed"},ws={key:2,class:"text-sm opacity-90 leading-relaxed"},$s={key:3,class:"bg-white/10 rounded-lg p-3 space-y-2 mt-4"},ks={class:"font-semibold opacity-95 flex items-center gap-2"},Ms={class:"text-sm opacity-90 leading-relaxed"},Ss={key:0,class:"text-xs opacity-75 italic leading-relaxed"},Ds={class:"rounded-lg bg-white/10"},Cs={class:"px-3 pb-3 text-white/90 leading-snug space-y-2"},Ts=["innerHTML"],Hs={key:0,class:"rounded-lg bg-white/10"},Os={class:"px-3 pb-3"},As={class:"flex flex-wrap gap-2"},Ls={key:1,class:"rounded-lg bg-white/10"},js={class:"px-3 pb-3 text-white/90 leading-snug"},Ys={key:2,class:"rounded-lg bg-white/10"},zs={class:"px-3 pb-3 text-white/90 leading-snug"},Fs={class:"list-decimal pl-5 space-y-2"},Ns={key:3,class:"rounded-lg bg-white/10"},Is={class:"px-3 pb-3 text-white/90 leading-snug"},Us={class:"list-decimal pl-5 space-y-3"},Bs={key:0},Ws={class:"font-semibold mb-1"},Es={class:"opacity-90"},Ps={key:0,class:"opacity-80 mt-1 italic"},Vs={key:1},Rs={key:0,class:"rounded-lg bg-white/10"},Zs={class:"px-3 pb-3 text-white/90 leading-snug"},qs={class:"list-decimal pl-5 space-y-2"},Gs={key:1,class:"rounded-lg bg-white/10"},Js={class:"px-3 pb-3 text-white/90 leading-snug"},Xs={class:"list-decimal pl-5 space-y-3"},Ks={key:0},Qs={class:"font-semibold mb-1"},en={class:"opacity-90"},tn={key:0,class:"opacity-80 mt-1 italic"},sn={key:1},nn={class:"rounded-lg bg-white/10 border-l-4 border-pink-400"},rn={class:"px-3 pb-3 text-white/90 leading-snug"},an={class:"mt-2 flex justify-end"},on={class:"space-y-2"},ln=["onClick"],cn={class:"opacity-80 inline-block",style:{fontSize:"130%"}},un={key:0,class:"px-3 pb-3 text-white/90 leading-snug space-y-2"},dn=["innerHTML"],fn={key:0,class:"space-y-2"},pn={class:"flex justify-between text-xs opacity-80"},mn={class:"relative h-2 w-full bg-white/10 rounded overflow-hidden"},hn={class:"pt-2 text-xs opacity-80 flex flex-wrap items-center gap-4"},vn={class:"inline-flex items-center gap-2"},yn={class:"mt-4 flex gap-2"},gn={key:3,class:"mt-3 text-xs bg-black/20 rounded-lg p-2 font-mono whitespace-pre-wrap break-words"},xn={class:"mt-2 flex justify-end"},_n={key:0,class:"space-y-3"},bn={class:"grid grid-cols-2 gap-2"},wn=["onClick"],$n={class:"flex justify-end gap-2 pt-2"},kn=["disabled"],Mn={key:1,class:"space-y-3"},Sn={class:"grid grid-cols-2 gap-2"},Dn={class:"flex justify-end gap-2 pt-2"},Cn=["disabled"],Tn=48,Hn=Pe({__name:"DreamCard",props:{dream:{},active:{type:Boolean}},emits:["toggle"],setup(q,{emit:K}){we.extend(kt),we.locale("ru"),we.extend(St),we.extend(Ct);const u=q,W=K,G=()=>{W("toggle"),window.triggerHaptic&&window.triggerHaptic("light")},F=ht(),h=vt(),I=ae(!0),M=y(()=>{var e;return!!((e=u.dream)!=null&&e.is_deep_analysis)}),O=y({get:()=>{var e,t,i;return((e=u.dream)==null?void 0:e.user_feedback)??((i=(t=u.dream)==null?void 0:t.deep_source)==null?void 0:i.user_feedback)??0},set:e=>{u.dream&&(u.dream.user_feedback=e,u.dream.deep_source||(u.dream.deep_source={}),u.dream.deep_source.user_feedback=e)}}),H={like:!1,dislike:!1,delete:!1},B=async e=>{if(H.like||H.dislike)return;const t=e===1?O.value===1?0:1:O.value===2?0:2,i=O.value;O.value=t;try{window.triggerHaptic&&window.triggerHaptic("medium"),e===1?H.like=!0:H.dislike=!0,await Ue.postAnalysisFeedback(u.dream.id,t),t===0?h.info("Оценка снята"):t===1?h.success("Добавлено: нравится"):t===2&&h.success("Добавлено: не нравится")}catch(l){O.value=i,console.error("Feedback error",l),h.error("Не удалось сохранить оценку")}finally{H.like=H.dislike=!1}},Y=()=>B(1),N=()=>B(2),m=async()=>{var i;if(H.delete)return;const e=(i=window.Telegram)==null?void 0:i.WebApp;if(await new Promise(l=>{e!=null&&e.showPopup?e.showPopup({title:"Удалить запись?",message:"Действие необратимо",buttons:[{id:"yes",type:"destructive",text:"Удалить"},{id:"no",type:"cancel",text:"Отмена"}]},b=>l(b==="yes")):l(window.confirm("Удалить запись?"))}))try{H.delete=!0,window.triggerHaptic&&window.triggerHaptic("heavy"),await Ue.deleteAnalysis(u.dream.id);const l=F.history.findIndex(b=>b.id===u.dream.id);l>-1&&F.history.splice(l,1),F.fetchProfile(),h.success("Запись удалена")}catch(l){console.error("Delete error",l),h.error("Не удалось удалить запись")}finally{H.delete=!1}},d=new Set(["и","в","во","не","что","он","на","я","с","со","как","а","то","все","она","так","его","но","да","ты","к","у","же","вы","за","бы","по","ее","мне","было","вот","от","меня","еще","нет","о","из","ему","теперь","когда","даже","ну","вдруг","ли","если","уже","или","ни","быть","был","него","до","вас","нибудь","опять","уж","вам","ведь","там","потом","себя","ничего","ей","может","они","тут","где","есть","надо","ней","для","мы","тебя","их","чем","была","сам","чтоб","без","будто","чего","раз","тоже","себе","под","будет","ж","тогда","кто","этот","того","потому","этого","какой","совсем","ним","здесь","этом","один","почти","мой","тем","чтобы","нее","кажется","сейчас","были","куда","зачем","всех","никогда","можно","при","наконец","два","об","другой","хоть","после","над","больше","тот","через","эти","нас","про","всего","них","какая","много","разве","три","эту","моя","впрочем","хорошо","свою","этой","перед","иногда","лучше","чуть","том","нельзя","такой","им","более","всегда","конечно","всю","между"]);function _(e){return e.replace(/\s+/g," ").trim().split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function $(e){if(!e)return"";const t=String(e).split(/[.!?\n]/)[0],l=t.toLowerCase().replace(/[^\p{L}\p{N}\s-]/gu,"").split(/\s+/).filter(b=>b&&!d.has(b)&&b.length>3).slice(0,3);return l.length===0?t.slice(0,40):_(l.join(" "))}function p(e){if(!e)return"";let t=String(e).toLowerCase().replace(/["'«»]/g,"").trim();t=t.replace(/^(приснилось|снилось|сон о|сон про|сон|мне снится|мне приснилось)\s+/i,""),t=t.replace(/\s+/g," ").trim();const i=t.split(" ").filter(Boolean).slice(0,3);return i.length?i.join(" "):""}function C(e){if(!e)return"";const t=String(e).toLowerCase();return t.charAt(0).toUpperCase()+t.slice(1)}const A=y(()=>{var T,r,w,j,J;const e=p((r=(T=u.dream)==null?void 0:T.deep_source)==null?void 0:r.title);if(e)return C(e);const t=(((j=(w=u.dream)==null?void 0:w.deep_source)==null?void 0:j.tags)||[]).filter(Boolean),i=de=>{var fe;let ce=String(de||"").trim();return ce=((fe=ce.split(/[\\/,(;:—–-]/)[0])==null?void 0:fe.trim())||"",ce?ce.charAt(0).toUpperCase()+ce.slice(1).toLowerCase():""},l=t.map(i).filter(Boolean);if(l.length){const de=l.slice(0,2).join(" и ");return C(de||"Без названия")}const b=p($((J=u.dream)==null?void 0:J.dream_text));return C(b||"Без названия")}),g=y(()=>{var i,l;const e=(l=(i=u.dream)==null?void 0:i.deep_source)==null?void 0:l.tags;if(!Array.isArray(e))return[];const t=b=>{var r;let T=String(b||"").trim();return T=((r=T.split(/[\\/,(;:—–-]/)[0])==null?void 0:r.trim())||"",T?T.charAt(0).toUpperCase()+T.slice(1).toLowerCase():""};return e.map(t).filter(Boolean).slice(0,5)});function x(e){return String(e||"").replace(/^```[\s\S]*?\n/,"").replace(/```$/,"").replace(/\(\s*\d+\s*\)/g,"").replace(/\s\[\s*\d+\s*\]/g,"").replace(/[\u00B9\u00B2\u00B3\u2070-\u2079]/g,"")}ae("context");const R=y(()=>{var e;return x(((e=u.dream)==null?void 0:e.analysis)||"")}),te=y(()=>{var e,t;return((t=(e=u.dream)==null?void 0:e.deep_source)==null?void 0:t.overallContext)||{}});y(()=>{const e=te.value;return!!(e!=null&&e.narrative||e!=null&&e.psychologicalFunction||e!=null&&e.emotionalJourney)});const se=y(()=>{var e,t;return((t=(e=u.dream)==null?void 0:e.deep_source)==null?void 0:t.symbolsIntro)||""}),E=y(()=>{var t,i;const e=(i=(t=u.dream)==null?void 0:t.deep_source)==null?void 0:i.recurringSymbols;return Array.isArray(e)?e:[]}),U=y(()=>E.value.filter(e=>e.frequency>=2)),ge=y(()=>U.value.length>0),$e=y(()=>{var t,i;const e=(i=(t=u.dream)==null?void 0:t.deep_source)==null?void 0:i.dynamicsContext;return Array.isArray(e)?e:[]}),k=y(()=>$e.value.length>0),o=y(()=>{var e,t;return((t=(e=u.dream)==null?void 0:e.deep_source)==null?void 0:t.conclusion)||{}}),c=y(()=>{const e=o.value;return!!(e!=null&&e.periodThemes||e!=null&&e.dreamFunctionsAnalysis||e!=null&&e.psychologicalSupport||e!=null&&e.integrationExercise)}),v=y(()=>{var t,i;const e=(i=(t=u.dream)==null?void 0:t.deep_source)==null?void 0:i.dynamics;return Array.isArray(e)&&e.length>0?e:[]});y(()=>v.value.length>0);const f=y(()=>{var t,i;const e=(i=(t=u.dream)==null?void 0:t.deep_source)==null?void 0:i.conclusions;return Array.isArray(e)&&e.length>0?e:[]});y(()=>f.value.length>0);const D=y(()=>{var r,w;const e=(w=(r=u.dream)==null?void 0:r.deep_source)==null?void 0:w.recommendations;if(Array.isArray(e)&&e.length>0&&typeof e[0]=="object")return e;if(Array.isArray(e)&&e.length>0)return e.map((j,J)=>({title:`Рекомендация ${J+1}`,description:String(j),rationale:""}));const t=Q.value;if(t.length===0)return[];const i=[0,0,0,0];for(const j of t)for(let J=0;J<4;J++)i[J]+=j[J];const l=Math.max(1,t.length);for(let j=0;j<4;j++)i[j]=Math.round(i[j]/l);const b=[["Персонажи","Обрати внимание на отношения и роли; практикуй честную коммуникацию."],["Эмоции","Добавь ежедневную регуляцию эмоций (дыхание, дневник, прогулка)."],["Действия","Определи 1 маленький шаг на неделю и заверши его."],["Сцены","Проверь границы и режим: место/время, где тебе спокойнее."]],T=i.map((j,J)=>({i:J,v:j})).sort((j,J)=>J.v-j.v).map(j=>j.i);return[{title:b[T[0]][0],description:b[T[0]][1],rationale:""},{title:b[T[1]][0],description:b[T[1]][1],rationale:""}]});y(()=>D.value.length>0);function L(e,t){var i;try{let l=e;const b=Array.from(new Set((t||[]).filter(Boolean))).sort((T,r)=>r.length-T.length);for(const T of b){const r=(i=String(T).split(/[\\/,(;:—–-]/)[0])==null?void 0:i.trim();if(!r)continue;const w=new RegExp(`(\b${r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\b)`,"gi");l=l.replace(w,'<mark class="bg-white/20 px-1 rounded">$1</mark>')}return l.replace(/\n\n+/g,'</p><p class="mt-2">').replace(/\n/g,"<br>").replace(/^(.+)$/,"<p>$1")}catch{return e}}const P=y(()=>{var e,t;return L(R.value,((t=(e=u.dream)==null?void 0:e.deep_source)==null?void 0:t.tags)||[])});function V(e){try{return new Date(e).getTime()||0}catch{return 0}}const ee=y(()=>(F.history||[]).filter(e=>{var t;return!e.is_deep_analysis&&((t=e==null?void 0:e.deep_source)==null?void 0:t.hvdc)&&(e==null?void 0:e.created_at)}).sort((e,t)=>V(e.created_at)>V(t.created_at)?-1:1)),Q=y(()=>{var l;const e=V(((l=u.dream)==null?void 0:l.created_at)||""),t=ee.value.filter(b=>!M.value||(e?V(b.created_at)<=e:!0)).slice(0,5).reverse(),i=["characters","emotions","actions","settings"];return t.map(b=>i.map(T=>{var r,w;return Number(((w=(r=b.deep_source.hvdc)==null?void 0:r.distribution)==null?void 0:w[T])||0)}))}),ne=y(()=>Q.value.length),pe=y(()=>ne.value>=2),me=y(()=>Math.max(60,(ne.value-1)*28+8));function xe(e){const t=e.length,i=me.value,l=Tn,b=t>1?(i-8)/(t-1):0,T=[];for(let w=0;w<t;w++){const j=w*b,J=l-Math.round(e[w]/100*l);T.push({x:j,y:J})}return{str:T.map(w=>`${w.x},${w.y}`).join(" "),pts:T}}y(()=>{const e=[{key:"characters",label:"Персонажи",idx:0,opacity:.95},{key:"emotions",label:"Эмоции",idx:1,opacity:.75},{key:"actions",label:"Действия",idx:2,opacity:.55},{key:"settings",label:"Сцены",idx:3,opacity:.35}],t=[],i=Q.value;for(const l of e){const b=i.map(w=>w[l.idx]),{str:T,pts:r}=xe(b);t.push({key:l.key,label:l.label,values:b,points:T,pointList:r,opacity:l.opacity})}return t});const he=y(()=>{if(!pe.value)return[];if(k.value)return $e.value.map(i=>({metric:i.category||i.metric,values:i.values||[],interpretation:i.analysis||i.interpretation||"",insight:i.insight||""}));const e=[{key:"characters",label:"Персонажи",idx:0},{key:"emotions",label:"Эмоции",idx:1},{key:"actions",label:"Действия",idx:2},{key:"settings",label:"Сцены",idx:3}],t=Q.value;return e.map(i=>({metric:i.label,values:t.map(l=>l[i.idx]),interpretation:`Динамика "${i.label}" по последним ${ne.value} снам`}))});function ie(e){const i=e.split(/\n+/).map(l=>l.trim()).filter(Boolean).filter(l=>/^\d+\./.test(l)).map(l=>l.replace(/^\d+\.\s*/,"")).slice(0,3);return i.length?i:e.split(/[.!?]\s+/).map(l=>l.trim()).filter(Boolean).slice(0,3)}const oe=y(()=>ie(R.value));function _e(e){try{const t=String(e||"").toLowerCase(),i=be=>be.reduce((Ie,ft)=>Ie+(t.includes(ft)?1:0),0),l=["страх","ужас","паник","тревог","стыд","гнев","плак","слез","кошмар","тоска","грусть"],b=["экзам","выступл","собесед","защит","проект","подготов","завтра","ожидан","волнен","поездк","путешеств","нов","интервью"],T=["вчера","сегодня","работ","школ","универ","дом","улиц","друг","родител","коллег","город"],r=i(l),w=i(b),j=i(T);let J=r>0?Math.min(1,r/3):0,de=w>0?Math.min(1,w/3):0,ce=j>0?Math.min(1,.5+j/5):0;J===0&&de===0&&ce===0&&(ce=.6,J=.2,de=.2);const fe={schema:"dream_type_v1",scores:{memory:+ce.toFixed(2),emotion:+J.toFixed(2),anticipation:+de.toFixed(2)}},Z=[["memory",fe.scores.memory],["emotion",fe.scores.emotion],["anticipation",fe.scores.anticipation]];Z.sort((be,Ie)=>Ie[1]-be[1]);const ve=+Math.max(0,Z[0][1]-Z[1][1]).toFixed(2);return{...fe,dominant:Z[0][0],confidence:ve}}catch{return null}}const ke=y(()=>{var e,t,i;return((t=(e=u.dream)==null?void 0:e.deep_source)==null?void 0:t.dream_type)||_e((i=u.dream)==null?void 0:i.dream_text)||null});function st(){const e=ke.value;if(!e||!e.dominant)return['<div class="space-y-2">','<div class="font-semibold">🛠 Небольшая работа со сном</div>','<ol class="list-decimal pl-5 space-y-1">','<li><span class="font-semibold">Заметь:</span> Какие 2–3 образа из сна самые сильные? Запиши их коротко.</li>','<li><span class="font-semibold">Шаг:</span> Выбери один маленький шаг в реальности, который поддержит тебя по теме сна.</li>',"</ol>","</div>"].join("");const t=String(e.dominant).toLowerCase();return t==="memory"?['<div class="space-y-2">','<div class="font-semibold">🌙 Сон-Память</div>','<p class="opacity-90">Переработка недавнего опыта, соединение нового с прошлым.</p>','<ol class="list-decimal pl-5 space-y-1">','<li><span class="font-semibold">Отрази:</span> Вспомни, что происходило последние 1–2 дня. Какие события могли попасть в сон?</li>','<li><span class="font-semibold">Соедини:</span> Отметь, какие элементы сна перекликаются с реальностью — это завершает «архивацию» опыта.</li>',"</ol>","</div>"].join(""):t==="emotion"?['<div class="space-y-2">','<div class="font-semibold">⚡️ Сон-Эмоция</div>','<p class="opacity-90">Проживание и нейтрализация сильных чувств.</p>','<ol class="list-decimal pl-5 space-y-1">','<li><span class="font-semibold">Почувствуй:</span> Определи, какая эмоция была самой сильной во сне. Где она чувствуется в теле сейчас?</li>','<li><span class="font-semibold">Услышь:</span> Представь, что главный персонаж сна говорит тебе что-то. Что он хочет, чтобы ты понял?</li>',"</ol>","</div>"].join(""):['<div class="space-y-2">','<div class="font-semibold">🔮 Сон-Предвосхищение</div>','<p class="opacity-90">Тренировка будущих ситуаций и реакций.</p>','<ol class="list-decimal pl-5 space-y-1">','<li><span class="font-semibold">Представь:</span> Как бы ты хотел повести себя, если бы это произошло в реальности?</li>','<li><span class="font-semibold">Расшифруй:</span> Какой символ кажется ключевым? Что он может говорить о твоих страхах или намерениях?</li>',"</ol>","</div>"].join("")}const nt=y(()=>{var de,ce,fe;const e=x(((de=u.dream)==null?void 0:de.analysis)||"");if(!e)return[];const t={arch:{key:"arch",title:"Архетипическая история",text:""},func:{key:"func",title:"Возможная функция сна",text:""},freud:{key:"freud",title:"По Фрейду",text:""},jung:{key:"jung",title:"По Юнгу",text:""}},i=[],l=/\*\*([^*]+)\*\*/g;let b;for(;b=l.exec(e);)i.push({title:b[1].trim(),start:b.index,end:b.index+b[0].length});const T=((ce=i[0])==null?void 0:ce.start)??e.length;t.arch.text=e.slice(0,T).trim();for(let Z=0;Z<i.length;Z++){const ve=i[Z].title.toLowerCase(),be=e.slice(i[Z].end,((fe=i[Z+1])==null?void 0:fe.start)??e.length).trim();ve.includes("возможная функция")?t.func.text=be:ve.includes("по фрейду")?t.freud.text=be:ve.includes("по юнгу")&&(t.jung.text=be)}const r=Z=>Z.replace(/\n\n+/g,'</p><p class="mt-2">').replace(/\n/g,"<br>").replace(/^(.+)$/,"<p>$1"),w=Object.values(t).map(Z=>({...Z,html:r(Z.text||"")}));w.some(Z=>Z.key==="func")||w.push({key:"func",title:"Возможная функция сна",text:"",html:""});const j=w.findIndex(Z=>Z.key==="arch");j!==-1&&w.splice(j+1,0,{key:"hvdc",title:"Контент анализ",text:"",html:""});const J=st();if(J){const Z=w.findIndex(ve=>ve.key==="func");if(Z!==-1){const ve=['<div class="mt-3 pt-2 border-t border-white/10 space-y-1">','<div class="font-semibold">Функциональное упражнение</div>',J,"</div>"].join("");w[Z].html=(w[Z].html||"")+ve}}return w}),ue=yt({arch:!0,hvdc:!1,func:!1,freud:!1,jung:!1,symbols:!0,dynamics:!0,conclusion:!0});function Ae(e){ue[e]=!ue[e]}const Re=y(()=>{try{return new URLSearchParams(window.location.search).get("debug")==="1"||localStorage.getItem("da_debug")==="1"}catch{return!1}});function it(){var e,t,i,l,b;try{const T=JSON.stringify(ze.value,null,2);(e=navigator.clipboard)==null||e.writeText(T),(t=h==null?void 0:h.success)==null||t.call(h,"Скопировано")}catch{try{(b=(l=(i=window.Telegram)==null?void 0:i.WebApp)==null?void 0:l.showPopup)==null||b.call(l,{title:"Debug",message:"Скопируйте из блока ниже вручную",buttons:[{id:"ok",type:"default",text:"OK"}]})}catch{}}}function rt(e){var i;let t=String(e||"").trim();return t=((i=t.split(/[\\/,(;:—–-]/)[0])==null?void 0:i.trim())||"",t?t.charAt(0).toUpperCase()+t.slice(1).toLowerCase():""}const ze=y(()=>{var i,l,b,T;if(!Re.value)return null;const e=u.dream||{},t=Array.isArray((i=e==null?void 0:e.deep_source)==null?void 0:i.tags)?e.deep_source.tags:[];return{id:e.id,created_at:e.created_at,is_deep_analysis:!!e.is_deep_analysis,title_raw:((l=e==null?void 0:e.deep_source)==null?void 0:l.title)||null,tags_raw:t,tags_norm:t.map(rt),dream_type:((b=e==null?void 0:e.deep_source)==null?void 0:b.dream_type)||null,hvdc_present:!!((T=e==null?void 0:e.deep_source)!=null&&T.hvdc)}}),Fe=ae(!1),Ze=ae(1),at=["0-20","20-30","30-40","40-50","50+"],Le=ae(""),Me=ae("");function Ne(){Fe.value=!1}async function ot(){try{await Ue.setDemographics(Le.value,Me.value);try{await F.fetchProfile()}catch{}h.success("Готово! Дальнейшие анализы будут учитывать эти данные"),Fe.value=!1}catch{h.error("Не удалось сохранить")}}y(()=>{const e=F.profile||{};return!!(e.age_range&&e.gender)});const Ce=y(()=>{var e,t;return((t=(e=u.dream)==null?void 0:e.deep_source)==null?void 0:t.hvdc)||null}),lt=y(()=>{var b,T,r;const e=[{key:"characters",label:"Персонажи"},{key:"emotions",label:"Эмоции"},{key:"actions",label:"Действия"},{key:"settings",label:"Сцены"}],t=((b=Ce.value)==null?void 0:b.distribution)||{},i=((T=Ce.value)==null?void 0:T.norm)||null,l=((r=Ce.value)==null?void 0:r.comparison)||null;return e.map(w=>({key:w.key,label:w.label,value:Number(t[w.key]??0),norm:i?Number(i[w.key]??0):null,delta:l?Number(l[w.key]??0):null}))}),ct=y(()=>{var r;const e=((r=Ce.value)==null?void 0:r.norm_group)||null;if(!e)return"общая статистика";const t=String(e.gender||"").toLowerCase(),i=t==="male"?"муж.":t==="female"?"жен.":"",l=e.age_range||"",b=l?`${l} лет`:"",T=[i,b].filter(Boolean).join(" ");return T?`общая статистика* для ${T}`:"общая статистика"}),ut=y(()=>{if(!u.dream.created_at)return"";try{const e=Intl.DateTimeFormat().resolvedOptions().timeZone||we.tz.guess(),t=we.utc(u.dream.created_at).tz(e).startOf("day"),l=we().tz(e).startOf("day").diff(t,"day"),b=Math.floor(l/7),T=Math.floor(l/30),r=Math.floor(l/365);return l===0?"сегодня":l===1?"вчера":l<7?`${l} д`:l<30?`${b} н`:l<365?`${T} м`:`${r} г`}catch{return u.dream.created_at}}),dt=y(()=>{var e;return(e=u.dream)!=null&&e.is_deep_analysis?"from-[#9C41FF] to-[#C03AFF]":"from-[#4A58FF] to-[#5664FF]"});return(e,t)=>{var i,l,b,T;return n(),a("article",{class:ye(["rounded-xl bg-gradient-to-br text-white px-8 md:px-16 transition-all overflow-hidden cursor-pointer py-6",[q.active?"":"min-h-[4.5rem]",dt.value]]),onClick:G},[s("div",es,[s("h3",ts,S(A.value),1),s("span",ss,S(ut.value),1)]),q.active?(n(),a("div",ns,[g.value.length&&!M.value?(n(),a("div",is,[(n(!0),a(X,null,re(g.value,r=>(n(),a("span",{key:r,class:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-white/15 text-white"},S(r),1))),128))])):z("",!0),M.value?(n(),a(X,{key:1},[ge.value?(n(),a("div",rs,[s("button",{class:"w-full text-left px-3 py-2 font-semibold flex items-center justify-between",onClick:t[0]||(t[0]=le(r=>Ae("symbols"),["stop"]))},[t[10]||(t[10]=s("span",null,"Повторяющиеся символы",-1)),s("span",as,S(ue.symbols?"−":"+"),1)]),ue.symbols?(n(),a("div",os,[se.value?(n(),a("p",ls,S(se.value),1)):z("",!0),(n(!0),a(X,null,re(U.value,(r,w)=>(n(),a("div",{key:`symbol-${w}`,class:"space-y-1"},[s("div",cs,[s("h4",us,S(r.symbol),1),s("span",ds,"×"+S(r.frequency),1)]),s("p",fs,S(r.description),1),s("div",ps,[t[11]||(t[11]=s("span",{class:"font-medium"},"В ваших снах:",-1)),Se(" "+S(r.userContext),1)])]))),128))])):z("",!0)])):z("",!0),k.value?(n(),a("div",ms,[s("button",{class:"w-full text-left px-3 py-2 font-semibold flex items-center justify-between",onClick:t[1]||(t[1]=le(r=>Ae("dynamics"),["stop"]))},[t[12]||(t[12]=s("span",null,"Динамика контекста",-1)),s("span",hs,S(ue.dynamics?"−":"+"),1)]),ue.dynamics?(n(),a("div",vs,[We(Je,{dynamics:$e.value,userAge:(i=je(F).profile)==null?void 0:i.age_range,userGender:(l=je(F).profile)==null?void 0:l.gender},null,8,["dynamics","userAge","userGender"])])):z("",!0)])):z("",!0),c.value?(n(),a("div",ys,[s("button",{class:"w-full text-left px-3 py-2 font-semibold flex items-center justify-between",onClick:t[2]||(t[2]=le(r=>Ae("conclusion"),["stop"]))},[t[13]||(t[13]=s("span",null,"Заключение",-1)),s("span",gs,S(ue.conclusion?"−":"+"),1)]),ue.conclusion?(n(),a("div",xs,[o.value.periodThemes?(n(),a("p",_s,S(o.value.periodThemes),1)):z("",!0),o.value.dreamFunctionsAnalysis?(n(),a("p",bs,S(o.value.dreamFunctionsAnalysis),1)):z("",!0),o.value.psychologicalSupport?(n(),a("p",ws,S(o.value.psychologicalSupport),1)):z("",!0),o.value.integrationExercise?(n(),a("div",$s,[s("h4",ks,[t[14]||(t[14]=s("span",null,"💫",-1)),s("span",null,S(o.value.integrationExercise.title||"Практическое упражнение"),1)]),s("p",Ms,S(o.value.integrationExercise.description),1),o.value.integrationExercise.rationale?(n(),a("p",Ss,S(o.value.integrationExercise.rationale),1)):z("",!0)])):z("",!0)])):z("",!0)])):z("",!0),!ge.value&&!k.value&&!c.value?(n(),a(X,{key:3},[s("div",Ds,[t[15]||(t[15]=s("div",{class:"px-3 py-2 font-semibold"},"Общий контекст серии",-1)),s("div",Cs,[s("div",{innerHTML:P.value},null,8,Ts)])]),g.value.length?(n(),a("div",Hs,[t[16]||(t[16]=s("div",{class:"px-3 py-2 font-semibold"},"Повторяющиеся символы",-1)),s("div",Os,[s("div",As,[(n(!0),a(X,null,re(g.value,r=>(n(),a("span",{key:"deep-"+r,class:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-white/15 text-white"},S(r),1))),128))])])])):z("",!0),pe.value?(n(),a("div",Ls,[t[17]||(t[17]=s("div",{class:"px-3 py-2 font-semibold"},"Динамика",-1)),s("div",js,[We(Je,{dynamics:he.value,userAge:(b=je(F).profile)==null?void 0:b.age_range,userGender:(T=je(F).profile)==null?void 0:T.gender},null,8,["dynamics","userAge","userGender"])])])):z("",!0),oe.value.length?(n(),a("div",Ys,[t[18]||(t[18]=s("div",{class:"px-3 py-2 font-semibold"},"Ключевые инсайты",-1)),s("div",zs,[s("ol",Fs,[(n(!0),a(X,null,re(oe.value,(r,w)=>(n(),a("li",{key:"in"+w,class:"text-xs leading-relaxed"},S(r),1))),128))])])])):z("",!0),D.value.length?(n(),a("div",Ns,[t[19]||(t[19]=s("div",{class:"px-3 py-2 font-semibold"},"Рекомендации",-1)),s("div",Is,[s("ol",Us,[(n(!0),a(X,null,re(D.value,(r,w)=>(n(),a("li",{key:"rec"+w,class:"text-xs leading-relaxed"},[typeof r=="object"&&r.title?(n(),a("div",Bs,[s("div",Ws,S(r.title),1),s("div",Es,S(r.description),1),r.rationale?(n(),a("div",Ps,S(r.rationale),1)):z("",!0)])):(n(),a("div",Vs,S(typeof r=="string"?r:r.title),1))]))),128))])])])):z("",!0)],64)):z("",!0),(ge.value||k.value)&&!c.value?(n(),a(X,{key:4},[oe.value.length?(n(),a("div",Rs,[t[20]||(t[20]=s("div",{class:"px-3 py-2 font-semibold"},"Ключевые инсайты",-1)),s("div",Zs,[s("ol",qs,[(n(!0),a(X,null,re(oe.value,(r,w)=>(n(),a("li",{key:"in"+w,class:"text-xs leading-relaxed"},S(r),1))),128))])])])):z("",!0),D.value.length?(n(),a("div",Gs,[t[21]||(t[21]=s("div",{class:"px-3 py-2 font-semibold"},"Рекомендации",-1)),s("div",Js,[s("ol",Xs,[(n(!0),a(X,null,re(D.value,(r,w)=>(n(),a("li",{key:"rec"+w,class:"text-xs leading-relaxed"},[typeof r=="object"&&r.title?(n(),a("div",Ks,[s("div",Qs,S(r.title),1),s("div",en,S(r.description),1),r.rationale?(n(),a("div",tn,S(r.rationale),1)):z("",!0)])):(n(),a("div",sn,S(typeof r=="string"?r:r.title),1))]))),128))])])])):z("",!0)],64)):z("",!0)],64)):(n(),a(X,{key:2},[s("div",nn,[t[22]||(t[22]=s("div",{class:"px-3 py-2 font-semibold flex items-center justify-between"},[s("span",null,"Сон"),s("span",{class:"opacity-80 text-pink-400",style:{"font-size":"130%","font-family":"ui-rounded, -apple-system, system-ui, 'SF Pro Rounded', 'Segoe UI', Roboto, Arial"}},"“")],-1)),s("div",rn,[s("p",{class:ye(["opacity-90",I.value?"clamp-5":""])},S(q.dream.dream_text),3),s("div",an,[s("button",{class:"text-sm font-semibold opacity-80 hover:opacity-100",onClick:t[3]||(t[3]=le(r=>I.value=!I.value,["stop"]))},S(I.value?"+":"−"),1)])])]),s("div",on,[(n(!0),a(X,null,re(nt.value,(r,w)=>(n(),a("div",{key:r.key,class:"rounded-lg bg-white/10"},[s("button",{class:"w-full text-left px-3 py-2 font-semibold flex items-center justify-between",onClick:le(j=>Ae(r.key),["stop"])},[s("span",null,S(r.title),1),s("span",cn,S(ue[r.key]?"−":"+"),1)],8,ln),ue[r.key]?(n(),a("div",un,[r.key!=="hvdc"?(n(),a("div",{key:0,innerHTML:r.html},null,8,dn)):(n(),a(X,{key:1},[Ce.value?(n(),a("div",fn,[(n(!0),a(X,null,re(lt.value,j=>(n(),a("div",{key:j.key},[s("div",pn,[s("span",null,S(j.label),1),s("span",null,[Se(S(j.value)+"% ",1),j.norm!==null?(n(),a(X,{key:0},[Se(" / "+S(j.norm)+"%",1)],64)):z("",!0),j.delta!==null?(n(),a("span",{key:1,class:ye(j.delta>0?"text-green-300":j.delta<0?"text-red-300":"text-white/70")}," ("+S(j.delta>0?"+"+j.delta:j.delta)+"pp) ",3)):z("",!0)])]),s("div",mn,[j.norm!==null?(n(),a("div",{key:0,class:"absolute inset-y-0 left-0 bg-white/20",style:qe({width:j.norm+"%"})},null,4)):z("",!0),s("div",{class:"relative h-full bg-white/70",style:qe({width:j.value+"%"})},null,4)])]))),128)),s("div",hn,[t[24]||(t[24]=s("span",{class:"inline-flex items-center gap-2"},[s("span",{class:"w-2 h-2 rounded-full inline-block bg-white/70 shrink-0"}),Se(" ваш сон")],-1)),s("span",vn,[t[23]||(t[23]=s("span",{class:"w-2 h-2 rounded-full inline-block bg-white/20 shrink-0"},null,-1)),Se(" "+S(ct.value),1)])]),t[25]||(t[25]=s("div",{class:"text-xs opacity-70 flex items-start gap-2"},[s("span",{class:"inline-flex items-center justify-center w-4 h-4 rounded-full bg-white/20 text-white text-[10px]"},"i"),s("span",null,"Контент‑анализ по схеме HVdC; сравнение с демографическими нормами (DreamBank, SDDB).")],-1))])):z("",!0)],64))])):z("",!0)]))),128))])],64)),s("div",yn,[s("button",{class:ye(["flex-1 rounded-xl py-2 text-sm font-medium text-center transition-colors",O.value===1?"bg-green-500/30 text-white ring-2 ring-green-400/60":"bg-white/20 hover:bg-white/30 text-white"]),onClick:le(Y,["stop"])}," 👍 ",2),s("button",{class:ye(["flex-1 rounded-xl py-2 text-sm font-medium text-center transition-colors",O.value===2?"bg-red-500/30 text-white ring-2 ring-red-400/60":"bg-white/20 hover:bg-white/30 text-white"]),onClick:le(N,["stop"])}," 👎 ",2),s("button",{class:"flex-1 bg-red-500/20 hover:bg-red-500/30 text-white rounded-xl py-2 text-sm font-medium text-center transition-colors",onClick:le(m,["stop"])}," 🗑️ ")]),Re.value&&ze.value?(n(),a("div",gn,[t[26]||(t[26]=s("div",{class:"mb-2 opacity-80"},"Debug payload",-1)),Se(" "+S(JSON.stringify(ze.value,null,2))+" ",1),s("div",xn,[s("button",{class:"px-3 py-1 rounded bg-white/10 hover:bg-white/20",onClick:le(it,["stop"])},"Скопировать")])])):z("",!0),(n(),Ee(gt,{to:"body"},[Fe.value?(n(),a("div",{key:0,class:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/70",onClick:le(Ne,["self"]),onWheel:t[8]||(t[8]=le(()=>{},["prevent"])),onTouchmove:t[9]||(t[9]=le(()=>{},["prevent"]))},[s("div",{class:"w-[92vw] max-w-[440px] rounded-2xl bg-[var(--tg-theme-secondary-bg-color,#0c110c)] text-white p-4 shadow-2xl border border-white/10",onClick:t[7]||(t[7]=le(()=>{},["stop"]))},[t[29]||(t[29]=s("h3",{class:"text-lg font-semibold mb-2"},"Уточнить данные",-1)),Ze.value===1?(n(),a("div",_n,[t[27]||(t[27]=s("p",{class:"opacity-90"},"Ваш возрастной диапазон:",-1)),s("div",bn,[(n(),a(X,null,re(at,r=>s("button",{key:r,class:ye(["px-4 py-3 rounded-xl text-sm",Le.value===r?"bg-white/25":"bg-white/10 hover:bg-white/15"]),onClick:w=>Le.value=r},S(r),11,wn)),64))]),s("div",$n,[s("button",{class:"px-4 py-2 rounded-xl bg-white/10",onClick:Ne},"Отмена"),s("button",{class:"px-4 py-2 rounded-xl bg-white/20",disabled:!Le.value,onClick:t[4]||(t[4]=r=>Ze.value=2)},"Далее",8,kn)])])):(n(),a("div",Mn,[t[28]||(t[28]=s("p",{class:"opacity-90"},"Ваш пол:",-1)),s("div",Sn,[s("button",{class:ye(["px-4 py-3 rounded-xl text-sm",Me.value==="male"?"bg-white/25":"bg-white/10 hover:bg-white/15"]),onClick:t[5]||(t[5]=r=>Me.value="male")},"Мужской",2),s("button",{class:ye(["px-4 py-3 rounded-xl text-sm",Me.value==="female"?"bg-white/25":"bg-white/10 hover:bg-white/15"]),onClick:t[6]||(t[6]=r=>Me.value="female")},"Женский",2)]),s("div",Dn,[s("button",{class:"px-4 py-2 rounded-xl bg-white/10",onClick:Ne},"Отмена"),s("button",{class:"px-4 py-2 rounded-xl bg-white/20",disabled:!Me.value,onClick:ot},"Сохранить",8,Cn)])]))])],32)):z("",!0)]))])):z("",!0)],2)}}}),Xe=Ve(Hn,[["__scopeId","data-v-f868823c"]]),On={class:"flex items-center justify-between mb-4"},An={class:"inline-flex items-center gap-2 rounded-full px-3 py-1 themed-badge"},Ln={key:0,class:"flex flex-col gap-4 pb-[5vh]"},jn={key:1,class:"text-center text-red-400 py-8"},Yn={key:2},zn={key:0,class:"text-center text-white/60 py-8"},Fn={key:1,class:"flex flex-col gap-4 pb-[5vh]"},Nn={key:3},In={key:0,class:"text-center text-white/60 py-8"},Un={key:1,class:"flex flex-col gap-4 pb-[5vh]"},Bn=Pe({__name:"AnalysisHistoryList",props:["userStore"],setup(q){const K=q,u=ae(null),W=ae(5),G=ae(5),F=ae("history"),h=y({get:()=>F.value,set:_=>d(_)}),I=y(()=>{var _;return(_=K.userStore)!=null&&_.history?K.userStore.history.filter($=>!$.is_deep_analysis):[]}),M=y(()=>{var _;return(_=K.userStore)!=null&&_.history?K.userStore.history.filter($=>$.is_deep_analysis):[]}),O=y(()=>I.value.slice(0,W.value)),H=y(()=>M.value.slice(0,G.value)),B=y(()=>I.value.length>W.value),Y=y(()=>M.value.length>G.value),N=()=>{window.triggerHaptic&&window.triggerHaptic("light"),W.value+=5},m=()=>{window.triggerHaptic&&window.triggerHaptic("light"),G.value+=5},d=_=>{window.triggerHaptic&&window.triggerHaptic("light"),F.value=_,u.value=null};return(_,$)=>{var p,C,A,g;return n(),a("div",null,[s("div",On,[$[2]||($[2]=s("h2",{class:"text-3xl font-bold"},"История",-1)),s("div",An,[xt(s("select",{"aria-label":"Режим истории","onUpdate:modelValue":$[0]||($[0]=x=>h.value=x),class:"bg-transparent focus:outline-none themed-select"},[...$[1]||($[1]=[s("option",{value:"history"},"Дневник снов",-1),s("option",{value:"deep"},"Глубокий анализ",-1)])],512),[[_t,h.value]])])]),(p=q.userStore)!=null&&p.isLoadingHistory?(n(),a("div",Ln,[(n(),a(X,null,re(3,x=>s("div",{key:x,class:"rounded-xl bg-white/10 px-8 md:px-16 py-6"},[...$[3]||($[3]=[bt('<div class="flex justify-between items-center py-2 min-h-[2.5rem]" data-v-14de94bb><div class="shimmer h-4 w-32 rounded" data-v-14de94bb></div><div class="shimmer h-4 w-12 rounded" data-v-14de94bb></div></div><div class="mt-4 space-y-2" data-v-14de94bb><div class="shimmer h-3 w-full rounded" data-v-14de94bb></div><div class="shimmer h-3 w-5/6 rounded" data-v-14de94bb></div><div class="shimmer h-3 w-2/3 rounded" data-v-14de94bb></div></div><div class="mt-4 grid grid-cols-3 gap-2" data-v-14de94bb><div class="shimmer h-6 rounded-full" data-v-14de94bb></div><div class="shimmer h-6 rounded-full" data-v-14de94bb></div><div class="shimmer h-6 rounded-full" data-v-14de94bb></div></div>',3)])])),64))])):(C=q.userStore)!=null&&C.errorHistory?(n(),a("div",jn," Ошибка загрузки: "+S(q.userStore.errorHistory),1)):F.value==="history"?(n(),a("div",Yn,[(A=I.value)!=null&&A.length?(n(),a("div",Fn,[(n(!0),a(X,null,re(O.value,x=>(n(),Ee(Xe,{key:x.id,dream:x,active:u.value===x.id,onToggle:R=>u.value=u.value===x.id?null:x.id},null,8,["dream","active","onToggle"]))),128)),B.value?(n(),a("button",{key:0,class:"self-center rounded-full px-4 py-2 text-sm font-medium transition-colors my-2 themed-button",onClick:N}," Загрузить ещё ")):z("",!0)])):(n(),a("div",zn," У вас пока нет сохраненных анализов "))])):F.value==="deep"?(n(),a("div",Nn,[(g=M.value)!=null&&g.length?(n(),a("div",Un,[(n(!0),a(X,null,re(H.value,x=>(n(),Ee(Xe,{key:x.id,dream:x,active:u.value===x.id,onToggle:R=>u.value=u.value===x.id?null:x.id},null,8,["dream","active","onToggle"]))),128)),Y.value?(n(),a("button",{key:0,class:"self-center rounded-full px-4 py-2 text-sm font-medium transition-colors my-2 themed-button",onClick:m}," Загрузить ещё ")):z("",!0)])):(n(),a("div",In," Пока нет глубоких анализов "))])):z("",!0)])}}}),Vn=Ve(Bn,[["__scopeId","data-v-14de94bb"]]);export{Vn as default};
