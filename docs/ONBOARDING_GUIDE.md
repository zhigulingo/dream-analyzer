# Руководство по онбордингу TMA (Dream Analyzer)

Документ описывает архитектуру, поведение и правила визуального оформления онбордингов в TMA, чтобы упростить повторное создание или модификацию текущих сценариев.

## 1) Где находится код
- Компонент: `tma/src/components/Onboarding.vue`
- Точка подключения: `tma/src/App.vue` (контролирует видимость, safe‑area и скрывает snackbar во время онбординга)
- Ассеты (стикеры/картинки): `tma/stickers/` (+ импорт через `new URL(..., import.meta.url)`)

## 2) Потоки онбординга и переходы
Онбординг представлен как простой автомат состояний (flow + step):
- Потоки (flow):
  - `new` — первый онбординг (перед подпиской и первым анализом)
  - `post_claim` — экран перехода в чат после получения токена, но до первого анализа
  - `free` — второй онбординг (после первого анализа)
- Выбор потока (`initFlow()`):
  - `onboarding2` → `free`
  - `onboarding1` + reward получен, но анализов нет → `post_claim`
  - `onboarding1` → `new`
  - иначе → `none`
- Смена шагов управляется вертикальным Swiper (см. ниже). Обработчики `onSlideChange*` поддерживают масштаб «активной» карточки и Telegram MainButton.
- После успешной проверки подписки в первом онбординге поток переводится в `post_claim` (экран с кнопкой «Написать сон») без автозакрытия мини‑аппы.

## 3) Swiper (анимация и прокрутка)
- Вертикальный слайдер, один стек карточек на экран.
- Ключевые опции:
  - `direction="vertical"`
  - `spaceBetween=18`
  - `slidesOffsetBefore=48`, `slidesOffsetAfter=48` — обеспечивают «peeking» сверху и снизу
  - `centeredSlides=true`, `keyboard={enabled:true}`, `a11y={enabled:true}`, `observer`, `observeParents`, `watchOverflow`
  - В некоторых потоках включён `autoplay` (задержка 8s, `stopOnLastSlide: true`).
- Классы:
  - `.slidePeek` — слайд‑контейнер с `min-height:72vh; max-height:72vh` для стабильного peeking
  - `.onboarding-swiper` — внутренний padding (снизу чуть меньше, чтобы нижний край не обрезался)
  - При инициализации/смене слайда «активной» карточке задаётся `transform: scale(1.0)`, соседним — `0.92`.

## 4) Макет карточек
- Единые правила:
  - Стикер (если есть) — сверху: контейнер `.onboarding-media.media-top`
  - Заголовок — всегда в центре карточки: `.onboarding-body > h2`
  - Изображение (если есть) — внизу карточки: `.onboarding-media.media-bottom`
- Размеры и шрифты:
  - Базовый заголовок: `.headline` → 16px, medium, `line-height:1.4`
  - Второй онбординг:
    - Слайд 1 — многострочный текст (как в макете)
    - Слайды 2–4 — заголовок 24px (`.headline-24`)
- Изображения внизу:
  - Класс `.onboarding-media-img` с `object-fit:contain`, `max-width:320px`, `max-height:calc(72vh - 120px)` — чтобы не вылезать за карточку и не сдвигать заголовок.

## 5) Безопасная область и шапка Telegram
- В `App.vue` вычисляется и обновляется CSS‑переменная `--tma-safe-top` на основе `WebApp.contentSafeAreaInset.top`/`safeAreaInset.top` + буфер.
- Основной интерфейс получает `padding-top:var(--tma-safe-top, 56px)`.
- Оверлей онбординга без внешнего padding; отступы организует сам Swiper.

## 6) Telegram MainButton (меню внизу)
- Хелперы: `setMainButton(text, handler)` и `clearMainButton()`; цвета берутся из `tg.themeParams`.
- Первый онбординг, шаг 4: кнопка показывается сразу (без ожидания проверки подписки). Проверка запускается в фоне; при успехе кнопка меняется на «Открыть чат», а flow → `post_claim`.
- `post_claim`: кнопка «Написать сон» сразу доступна.
- Второй онбординг, шаг 4: «Открыть историю».

## 7) Snackbar (уведомления)
- На время онбординга snackbar скрывается: в `App.vue` `NotificationSystem` рендерится только когда `onboardingVisible === false`.
- Внутренние вызовы `notificationStore` остаются — но не мешают UX онбординга.

## 8) Производительность и доступность
- Стикеры и тяжёлые изображения лениво загружаются.
- Включены `keyboard` и `a11y` у Swiper.
- Избегаем тяжёлых операций в смене слайдов и внешних запросов на «горячем пути». Проверки/запросы — в фоне.

## 9) Как добавить/изменить карточку
1. Определить поток (`new` / `post_claim` / `free`).
2. Внутри соответствующего блока `<Swiper>` добавить `<SwiperSlide class="onboarding-card slidePeek center-card">`.
3. Соблюсти структуру: `media-top` (опционально) → `body` (обязательно) → `media-bottom` (опционально).
4. Для изображений использовать `.onboarding-media-img`.
5. Для заголовка выбрать нужный стиль (`.headline`, `.headline-24`).
6. При необходимости — обновить обработчики `onSlideChange*` (кнопки/аналитика).

## 10) Аналитика
- Используются события `api.trackOnboarding(...)` на вход/клики/переходы.
- Рекомендуется сохранять консистентные имена событий для поиска в логах.

## 11) Тест‑чеклист
- Первый онбординг: peeking сверху/снизу виден; кнопка на шаге 4 появляется сразу; при успешной проверке подписки — переход на `post_claim` без закрытия мини‑аппы.
- Второй онбординг: изображения не выходят за карточку на маленьких экранах; заголовки 24px на слайды 2–4.
- Snackbar не отображается во время онбординга, но работает на главном экране.
- Safe‑area корректен (ничего не залезает под шапку Telegram).

---

## Как сделать тексты/стикеры/изображения динамическими (варианты)

Ниже — варианты без изменений текущей логики показа (только источник контента).

### Вариант A: Локальный JSON/TS‑конфиг
- Создать `tma/src/content/onboarding.ts` с типизированным массивом слайдов:
```ts
export type OnboardingSlide = {
  flow: 'new' | 'post_claim' | 'free'
  order: number
  title?: string
  titleStyle?: 'headline' | 'headline-24'
  textHtml?: string // для многострочного HTML на первом слайде
  sticker?: 'wizard-happy.tgs' | 'chat.tgs' | 'telegram-star.tgs' | string
  image?: string // URL через new URL('...', import.meta.url)
};
export const ONBOARDING_SLIDES: OnboardingSlide[] = [ /* ... */ ]
```
- В `Onboarding.vue` заменить статичную разметку на рендер по конфигу. Преимущества: быстро, без сети. Недостатки: требует релиза для изменений.

### Вариант B: Хранение контента в Supabase
- Таблица `onboarding_slides(flow text, order int, title text, title_style text, text_html text, sticker text, image_url text, enabled bool, locale text)`.
- Netlify Function `/.netlify/functions/onboarding-config` → отдать публичный JSON по потоку/локали.
- В `Onboarding.vue` загрузить JSON при монтировании, с кэшем в `Telegram.DeviceStorage` (Bot API 9.0+). Добавить фолбэк на локальный конфиг.
- Плюсы: менять контент без релиза; легко включать/выключать слайды; можно делать A/B.

### Вариант C: Простая CMS/Google Sheets
- Хранить строки/ссылки в Google Sheets или Headless CMS (например, Contentful/Strapi),
  Netlify Function — адаптер в нужный JSON. Подходит для быстрой редакторской замены.

### Общие замечания по динамике
- Стикеры лучше хранить локально (TGS в репозитории), а конфиг хранит только имя файла → уменьшает сетевые риски.
- Изображения можно отдавать по CDN‑ссылкам, но обязательно с фиксированными размерами либо с `object-fit:contain`.
- Для i18n — поле `locale` + фолбэк на `ru`/`en`.
- Для безопасности — в динамическом тексте рендерить только разрешённый подмножество HTML (или хранить plain text + разметку в компоненте).

---

Если нужен прототип на одном из вариантов, укажи желаемый источник данных (локально/БД/CMS) и формат, подготовлю реализацию без ломки текущего UX.
