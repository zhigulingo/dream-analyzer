import{d as Be,r as ie,c as k,a as o,o as r,b as s,s as Ae,M as wt,w as kt,e as N,t as A,F as K,A as ne,n as he,m as $t,u as Mt,N as St,C as ue,k as Ye,q as Fe,l as we,D as st,z as Re,f as Qe,O as Dt,P as Tt,h as Ct,E as jt,G as At,j as Ot}from"./main-DNZdXXg4.js";import{c as Oe,g as ze}from"./_commonjsHelpers-Cpj98o6Y.js";import{_ as Ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";var Pe={exports:{}},et;function nt(){return et||(et=1,function(V,J){(function(l,R){V.exports=R()})(Oe,function(){var l=1e3,R=6e4,X=36e5,q="millisecond",j="second",F="minute",_="hour",z="day",E="week",I="month",M="quarter",W="year",g="date",f="Invalid Date",O=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,H=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,c={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(C){var v=["th","st","nd","rd"],d=C%100;return"["+C+(v[(d-20)%10]||v[d]||v[0])+"]"}},y=function(C,v,d){var p=String(C);return!p||p.length>=v?C:""+Array(v+1-p.length).join(d)+C},$={s:y,z:function(C){var v=-C.utcOffset(),d=Math.abs(v),p=Math.floor(d/60),m=d%60;return(v<=0?"+":"-")+y(p,2,"0")+":"+y(m,2,"0")},m:function C(v,d){if(v.date()<d.date())return-C(d,v);var p=12*(d.year()-v.year())+(d.month()-v.month()),m=v.clone().add(p,I),Y=d-m<0,B=v.clone().add(p+(Y?-1:1),I);return+(-(p+(d-m)/(Y?m-B:B-m))||0)},a:function(C){return C<0?Math.ceil(C)||0:Math.floor(C)},p:function(C){return{M:I,y:W,w:E,d:z,D:g,h:_,m:F,s:j,ms:q,Q:M}[C]||String(C||"").toLowerCase().replace(/s$/,"")},u:function(C){return C===void 0}},x="en",u={};u[x]=c;var h="$isDayjsObject",S=function(C){return C instanceof ve||!(!C||!C[h])},L=function C(v,d,p){var m;if(!v)return x;if(typeof v=="string"){var Y=v.toLowerCase();u[Y]&&(m=Y),d&&(u[Y]=d,m=Y);var B=v.split("-");if(!m&&B.length>1)return C(B[0])}else{var Z=v.name;u[Z]=v,m=Z}return!p&&m&&(x=m),m||!p&&x},U=function(C,v){if(S(C))return C.clone();var d=typeof v=="object"?v:{};return d.date=C,d.args=arguments,new ve(d)},D=$;D.l=L,D.i=S,D.w=function(C,v){return U(C,{locale:v.$L,utc:v.$u,x:v.$x,$offset:v.$offset})};var ve=function(){function C(d){this.$L=L(d.locale,null,!0),this.parse(d),this.$x=this.$x||d.x||{},this[h]=!0}var v=C.prototype;return v.parse=function(d){this.$d=function(p){var m=p.date,Y=p.utc;if(m===null)return new Date(NaN);if(D.u(m))return new Date;if(m instanceof Date)return new Date(m);if(typeof m=="string"&&!/Z$/i.test(m)){var B=m.match(O);if(B){var Z=B[2]-1||0,Q=(B[7]||"0").substring(0,3);return Y?new Date(Date.UTC(B[1],Z,B[3]||1,B[4]||0,B[5]||0,B[6]||0,Q)):new Date(B[1],Z,B[3]||1,B[4]||0,B[5]||0,B[6]||0,Q)}}return new Date(m)}(d),this.init()},v.init=function(){var d=this.$d;this.$y=d.getFullYear(),this.$M=d.getMonth(),this.$D=d.getDate(),this.$W=d.getDay(),this.$H=d.getHours(),this.$m=d.getMinutes(),this.$s=d.getSeconds(),this.$ms=d.getMilliseconds()},v.$utils=function(){return D},v.isValid=function(){return this.$d.toString()!==f},v.isSame=function(d,p){var m=U(d);return this.startOf(p)<=m&&m<=this.endOf(p)},v.isAfter=function(d,p){return U(d)<this.startOf(p)},v.isBefore=function(d,p){return this.endOf(p)<U(d)},v.$g=function(d,p,m){return D.u(d)?this[p]:this.set(m,d)},v.unix=function(){return Math.floor(this.valueOf()/1e3)},v.valueOf=function(){return this.$d.getTime()},v.startOf=function(d,p){var m=this,Y=!!D.u(p)||p,B=D.p(d),Z=function(ye,re){var me=D.w(m.$u?Date.UTC(m.$y,re,ye):new Date(m.$y,re,ye),m);return Y?me:me.endOf(z)},Q=function(ye,re){return D.w(m.toDate()[ye].apply(m.toDate("s"),(Y?[0,0,0,0]:[23,59,59,999]).slice(re)),m)},se=this.$W,te=this.$M,ae=this.$D,de="set"+(this.$u?"UTC":"");switch(B){case W:return Y?Z(1,0):Z(31,11);case I:return Y?Z(1,te):Z(0,te+1);case E:var fe=this.$locale().weekStart||0,be=(se<fe?se+7:se)-fe;return Z(Y?ae-be:ae+(6-be),te);case z:case g:return Q(de+"Hours",0);case _:return Q(de+"Minutes",1);case F:return Q(de+"Seconds",2);case j:return Q(de+"Milliseconds",3);default:return this.clone()}},v.endOf=function(d){return this.startOf(d,!1)},v.$set=function(d,p){var m,Y=D.p(d),B="set"+(this.$u?"UTC":""),Z=(m={},m[z]=B+"Date",m[g]=B+"Date",m[I]=B+"Month",m[W]=B+"FullYear",m[_]=B+"Hours",m[F]=B+"Minutes",m[j]=B+"Seconds",m[q]=B+"Milliseconds",m)[Y],Q=Y===z?this.$D+(p-this.$W):p;if(Y===I||Y===W){var se=this.clone().set(g,1);se.$d[Z](Q),se.init(),this.$d=se.set(g,Math.min(this.$D,se.daysInMonth())).$d}else Z&&this.$d[Z](Q);return this.init(),this},v.set=function(d,p){return this.clone().$set(d,p)},v.get=function(d){return this[D.p(d)]()},v.add=function(d,p){var m,Y=this;d=Number(d);var B=D.p(p),Z=function(te){var ae=U(Y);return D.w(ae.date(ae.date()+Math.round(te*d)),Y)};if(B===I)return this.set(I,this.$M+d);if(B===W)return this.set(W,this.$y+d);if(B===z)return Z(1);if(B===E)return Z(7);var Q=(m={},m[F]=R,m[_]=X,m[j]=l,m)[B]||1,se=this.$d.getTime()+d*Q;return D.w(se,this)},v.subtract=function(d,p){return this.add(-1*d,p)},v.format=function(d){var p=this,m=this.$locale();if(!this.isValid())return m.invalidDate||f;var Y=d||"YYYY-MM-DDTHH:mm:ssZ",B=D.z(this),Z=this.$H,Q=this.$m,se=this.$M,te=m.weekdays,ae=m.months,de=m.meridiem,fe=function(re,me,ke,ge){return re&&(re[me]||re(p,Y))||ke[me].slice(0,ge)},be=function(re){return D.s(Z%12||12,re,"0")},ye=de||function(re,me,ke){var ge=re<12?"AM":"PM";return ke?ge.toLowerCase():ge};return Y.replace(H,function(re,me){return me||function(ke){switch(ke){case"YY":return String(p.$y).slice(-2);case"YYYY":return D.s(p.$y,4,"0");case"M":return se+1;case"MM":return D.s(se+1,2,"0");case"MMM":return fe(m.monthsShort,se,ae,3);case"MMMM":return fe(ae,se);case"D":return p.$D;case"DD":return D.s(p.$D,2,"0");case"d":return String(p.$W);case"dd":return fe(m.weekdaysMin,p.$W,te,2);case"ddd":return fe(m.weekdaysShort,p.$W,te,3);case"dddd":return te[p.$W];case"H":return String(Z);case"HH":return D.s(Z,2,"0");case"h":return be(1);case"hh":return be(2);case"a":return ye(Z,Q,!0);case"A":return ye(Z,Q,!1);case"m":return String(Q);case"mm":return D.s(Q,2,"0");case"s":return String(p.$s);case"ss":return D.s(p.$s,2,"0");case"SSS":return D.s(p.$ms,3,"0");case"Z":return B}return null}(re)||B.replace(":","")})},v.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},v.diff=function(d,p,m){var Y,B=this,Z=D.p(p),Q=U(d),se=(Q.utcOffset()-this.utcOffset())*R,te=this-Q,ae=function(){return D.m(B,Q)};switch(Z){case W:Y=ae()/12;break;case I:Y=ae();break;case M:Y=ae()/3;break;case E:Y=(te-se)/6048e5;break;case z:Y=(te-se)/864e5;break;case _:Y=te/X;break;case F:Y=te/R;break;case j:Y=te/l;break;default:Y=te}return m?Y:D.a(Y)},v.daysInMonth=function(){return this.endOf(I).$D},v.$locale=function(){return u[this.$L]},v.locale=function(d,p){if(!d)return this.$L;var m=this.clone(),Y=L(d,p,!0);return Y&&(m.$L=Y),m},v.clone=function(){return D.w(this.$d,this)},v.toDate=function(){return new Date(this.valueOf())},v.toJSON=function(){return this.isValid()?this.toISOString():null},v.toISOString=function(){return this.$d.toISOString()},v.toString=function(){return this.$d.toUTCString()},C}(),_e=ve.prototype;return U.prototype=_e,[["$ms",q],["$s",j],["$m",F],["$H",_],["$W",z],["$M",I],["$y",W],["$D",g]].forEach(function(C){_e[C[1]]=function(v){return this.$g(v,C[0],C[1])}}),U.extend=function(C,v){return C.$i||(C(v,ve,U),C.$i=!0),U},U.locale=L,U.isDayjs=S,U.unix=function(C){return U(1e3*C)},U.en=u[x],U.Ls=u,U.p={},U})}(Pe)),Pe.exports}var Ht=nt();const le=ze(Ht);var it={exports:{}};(function(V,J){(function(l,R){V.exports=R()})(Oe,function(){return function(l,R,X){l=l||{};var q=R.prototype,j={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function F(z,E,I,M){return q.fromToBase(z,E,I,M)}X.en.relativeTime=j,q.fromToBase=function(z,E,I,M,W){for(var g,f,O,H=I.$locale().relativeTime||j,c=l.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],y=c.length,$=0;$<y;$+=1){var x=c[$];x.d&&(g=M?X(z).diff(I,x.d,!0):I.diff(z,x.d,!0));var u=(l.rounding||Math.round)(Math.abs(g));if(O=g>0,u<=x.r||!x.r){u<=1&&$>0&&(x=c[$-1]);var h=H[x.l];W&&(u=W(""+u)),f=typeof h=="string"?h.replace("%d",u):h(u,E,x.l,O);break}}if(E)return f;var S=O?H.future:H.past;return typeof S=="function"?S(f):S.replace("%s",f)},q.to=function(z,E){return F(z,E,this,!0)},q.from=function(z,E){return F(z,E,this)};var _=function(z){return z.$u?X.utc():X()};q.toNow=function(z){return this.to(_(this),z)},q.fromNow=function(z){return this.from(_(this),z)}}})})(it);var Lt=it.exports;const Ft=ze(Lt);var rt={exports:{}};(function(V,J){(function(l,R){V.exports=R()})(Oe,function(){var l="minute",R=/[+-]\d\d(?::?\d\d)?/g,X=/([+-]|\d\d)/g;return function(q,j,F){var _=j.prototype;F.utc=function(f){var O={date:f,utc:!0,args:arguments};return new j(O)},_.utc=function(f){var O=F(this.toDate(),{locale:this.$L,utc:!0});return f?O.add(this.utcOffset(),l):O},_.local=function(){return F(this.toDate(),{locale:this.$L,utc:!1})};var z=_.parse;_.parse=function(f){f.utc&&(this.$u=!0),this.$utils().u(f.$offset)||(this.$offset=f.$offset),z.call(this,f)};var E=_.init;_.init=function(){if(this.$u){var f=this.$d;this.$y=f.getUTCFullYear(),this.$M=f.getUTCMonth(),this.$D=f.getUTCDate(),this.$W=f.getUTCDay(),this.$H=f.getUTCHours(),this.$m=f.getUTCMinutes(),this.$s=f.getUTCSeconds(),this.$ms=f.getUTCMilliseconds()}else E.call(this)};var I=_.utcOffset;_.utcOffset=function(f,O){var H=this.$utils().u;if(H(f))return this.$u?0:H(this.$offset)?I.call(this):this.$offset;if(typeof f=="string"&&(f=function(x){x===void 0&&(x="");var u=x.match(R);if(!u)return null;var h=(""+u[0]).match(X)||["-",0,0],S=h[0],L=60*+h[1]+ +h[2];return L===0?0:S==="+"?L:-L}(f),f===null))return this;var c=Math.abs(f)<=16?60*f:f;if(c===0)return this.utc(O);var y=this.clone();if(O)return y.$offset=c,y.$u=!1,y;var $=this.$u?this.toDate().getTimezoneOffset():-1*this.utcOffset();return(y=this.local().add(c+$,l)).$offset=c,y.$x.$localOffset=$,y};var M=_.format;_.format=function(f){var O=f||(this.$u?"YYYY-MM-DDTHH:mm:ss[Z]":"");return M.call(this,O)},_.valueOf=function(){var f=this.$utils().u(this.$offset)?0:this.$offset+(this.$x.$localOffset||this.$d.getTimezoneOffset());return this.$d.valueOf()-6e4*f},_.isUTC=function(){return!!this.$u},_.toISOString=function(){return this.toDate().toISOString()},_.toString=function(){return this.toDate().toUTCString()};var W=_.toDate;_.toDate=function(f){return f==="s"&&this.$offset?F(this.format("YYYY-MM-DD HH:mm:ss:SSS")).toDate():W.call(this)};var g=_.diff;_.diff=function(f,O,H){if(f&&this.$u===f.$u)return g.call(this,f,O,H);var c=this.local(),y=F(f).local();return g.call(c,y,O,H)}}})})(rt);var Yt=rt.exports;const ot=ze(Yt);var at={exports:{}};(function(V,J){(function(l,R){V.exports=R()})(Oe,function(){var l={year:0,month:1,day:2,hour:3,minute:4,second:5},R={};return function(X,q,j){var F,_=function(M,W,g){g===void 0&&(g={});var f=new Date(M),O=function(H,c){c===void 0&&(c={});var y=c.timeZoneName||"short",$=H+"|"+y,x=R[$];return x||(x=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:H,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:y}),R[$]=x),x}(W,g);return O.formatToParts(f)},z=function(M,W){for(var g=_(M,W),f=[],O=0;O<g.length;O+=1){var H=g[O],c=H.type,y=H.value,$=l[c];$>=0&&(f[$]=parseInt(y,10))}var x=f[3],u=x===24?0:x,h=f[0]+"-"+f[1]+"-"+f[2]+" "+u+":"+f[4]+":"+f[5]+":000",S=+M;return(j.utc(h).valueOf()-(S-=S%1e3))/6e4},E=q.prototype;E.tz=function(M,W){M===void 0&&(M=F);var g,f=this.utcOffset(),O=this.toDate(),H=O.toLocaleString("en-US",{timeZone:M}),c=Math.round((O-new Date(H))/1e3/60),y=15*-Math.round(O.getTimezoneOffset()/15)-c;if(!Number(y))g=this.utcOffset(0,W);else if(g=j(H,{locale:this.$L}).$set("millisecond",this.$ms).utcOffset(y,!0),W){var $=g.utcOffset();g=g.add(f-$,"minute")}return g.$x.$timezone=M,g},E.offsetName=function(M){var W=this.$x.$timezone||j.tz.guess(),g=_(this.valueOf(),W,{timeZoneName:M}).find(function(f){return f.type.toLowerCase()==="timezonename"});return g&&g.value};var I=E.startOf;E.startOf=function(M,W){if(!this.$x||!this.$x.$timezone)return I.call(this,M,W);var g=j(this.format("YYYY-MM-DD HH:mm:ss:SSS"),{locale:this.$L});return I.call(g,M,W).tz(this.$x.$timezone,!0)},j.tz=function(M,W,g){var f=g&&W,O=g||W||F,H=z(+j(),O);if(typeof M!="string")return j(M).tz(O);var c=function(u,h,S){var L=u-60*h*1e3,U=z(L,S);if(h===U)return[L,h];var D=z(L-=60*(U-h)*1e3,S);return U===D?[L,U]:[u-60*Math.min(U,D)*1e3,Math.max(U,D)]}(j.utc(M,f).valueOf(),H,O),y=c[0],$=c[1],x=j(y).utcOffset($);return x.$x.$timezone=O,x},j.tz.guess=function(){return Intl.DateTimeFormat().resolvedOptions().timeZone},j.tz.setDefault=function(M){F=M}}})})(at);var Bt=at.exports;const lt=ze(Bt);var zt={exports:{}};(function(V,J){(function(l,R){V.exports=R(nt())})(Oe,function(l){function R(g){return g&&typeof g=="object"&&"default"in g?g:{default:g}}var X=R(l),q="января_февраля_марта_апреля_мая_июня_июля_августа_сентября_октября_ноября_декабря".split("_"),j="январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_"),F="янв._февр._мар._апр._мая_июня_июля_авг._сент._окт._нояб._дек.".split("_"),_="янв._февр._март_апр._май_июнь_июль_авг._сент._окт._нояб._дек.".split("_"),z=/D[oD]?(\[[^[\]]*\]|\s)+MMMM?/;function E(g,f,O){var H,c;return O==="m"?f?"минута":"минуту":g+" "+(H=+g,c={mm:f?"минута_минуты_минут":"минуту_минуты_минут",hh:"час_часа_часов",dd:"день_дня_дней",MM:"месяц_месяца_месяцев",yy:"год_года_лет"}[O].split("_"),H%10==1&&H%100!=11?c[0]:H%10>=2&&H%10<=4&&(H%100<10||H%100>=20)?c[1]:c[2])}var I=function(g,f){return z.test(f)?q[g.month()]:j[g.month()]};I.s=j,I.f=q;var M=function(g,f){return z.test(f)?F[g.month()]:_[g.month()]};M.s=_,M.f=F;var W={name:"ru",weekdays:"воскресенье_понедельник_вторник_среда_четверг_пятница_суббота".split("_"),weekdaysShort:"вск_пнд_втр_срд_чтв_птн_сбт".split("_"),weekdaysMin:"вс_пн_вт_ср_чт_пт_сб".split("_"),months:I,monthsShort:M,weekStart:1,yearStart:4,formats:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY г.",LLL:"D MMMM YYYY г., H:mm",LLLL:"dddd, D MMMM YYYY г., H:mm"},relativeTime:{future:"через %s",past:"%s назад",s:"несколько секунд",m:E,mm:E,h:"час",hh:E,d:"день",dd:E,M:"месяц",MM:E,y:"год",yy:E},ordinal:function(g){return g},meridiem:function(g){return g<4?"ночи":g<12?"утра":g<17?"дня":"вечера"}};return X.default.locale(W,null,!0),W})})(zt);const It={class:"dynamics-chart-container"},Nt={class:"text-sm font-semibold mb-2 flex items-center justify-between"},Ut={class:"text-xs opacity-70"},Et={class:"chart-svg-container"},Wt={class:"y-axis-labels"},Rt={class:"y-label"},Pt={class:"y-label"},Zt={class:"y-label"},Vt={class:"chart-svg-wrapper"},qt=["viewBox"],Gt=["y1","y2"],Jt=["y"],Xt=["y1","y2"],Kt=["points"],Qt=["cx","cy"],es={key:0,class:"mt-4"},ts={class:"dynamics-analysis"},ss={class:"analysis-text"},ns={key:0,class:"insight-box"},is={class:"insight-text"},rs={key:1,class:"mt-3 text-xs opacity-80 leading-relaxed"},os={class:"pagination-dots"},as=["onClick"],Ce=300,je=80,De=6,ls=Be({__name:"DynamicsChart",props:{dynamics:{},userAge:{},userGender:{}},setup(V){const J=V,l=ie(0),R=ie(0),X=ie(0),q=ie("slide-left"),j=k(()=>J.dynamics[l.value]||{metric:"",values:[],interpretation:""}),F=k(()=>j.value.values||[]),_=k(()=>{if(!J.dynamics||J.dynamics.length===0)return{min:0,max:10,labels:[10,5,0]};const c=[];if(J.dynamics.forEach(u=>{Array.isArray(u.values)&&c.push(...u.values)}),c.length===0)return{min:0,max:10,labels:[10,5,0]};const y=Math.floor(Math.min(...c)),$=Math.ceil(Math.max(...c)),x=[$,Math.round(($+y)/2),y];return{min:y,max:$,labels:x}}),z=k(()=>{var u;const c=j.value.metric;if(!J.userAge||!J.userGender)return null;const $=(u={Персонажи:{"18-24":{male:6.5,female:7},"25-34":{male:6,female:6.5},"35-44":{male:5.5,female:6},"45+":{male:5,female:5.5}},Эмоции:{"18-24":{male:6,female:7},"25-34":{male:5.5,female:6.5},"35-44":{male:5,female:6},"45+":{male:4.5,female:5.5}},Действия:{"18-24":{male:7,female:6.5},"25-34":{male:6.5,female:6},"35-44":{male:6,female:5.5},"45+":{male:5.5,female:5}},Сцены:{"18-24":{male:6.5,female:6.5},"25-34":{male:6,female:6},"35-44":{male:5.5,female:5.5},"45+":{male:5,female:5}}}[c])==null?void 0:u[J.userAge];if(!$)return null;const x=$[J.userGender];return x===void 0?null:x}),E=k(()=>{const c=z.value;if(c===null)return null;const{min:y,max:$}=_.value,x=je-De*2,u=(c-y)/($-y);return De+x-u*x}),I=k(()=>{const c=F.value;if(c.length===0)return[];const{min:y,max:$}=_.value,x=Ce-De*2,u=je-De*2,h=c.length>1?x/(c.length-1):0;return c.map((S,L)=>{const U=(S-y)/($-y);return{x:De+L*h,y:De+u-U*u}})}),M=k(()=>I.value.map(c=>`${c.x},${c.y}`).join(" "));function W(c){R.value=c.touches[0].clientX}function g(c){X.value=c.touches[0].clientX}function f(){const c=R.value-X.value;Math.abs(c)>50&&(c>0&&l.value<J.dynamics.length-1?(q.value="slide-left",l.value++,H()):c<0&&l.value>0&&(q.value="slide-right",l.value--,H())),R.value=0,X.value=0}function O(c){c!==l.value&&(q.value=c>l.value?"slide-left":"slide-right",l.value=c,H())}function H(){window.triggerHaptic&&window.triggerHaptic("light")}return(c,y)=>(r(),o("div",It,[s("div",{class:"chart-wrapper",onTouchstart:W,onTouchmove:g,onTouchend:f},[Ae(wt,{name:q.value,mode:"out-in"},{default:kt(()=>[(r(),o("div",{key:l.value,class:"chart-content"},[s("div",Nt,[s("span",null,A(j.value.category||j.value.metric),1),s("span",Ut,A(F.value[F.value.length-1]),1)]),s("div",Et,[s("div",Wt,[s("span",Rt,A(_.value.labels[0]),1),s("span",Pt,A(_.value.labels[1]),1),s("span",Zt,A(_.value.labels[2]),1)]),s("div",Vt,[(r(),o("svg",{viewBox:`0 0 ${Ce} ${je}`,class:"chart-svg",preserveAspectRatio:"xMidYMid meet"},[(r(),o(K,null,ne(3,$=>s("line",{key:`grid-${$}`,x1:0,x2:Ce,y1:je/2*($-1),y2:je/2*($-1),stroke:"white","stroke-opacity":"0.15","stroke-width":"1"},null,8,Gt)),64)),E.value!==null?(r(),o("rect",{key:0,x:0,y:E.value-8,width:Ce,height:16,fill:"yellow",opacity:"0.15"},null,8,Jt)):N("",!0),E.value!==null?(r(),o("line",{key:1,x1:0,x2:Ce,y1:E.value,y2:E.value,stroke:"yellow","stroke-opacity":"0.6","stroke-width":"1.5","stroke-dasharray":"4,3"},null,8,Xt)):N("",!0),s("polyline",{points:M.value,fill:"none",stroke:"white","stroke-width":"2.5","stroke-linejoin":"round","stroke-linecap":"round"},null,8,Kt),(r(!0),o(K,null,ne(I.value,($,x)=>(r(),o("circle",{key:`point-${x}`,cx:$.x,cy:$.y,r:"4",fill:"white","vector-effect":"non-scaling-stroke"},null,8,Qt))),128))],8,qt))])]),j.value.analysis?(r(),o("div",es,[s("div",ts,[s("p",ss,A(j.value.analysis),1),j.value.insight?(r(),o("div",ns,[y[0]||(y[0]=s("span",{class:"insight-icon"},"💡",-1)),s("p",is,A(j.value.insight),1)])):N("",!0)])])):j.value.interpretation?(r(),o("div",rs,A(j.value.interpretation),1)):N("",!0)]))]),_:1},8,["name"])],32),s("div",os,[(r(!0),o(K,null,ne(V.dynamics,($,x)=>(r(),o("button",{key:`dot-${x}`,class:he(["dot",{active:x===l.value}]),onClick:u=>O(x)},null,10,as))),128))])]))}}),tt=Ie(ls,[["__scopeId","data-v-ac484404"]]),cs=[{keys:["вода","море","река","волна","дожд","океан"],emoji:"🌊"},{keys:["лет","полет","полетать","летать","небо","птиц","самолет"],emoji:"🕊️"},{keys:["погон","убег","догон","преслед"],emoji:"🏃‍♂️"},{keys:["экзам","контрол","тест","урок","школ","учеб","универ"],emoji:"📝"},{keys:["деньг","кошелек","кошель","кошелёк","банк","кредит"],emoji:"💰"},{keys:["любов","поцел","роман","пар","серд"],emoji:"❤️"},{keys:["дом","квартир","комнат","двор","жиль"],emoji:"🏠"},{keys:["работ","офис","началь","коллег"],emoji:"💼"},{keys:["школ","класс","урок"],emoji:"🏫"},{keys:["кот","кошка"],emoji:"🐱"},{keys:["собак","пёс","пес"],emoji:"🐶"},{keys:["зуб","зубы"],emoji:"🦷"},{keys:["темнот","ноч","тьма"],emoji:"🌑"},{keys:["смерт","похорон","кладбищ"],emoji:"🕯️"},{keys:["рожд","младен","ребен","малыш","дет"],emoji:"👶"},{keys:["лес","дерев","парк","природ"],emoji:"🌲"},{keys:["огонь","пожар","жар"],emoji:"🔥"},{keys:["зме","дракон"],emoji:"🐍"},{keys:["путешеств","дорог","путь","троп"],emoji:"🧭"}];function us(V){try{const J=String(V||"").toLowerCase();for(const l of cs)if(l.keys.some(R=>J.includes(R)))return l.emoji;return"💤"}catch{return"💤"}}const ds={key:0,class:"flex items-center gap-4 py-2 min-h-[3.5rem]"},fs={class:"text-3xl shrink-0"},hs={class:"flex-1 min-w-0"},ms={class:"truncate font-semibold leading-tight text-base"},ps={class:"text-sm opacity-80 leading-tight mt-0.5"},vs={key:1,class:"mt-4 space-y-6 fade-seq is-open"},ys={key:0,class:"space-y-2"},gs={class:"text-[32px] font-bold leading-tight"},xs={class:"text-base opacity-80"},_s={key:0,class:"flex flex-wrap gap-2 pt-2"},bs={key:0,class:"space-y-4"},ws={class:"text-white/90 space-y-5"},ks={key:0,class:"text-lg opacity-90 leading-snug pb-4 border-b border-white/10"},$s={class:"flex items-baseline gap-2"},Ms={class:"font-bold text-xl"},Ss={class:"text-base opacity-60 bg-white/15 px-2 py-0.5 rounded-full"},Ds={class:"text-lg opacity-90 leading-snug"},Ts={class:"text-base opacity-60 leading-tight bg-white/5 rounded-lg px-3 py-2"},Cs={key:1,class:"space-y-4"},js={class:"text-white/90"},As={key:2,class:"space-y-4"},Os={class:"text-white/90 space-y-5"},Hs={key:0,class:"text-lg opacity-90 leading-snug"},Ls={key:1,class:"text-lg opacity-90 leading-snug"},Fs={key:2,class:"text-lg opacity-90 leading-snug"},Ys={key:3,class:"bg-white/10 rounded-lg p-4 space-y-3 mt-5"},Bs={class:"font-bold text-xl opacity-95 flex items-center gap-2"},zs={class:"text-lg opacity-90 leading-snug"},Is={key:0,class:"text-base opacity-60 leading-tight"},Ns={class:"rounded-lg bg-white/10"},Us={class:"px-3 pb-3 text-white/90 leading-snug space-y-2"},Es=["innerHTML"],Ws={key:0,class:"rounded-lg bg-white/10"},Rs={class:"px-3 pb-3"},Ps={class:"flex flex-wrap gap-2"},Zs={key:1,class:"rounded-lg bg-white/10"},Vs={class:"px-3 pb-3 text-white/90 leading-snug"},qs={key:2,class:"rounded-lg bg-white/10"},Gs={class:"px-3 pb-3 text-white/90 leading-snug"},Js={class:"list-decimal pl-5 space-y-2"},Xs={key:3,class:"rounded-lg bg-white/10"},Ks={class:"px-3 pb-3 text-white/90 leading-snug"},Qs={class:"list-decimal pl-5 space-y-3"},en={key:0},tn={class:"font-semibold mb-1"},sn={class:"opacity-90"},nn={key:0,class:"opacity-80 mt-1 italic"},rn={key:1},on={key:0,class:"rounded-lg bg-white/10"},an={class:"px-3 pb-3 text-white/90 leading-snug"},ln={class:"list-decimal pl-5 space-y-2"},cn={key:1,class:"rounded-lg bg-white/10"},un={class:"px-3 pb-3 text-white/90 leading-snug"},dn={class:"list-decimal pl-5 space-y-3"},fn={key:0},hn={class:"font-semibold mb-1"},mn={class:"opacity-90"},pn={key:0,class:"opacity-80 mt-1 italic"},vn={key:1},yn={class:"relative border-l-4 border-pink-400 pl-4 space-y-2"},gn={class:"text-white/90"},xn={class:"flex justify-end pt-1"},_n={class:"space-y-3"},bn={key:0,class:"rounded-lg bg-white/10"},wn={class:"px-4 pb-4 text-white/90 space-y-4"},kn={class:"space-y-4"},$n={class:"flex justify-between text-lg leading-tight"},Mn={class:"font-medium"},Sn={class:"opacity-90"},Dn={class:"relative h-2 w-full bg-white/10 rounded overflow-hidden"},Tn={class:"pt-1 text-base opacity-80 flex flex-wrap items-center gap-3"},Cn={class:"inline-flex items-center gap-2"},jn={class:"leading-tight"},An={key:0,class:"rounded-lg bg-white/10"},On={class:"text-xl font-semibold px-4 py-3"},Hn={class:"px-4 pb-4 text-white/90 space-y-3"},Ln=["innerHTML"],Fn={key:0,class:"mt-3 pt-3 border-t border-white/10"},Yn={class:"text-xl"},Bn=["innerHTML"],zn={class:"space-y-3"},In={key:0,class:"rounded-lg bg-white/10"},Nn={class:"text-xl font-semibold px-4 py-3"},Un={class:"px-4 pb-4 text-white/90"},En=["innerHTML"],Wn={class:"mt-4 flex gap-2"},Rn={key:3,class:"mt-3 text-xs bg-black/20 rounded-lg p-2 font-mono whitespace-pre-wrap break-words"},Pn={class:"mt-2 flex justify-end"},Zn={key:0,class:"space-y-3"},Vn={class:"grid grid-cols-2 gap-2"},qn=["onClick"],Gn={class:"flex justify-end gap-2 pt-2"},Jn=["disabled"],Xn={key:1,class:"space-y-3"},Kn={class:"grid grid-cols-2 gap-2"},Qn={class:"flex justify-end gap-2 pt-2"},ei=["disabled"],ti=48,si=Be({__name:"DreamCard",props:{dream:{},active:{type:Boolean},overlayMode:{type:Boolean}},emits:["toggle","open"],setup(V,{emit:J}){le.extend(Ft),le.locale("ru"),le.extend(ot),le.extend(lt);const l=V,R=J,X=ie(null),q=()=>{const e=(()=>{var t;try{return Math.round(((t=X.value)==null?void 0:t.getBoundingClientRect().top)??0)}catch{return 0}})();R("open",{y:e})},j=()=>{l.overlayMode||(q(),window.triggerHaptic&&window.triggerHaptic("light"))},F=$t(),_=Mt(),z=k(()=>{var e;return!!((e=l.dream)!=null&&e.is_deep_analysis)}),E=k(()=>us(u.value)),I=k({get:()=>{var e,t,i;return((e=l.dream)==null?void 0:e.user_feedback)??((i=(t=l.dream)==null?void 0:t.deep_source)==null?void 0:i.user_feedback)??0},set:e=>{l.dream&&(l.dream.user_feedback=e,l.dream.deep_source||(l.dream.deep_source={}),l.dream.deep_source.user_feedback=e)}}),M={like:!1,dislike:!1,delete:!1},W=async e=>{if(M.like||M.dislike)return;const t=e===1?I.value===1?0:1:I.value===2?0:2,i=I.value;I.value=t;try{window.triggerHaptic&&window.triggerHaptic("medium"),e===1?M.like=!0:M.dislike=!0,await Re.postAnalysisFeedback(l.dream.id,t),t===0?_.info("Оценка снята"):t===1?_.success("Добавлено: нравится"):t===2&&_.success("Добавлено: не нравится")}catch(a){I.value=i,console.error("Feedback error",a),_.error("Не удалось сохранить оценку")}finally{M.like=M.dislike=!1}},g=()=>W(1),f=()=>W(2),O=async()=>{var i;if(M.delete)return;const e=(i=window.Telegram)==null?void 0:i.WebApp;if(await new Promise(a=>{e!=null&&e.showPopup?e.showPopup({title:"Удалить запись?",message:"Действие необратимо",buttons:[{id:"yes",type:"destructive",text:"Удалить"},{id:"no",type:"cancel",text:"Отмена"}]},w=>a(w==="yes")):a(window.confirm("Удалить запись?"))}))try{M.delete=!0,window.triggerHaptic&&window.triggerHaptic("heavy"),await Re.deleteAnalysis(l.dream.id);const a=F.history.findIndex(w=>w.id===l.dream.id);a>-1&&F.history.splice(a,1),F.fetchProfile(),_.success("Запись удалена")}catch(a){console.error("Delete error",a),_.error("Не удалось удалить запись")}finally{M.delete=!1}},H=new Set(["и","в","во","не","что","он","на","я","с","со","как","а","то","все","она","так","его","но","да","ты","к","у","же","вы","за","бы","по","ее","мне","было","вот","от","меня","еще","нет","о","из","ему","теперь","когда","даже","ну","вдруг","ли","если","уже","или","ни","быть","был","него","до","вас","нибудь","опять","уж","вам","ведь","там","потом","себя","ничего","ей","может","они","тут","где","есть","надо","ней","для","мы","тебя","их","чем","была","сам","чтоб","без","будто","чего","раз","тоже","себе","под","будет","ж","тогда","кто","этот","того","потому","этого","какой","совсем","ним","здесь","этом","один","почти","мой","тем","чтобы","нее","кажется","сейчас","были","куда","зачем","всех","никогда","можно","при","наконец","два","об","другой","хоть","после","над","больше","тот","через","эти","нас","про","всего","них","какая","много","разве","три","эту","моя","впрочем","хорошо","свою","этой","перед","иногда","лучше","чуть","том","нельзя","такой","им","более","всегда","конечно","всю","между"]);function c(e){return e.replace(/\s+/g," ").trim().split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function y(e){if(!e)return"";const t=String(e).split(/[.!?\n]/)[0],a=t.toLowerCase().replace(/[^\p{L}\p{N}\s-]/gu,"").split(/\s+/).filter(w=>w&&!H.has(w)&&w.length>3).slice(0,3);return a.length===0?t.slice(0,40):c(a.join(" "))}function $(e){if(!e)return"";let t=String(e).toLowerCase().replace(/["'«»]/g,"").trim();t=t.replace(/^(приснилось|снилось|сон о|сон про|сон|мне снится|мне приснилось)\s+/i,""),t=t.replace(/\s+/g," ").trim();const i=t.split(" ").filter(Boolean).slice(0,3);return i.length?i.join(" "):""}function x(e){if(!e)return"";const t=String(e).toLowerCase();return t.charAt(0).toUpperCase()+t.slice(1)}const u=k(()=>{var T,n,b,P,G;const e=$((n=(T=l.dream)==null?void 0:T.deep_source)==null?void 0:n.title);if(e)return x(e);const t=(((P=(b=l.dream)==null?void 0:b.deep_source)==null?void 0:P.tags)||[]).filter(Boolean),i=oe=>{var pe;let ce=String(oe||"").trim();return ce=((pe=ce.split(/[\\/,(;:—–-]/)[0])==null?void 0:pe.trim())||"",ce?ce.charAt(0).toUpperCase()+ce.slice(1).toLowerCase():""},a=t.map(i).filter(Boolean);if(a.length){const oe=a.slice(0,2).join(" и ");return x(oe||"Без названия")}const w=$(y((G=l.dream)==null?void 0:G.dream_text));return x(w||"Без названия")}),h=k(()=>{var i,a;const e=(a=(i=l.dream)==null?void 0:i.deep_source)==null?void 0:a.tags;if(!Array.isArray(e))return[];const t=w=>{var n;let T=String(w||"").trim();return T=((n=T.split(/[\\/,(;:—–-]/)[0])==null?void 0:n.trim())||"",T?T.charAt(0).toUpperCase()+T.slice(1).toLowerCase():""};return e.map(t).filter(Boolean).slice(0,5)});function S(e){return String(e||"").replace(/^```[\s\S]*?\n/,"").replace(/```$/,"").replace(/\(\s*\d+\s*\)/g,"").replace(/\s\[\s*\d+\s*\]/g,"").replace(/[\u00B9\u00B2\u00B3\u2070-\u2079]/g,"")}ie("context");const L=k(()=>{var e;return S(((e=l.dream)==null?void 0:e.analysis)||"")}),U=k(()=>{var e,t;return((t=(e=l.dream)==null?void 0:e.deep_source)==null?void 0:t.overallContext)||{}});k(()=>{const e=U.value;return!!(e!=null&&e.narrative||e!=null&&e.psychologicalFunction||e!=null&&e.emotionalJourney)});const D=k(()=>{var e,t;return((t=(e=l.dream)==null?void 0:e.deep_source)==null?void 0:t.symbolsIntro)||""}),ve=k(()=>{var t,i;const e=(i=(t=l.dream)==null?void 0:t.deep_source)==null?void 0:i.recurringSymbols;return Array.isArray(e)?e:[]}),_e=k(()=>ve.value.filter(e=>e.frequency>=2)),C=k(()=>_e.value.length>0),v=k(()=>{var t,i;const e=(i=(t=l.dream)==null?void 0:t.deep_source)==null?void 0:i.dynamicsContext;return Array.isArray(e)?e:[]}),d=k(()=>v.value.length>0),p=k(()=>{var e,t;return((t=(e=l.dream)==null?void 0:e.deep_source)==null?void 0:t.conclusion)||{}}),m=k(()=>{const e=p.value;return!!(e!=null&&e.periodThemes||e!=null&&e.dreamFunctionsAnalysis||e!=null&&e.psychologicalSupport||e!=null&&e.integrationExercise)}),Y=k(()=>{var t,i;const e=(i=(t=l.dream)==null?void 0:t.deep_source)==null?void 0:i.dynamics;return Array.isArray(e)&&e.length>0?e:[]});k(()=>Y.value.length>0);const B=k(()=>{var t,i;const e=(i=(t=l.dream)==null?void 0:t.deep_source)==null?void 0:i.conclusions;return Array.isArray(e)&&e.length>0?e:[]});k(()=>B.value.length>0);const Z=k(()=>{var n,b;const e=(b=(n=l.dream)==null?void 0:n.deep_source)==null?void 0:b.recommendations;if(Array.isArray(e)&&e.length>0&&typeof e[0]=="object")return e;if(Array.isArray(e)&&e.length>0)return e.map((P,G)=>({title:`Рекомендация ${G+1}`,description:String(P),rationale:""}));const t=de.value;if(t.length===0)return[];const i=[0,0,0,0];for(const P of t)for(let G=0;G<4;G++)i[G]+=P[G];const a=Math.max(1,t.length);for(let P=0;P<4;P++)i[P]=Math.round(i[P]/a);const w=[["Персонажи","Обрати внимание на отношения и роли; практикуй честную коммуникацию."],["Эмоции","Добавь ежедневную регуляцию эмоций (дыхание, дневник, прогулка)."],["Действия","Определи 1 маленький шаг на неделю и заверши его."],["Сцены","Проверь границы и режим: место/время, где тебе спокойнее."]],T=i.map((P,G)=>({i:G,v:P})).sort((P,G)=>G.v-P.v).map(P=>P.i);return[{title:w[T[0]][0],description:w[T[0]][1],rationale:""},{title:w[T[1]][0],description:w[T[1]][1],rationale:""}]});k(()=>Z.value.length>0);function Q(e,t){var i;try{let a=e;const w=Array.from(new Set((t||[]).filter(Boolean))).sort((T,n)=>n.length-T.length);for(const T of w){const n=(i=String(T).split(/[\\/,(;:—–-]/)[0])==null?void 0:i.trim();if(!n)continue;const b=new RegExp(`(\b${n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\b)`,"gi");a=a.replace(b,'<mark class="bg-white/20 px-1 rounded">$1</mark>')}return a.replace(/\n\n+/g,'</p><p class="mt-2">').replace(/\n/g,"<br>").replace(/^(.+)$/,"<p>$1")}catch{return e}}const se=k(()=>{var e,t;return Q(L.value,((t=(e=l.dream)==null?void 0:e.deep_source)==null?void 0:t.tags)||[])});function te(e){try{return new Date(e).getTime()||0}catch{return 0}}const ae=k(()=>(F.history||[]).filter(e=>{var t;return!e.is_deep_analysis&&((t=e==null?void 0:e.deep_source)==null?void 0:t.hvdc)&&(e==null?void 0:e.created_at)}).sort((e,t)=>te(e.created_at)>te(t.created_at)?-1:1)),de=k(()=>{var a;const e=te(((a=l.dream)==null?void 0:a.created_at)||""),t=ae.value.filter(w=>!z.value||(e?te(w.created_at)<=e:!0)).slice(0,5).reverse(),i=["characters","emotions","actions","settings"];return t.map(w=>i.map(T=>{var n,b;return Number(((b=(n=w.deep_source.hvdc)==null?void 0:n.distribution)==null?void 0:b[T])||0)}))}),fe=k(()=>de.value.length),be=k(()=>fe.value>=2),ye=k(()=>Math.max(60,(fe.value-1)*28+8));function re(e){const t=e.length,i=ye.value,a=ti,w=t>1?(i-8)/(t-1):0,T=[];for(let b=0;b<t;b++){const P=b*w,G=a-Math.round(e[b]/100*a);T.push({x:P,y:G})}return{str:T.map(b=>`${b.x},${b.y}`).join(" "),pts:T}}k(()=>{const e=[{key:"characters",label:"Персонажи",idx:0,opacity:.95},{key:"emotions",label:"Эмоции",idx:1,opacity:.75},{key:"actions",label:"Действия",idx:2,opacity:.55},{key:"settings",label:"Сцены",idx:3,opacity:.35}],t=[],i=de.value;for(const a of e){const w=i.map(b=>b[a.idx]),{str:T,pts:n}=re(w);t.push({key:a.key,label:a.label,values:w,points:T,pointList:n,opacity:a.opacity})}return t});const me=k(()=>{if(!be.value)return[];if(d.value)return v.value.map(i=>({metric:i.category||i.metric,values:i.values||[],interpretation:i.analysis||i.interpretation||"",insight:i.insight||""}));const e=[{key:"characters",label:"Персонажи",idx:0},{key:"emotions",label:"Эмоции",idx:1},{key:"actions",label:"Действия",idx:2},{key:"settings",label:"Сцены",idx:3}],t=de.value;return e.map(i=>({metric:i.label,values:t.map(a=>a[i.idx]),interpretation:`Динамика "${i.label}" по последним ${fe.value} снам`}))});function ke(e){const i=e.split(/\n+/).map(a=>a.trim()).filter(Boolean).filter(a=>/^\d+\./.test(a)).map(a=>a.replace(/^\d+\.\s*/,"")).slice(0,3);return i.length?i:e.split(/[.!?]\s+/).map(a=>a.trim()).filter(Boolean).slice(0,3)}const ge=k(()=>ke(L.value));function ct(e){try{const t=String(e||"").toLowerCase(),i=$e=>$e.reduce((We,bt)=>We+(t.includes(bt)?1:0),0),a=["страх","ужас","паник","тревог","стыд","гнев","плак","слез","кошмар","тоска","грусть"],w=["экзам","выступл","собесед","защит","проект","подготов","завтра","ожидан","волнен","поездк","путешеств","нов","интервью"],T=["вчера","сегодня","работ","школ","универ","дом","улиц","друг","родител","коллег","город"],n=i(a),b=i(w),P=i(T);let G=n>0?Math.min(1,n/3):0,oe=b>0?Math.min(1,b/3):0,ce=P>0?Math.min(1,.5+P/5):0;G===0&&oe===0&&ce===0&&(ce=.6,G=.2,oe=.2);const pe={schema:"dream_type_v1",scores:{memory:+ce.toFixed(2),emotion:+G.toFixed(2),anticipation:+oe.toFixed(2)}},ee=[["memory",pe.scores.memory],["emotion",pe.scores.emotion],["anticipation",pe.scores.anticipation]];ee.sort(($e,We)=>We[1]-$e[1]);const xe=+Math.max(0,ee[0][1]-ee[1][1]).toFixed(2);return{...pe,dominant:ee[0][0],confidence:xe}}catch{return null}}const Ve=k(()=>{var e,t,i;return((t=(e=l.dream)==null?void 0:e.deep_source)==null?void 0:t.dream_type)||ct((i=l.dream)==null?void 0:i.dream_text)||null});function ut(){const e=Ve.value,t=e!=null&&e.dominant?String(e.dominant).toLowerCase():null;let i="💭",a="Функциональное упражнение",w="Работа со сном для интеграции опыта",T="Заметь",n="Какие 2–3 образа из сна самые сильные? Запиши их коротко.",b="Шаг",P="Выбери один маленький шаг в реальности, который поддержит тебя по теме сна.",G="✏️",oe="🎯";return t==="memory"?(i="🌙",a="Сон-Память",w="Переработка недавнего опыта, соединение нового с прошлым",T="Отрази",G="💭",n="Вспомни, что происходило последние 1–2 дня. Какие события могли попасть в сон?",b="Соедини",oe="🔗",P="Отметь, какие элементы сна перекликаются с реальностью — это завершает «архивацию» опыта."):t==="emotion"?(i="⚡️",a="Сон-Эмоция",w="Проживание и нейтрализация сильных чувств",T="Почувствуй",G="✋",n="Определи, какая эмоция была самой сильной во сне. Где она чувствуется в теле сейчас?",b="Услышь",oe="💬",P="Представь, что главный персонаж сна говорит тебе что-то. Что он хочет, чтобы ты понял?"):t==="anticipation"&&(i="🔮",a="Сон-Предвосхищение",w="Тренировка будущих ситуаций и реакций",T="Представь",G="⚡",n="Как бы ты хотел повести себя, если бы это произошло в реальности?",b="Расшифруй",oe="⭐",P="Какой символ кажется ключевым? Что он может говорить о твоих страхах или намерениях?"),['<div class="space-y-4">','<div class="bg-white/10 rounded-xl p-4 space-y-2">',`<div class="flex items-center gap-2"><span class="text-2xl">${i}</span><span class="font-bold text-xl">${a}</span></div>`,`<p class="text-base opacity-90 leading-snug">${w}</p>`,"</div>",'<div class="bg-white/10 rounded-xl p-4 space-y-2">',`<div class="flex items-center gap-2"><span class="text-2xl">${G}</span><span class="font-bold text-xl">${T}</span></div>`,`<p class="text-base opacity-90 leading-snug">${n}</p>`,"</div>",'<div class="bg-white/10 rounded-xl p-4 space-y-2">',`<div class="flex items-center gap-2"><span class="text-2xl">${oe}</span><span class="font-bold text-xl">${b}</span></div>`,`<p class="text-base opacity-90 leading-snug">${P}</p>`,"</div>","</div>"].join("")}const qe=k(()=>{var oe,ce,pe;const e=S(((oe=l.dream)==null?void 0:oe.analysis)||"");if(!e)return[];const t={arch:{key:"arch",title:"Архетипическая история",text:""},func:{key:"func",title:"Возможная функция сна",text:""},freud:{key:"freud",title:"По Фрейду",text:""},jung:{key:"jung",title:"По Юнгу",text:""}},i=[],a=/\*\*([^*]+)\*\*/g;let w;for(;w=a.exec(e);)i.push({title:w[1].trim(),start:w.index,end:w.index+w[0].length});const T=((ce=i[0])==null?void 0:ce.start)??e.length;t.arch.text=e.slice(0,T).trim();for(let ee=0;ee<i.length;ee++){const xe=i[ee].title.toLowerCase(),$e=e.slice(i[ee].end,((pe=i[ee+1])==null?void 0:pe.start)??e.length).trim();xe.includes("возможная функция")?t.func.text=$e:xe.includes("по фрейду")?t.freud.text=$e:xe.includes("по юнгу")&&(t.jung.text=$e)}const n=ee=>ee.replace(/\n\n+/g,'</p><p class="mt-2">').replace(/\n/g,"<br>").replace(/^(.+)$/,"<p>$1"),b=Object.values(t).map(ee=>({...ee,html:n(ee.text||"")}));b.some(ee=>ee.key==="func")||b.push({key:"func",title:"Возможная функция сна",text:"",html:""});const P=b.findIndex(ee=>ee.key==="arch");P!==-1&&b.splice(P+1,0,{key:"hvdc",title:"Контент анализ",text:"",html:""});const G=ut();if(G){const ee=b.findIndex(xe=>xe.key==="func");if(ee!==-1){const xe=['<div class="mt-3 pt-2 border-t border-white/10 space-y-1">','<div class="font-semibold">Функциональное упражнение</div>',G,"</div>"].join("");b[ee].html=(b[ee].html||"")+xe}}return b}),Me=St({arch:!0,hvdc:!1,func:!1,freud:!1,jung:!1,symbols:!0,dynamics:!0,conclusion:!0,dreamText:!1,funcExercise:!1});function Ge(e){Me[e]=!Me[e]}function dt(e){const t=e.indexOf('<div class="mt-3 pt-2 border-t');return t===-1?e:e.substring(0,t)}function Je(e){const t=e.indexOf('<div class="mt-3 pt-2 border-t');if(t===-1)return"";let i=e.substring(t,e.lastIndexOf("</div>")+6);return i=i.replace(/<div class="font-semibold">Функциональное упражнение<\/div>/g,""),i}const Xe=k(()=>{try{return new URLSearchParams(window.location.search).get("debug")==="1"||localStorage.getItem("da_debug")==="1"}catch{return!1}});function ft(){var e,t,i,a,w;try{const T=JSON.stringify(Ne.value,null,2);(e=navigator.clipboard)==null||e.writeText(T),(t=_==null?void 0:_.success)==null||t.call(_,"Скопировано")}catch{try{(w=(a=(i=window.Telegram)==null?void 0:i.WebApp)==null?void 0:a.showPopup)==null||w.call(a,{title:"Debug",message:"Скопируйте из блока ниже вручную",buttons:[{id:"ok",type:"default",text:"OK"}]})}catch{}}}function ht(e){var i;let t=String(e||"").trim();return t=((i=t.split(/[\\/,(;:—–-]/)[0])==null?void 0:i.trim())||"",t?t.charAt(0).toUpperCase()+t.slice(1).toLowerCase():""}const Ne=k(()=>{var i,a,w,T;if(!Xe.value)return null;const e=l.dream||{},t=Array.isArray((i=e==null?void 0:e.deep_source)==null?void 0:i.tags)?e.deep_source.tags:[];return{id:e.id,created_at:e.created_at,is_deep_analysis:!!e.is_deep_analysis,title_raw:((a=e==null?void 0:e.deep_source)==null?void 0:a.title)||null,tags_raw:t,tags_norm:t.map(ht),dream_type:((w=e==null?void 0:e.deep_source)==null?void 0:w.dream_type)||null,hvdc_present:!!((T=e==null?void 0:e.deep_source)!=null&&T.hvdc)}}),Ue=ie(!1),Ke=ie(1),mt=["0-20","20-30","30-40","40-50","50+"],He=ie(""),Se=ie("");function Ee(){Ue.value=!1}async function pt(){try{await Re.setDemographics(He.value,Se.value);try{await F.fetchProfile()}catch{}_.success("Готово! Дальнейшие анализы будут учитывать эти данные"),Ue.value=!1}catch{_.error("Не удалось сохранить")}}k(()=>{const e=F.profile||{};return!!(e.age_range&&e.gender)});const Te=k(()=>{var e,t;return((t=(e=l.dream)==null?void 0:e.deep_source)==null?void 0:t.hvdc)||null}),vt=k(()=>{var w,T,n;const e=[{key:"characters",label:"Персонажи"},{key:"emotions",label:"Эмоции"},{key:"actions",label:"Действия"},{key:"settings",label:"Сцены"}],t=((w=Te.value)==null?void 0:w.distribution)||{},i=((T=Te.value)==null?void 0:T.norm)||null,a=((n=Te.value)==null?void 0:n.comparison)||null;return e.map(b=>({key:b.key,label:b.label,value:Number(t[b.key]??0),norm:i?Number(i[b.key]??0):null,delta:a?Number(a[b.key]??0):null}))}),yt=k(()=>{var n;const e=((n=Te.value)==null?void 0:n.norm_group)||null;if(!e)return"общая статистика";const t=String(e.gender||"").toLowerCase(),i=t==="male"?"муж.":t==="female"?"жен.":"",a=e.age_range||"",w=a?`${a} лет`:"",T=[i,w].filter(Boolean).join(" ");return T?`общая статистика* для ${T}`:"общая статистика"});function Le(e,t){const i=Math.abs(e)%100,a=i%10;return i>10&&i<20?t[2]:a>1&&a<5?t[1]:a===1?t[0]:t[2]}const gt=k(()=>{if(!l.dream.created_at)return"";try{const e=Intl.DateTimeFormat().resolvedOptions().timeZone||le.tz.guess(),t=le.utc(l.dream.created_at).tz(e).startOf("day"),a=le().tz(e).startOf("day").diff(t,"day");if(a===0)return"сегодня";if(a===1)return"вчера";if(a<7){const P=Le(a,["день","дня","дней"]);return`${a} ${P} назад`}const w=Math.floor(a/7);if(a<30){const P=Le(w,["неделя","недели","недель"]);return`${w} ${P} назад`}const T=Math.floor(a/30);if(a<365){const P=Le(T,["месяц","месяца","месяцев"]);return`${T} ${P} назад`}const n=Math.floor(a/365),b=Le(n,["год","года","лет"]);return`${n} ${b} назад`}catch{return l.dream.created_at}}),xt=k(()=>{var t;const e=(t=l.dream)==null?void 0:t.created_at;if(!e)return"";try{const i=Intl.DateTimeFormat().resolvedOptions().timeZone||le.tz.guess();return le.utc(e).tz(i).format("D MMMM YYYY, HH:mm")}catch{return e}}),_t=k(()=>{var i;if((i=l.dream)!=null&&i.is_deep_analysis)return"from-[#9C41FF] to-[#C03AFF]";const e=Ve.value;if(!e||!e.dominant)return"from-[#4A58FF] to-[#5664FF]";const t=String(e.dominant).toLowerCase();return t==="emotion"?"from-[#FF4A4A] via-[#FF6B6B]/80 to-[#FF8A8A]/40":t==="memory"?"from-[#FFB84A] via-[#FFC966]/80 to-[#FFDA82]/40":t==="anticipation"?"from-[#4A9FFF] via-[#6BB3FF]/80 to-[#8AC7FF]/40":"from-[#4A58FF] to-[#5664FF]"});return(e,t)=>{var i,a,w,T;return r(),o("article",{ref_key:"rootRef",ref:X,class:he(["rounded-xl bg-gradient-to-br text-white px-8 md:px-16 transition-all overflow-hidden py-4",[_t.value,V.overlayMode?"":"cursor-pointer min-h-[4.5rem]"]]),onClick:j},[V.overlayMode?N("",!0):(r(),o("div",ds,[s("div",fs,A(E.value),1),s("div",hs,[s("div",ms,A(u.value),1),s("div",ps,A(gt.value),1)]),s("button",{class:"shrink-0 w-5 h-5 opacity-60 hover:opacity-100 flex items-center justify-center transition-opacity",onClick:t[0]||(t[0]=ue(n=>q(),["stop"])),"aria-label":"Открыть"},[...t[9]||(t[9]=[s("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[s("path",{d:"M7 4L13 10L7 16",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])])),V.active?(r(),o("div",vs,[V.overlayMode?(r(),o("div",ys,[s("h2",gs,A(u.value),1),s("div",xs,A(xt.value),1),h.value.length&&!z.value?(r(),o("div",_s,[(r(!0),o(K,null,ne(h.value,n=>(r(),o("span",{key:n,class:"inline-flex items-center px-3 py-1.5 rounded-full text-base font-medium bg-white/20 text-white"},A(n),1))),128))])):N("",!0)])):N("",!0),z.value?(r(),o(K,{key:1},[C.value?(r(),o("div",bs,[t[11]||(t[11]=s("h3",{class:"text-2xl font-bold"},"Повторяющиеся символы",-1)),s("div",ws,[D.value?(r(),o("p",ks,A(D.value),1)):N("",!0),(r(!0),o(K,null,ne(_e.value,(n,b)=>(r(),o("div",{key:`symbol-${b}`,class:"space-y-3"},[s("div",$s,[s("h4",Ms,A(n.symbol),1),s("span",Ss,"×"+A(n.frequency),1)]),s("p",Ds,A(n.description),1),s("div",Ts,[t[10]||(t[10]=s("span",{class:"font-medium opacity-80"},"В ваших снах:",-1)),we(" "+A(n.userContext),1)])]))),128))])])):N("",!0),d.value?(r(),o("div",Cs,[t[12]||(t[12]=s("h3",{class:"text-2xl font-bold"},"Динамика контекста",-1)),s("div",js,[Ae(tt,{dynamics:v.value,userAge:(i=Fe(F).profile)==null?void 0:i.age_range,userGender:(a=Fe(F).profile)==null?void 0:a.gender},null,8,["dynamics","userAge","userGender"])])])):N("",!0),m.value?(r(),o("div",As,[t[14]||(t[14]=s("h3",{class:"text-2xl font-bold"},"Заключение",-1)),s("div",Os,[p.value.periodThemes?(r(),o("p",Hs,A(p.value.periodThemes),1)):N("",!0),p.value.dreamFunctionsAnalysis?(r(),o("p",Ls,A(p.value.dreamFunctionsAnalysis),1)):N("",!0),p.value.psychologicalSupport?(r(),o("p",Fs,A(p.value.psychologicalSupport),1)):N("",!0),p.value.integrationExercise?(r(),o("div",Ys,[s("h4",Bs,[t[13]||(t[13]=s("span",null,"💫",-1)),s("span",null,A(p.value.integrationExercise.title||"Практическое упражнение"),1)]),s("p",zs,A(p.value.integrationExercise.description),1),p.value.integrationExercise.rationale?(r(),o("p",Is,A(p.value.integrationExercise.rationale),1)):N("",!0)])):N("",!0)])])):N("",!0),!C.value&&!d.value&&!m.value?(r(),o(K,{key:3},[s("div",Ns,[t[15]||(t[15]=s("div",{class:"px-3 py-2 font-semibold"},"Общий контекст серии",-1)),s("div",Us,[s("div",{innerHTML:se.value},null,8,Es)])]),h.value.length?(r(),o("div",Ws,[t[16]||(t[16]=s("div",{class:"px-3 py-2 font-semibold"},"Повторяющиеся символы",-1)),s("div",Rs,[s("div",Ps,[(r(!0),o(K,null,ne(h.value,n=>(r(),o("span",{key:"deep-"+n,class:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-white/15 text-white"},A(n),1))),128))])])])):N("",!0),be.value?(r(),o("div",Zs,[t[17]||(t[17]=s("div",{class:"px-3 py-2 font-semibold"},"Динамика",-1)),s("div",Vs,[Ae(tt,{dynamics:me.value,userAge:(w=Fe(F).profile)==null?void 0:w.age_range,userGender:(T=Fe(F).profile)==null?void 0:T.gender},null,8,["dynamics","userAge","userGender"])])])):N("",!0),ge.value.length?(r(),o("div",qs,[t[18]||(t[18]=s("div",{class:"px-3 py-2 font-semibold"},"Ключевые инсайты",-1)),s("div",Gs,[s("ol",Js,[(r(!0),o(K,null,ne(ge.value,(n,b)=>(r(),o("li",{key:"in"+b,class:"text-xs leading-relaxed"},A(n),1))),128))])])])):N("",!0),Z.value.length?(r(),o("div",Xs,[t[19]||(t[19]=s("div",{class:"px-3 py-2 font-semibold"},"Рекомендации",-1)),s("div",Ks,[s("ol",Qs,[(r(!0),o(K,null,ne(Z.value,(n,b)=>(r(),o("li",{key:"rec"+b,class:"text-xs leading-relaxed"},[typeof n=="object"&&n.title?(r(),o("div",en,[s("div",tn,A(n.title),1),s("div",sn,A(n.description),1),n.rationale?(r(),o("div",nn,A(n.rationale),1)):N("",!0)])):(r(),o("div",rn,A(typeof n=="string"?n:n.title),1))]))),128))])])])):N("",!0)],64)):N("",!0),(C.value||d.value)&&!m.value?(r(),o(K,{key:4},[ge.value.length?(r(),o("div",on,[t[20]||(t[20]=s("div",{class:"px-3 py-2 font-semibold"},"Ключевые инсайты",-1)),s("div",an,[s("ol",ln,[(r(!0),o(K,null,ne(ge.value,(n,b)=>(r(),o("li",{key:"in"+b,class:"text-xs leading-relaxed"},A(n),1))),128))])])])):N("",!0),Z.value.length?(r(),o("div",cn,[t[21]||(t[21]=s("div",{class:"px-3 py-2 font-semibold"},"Рекомендации",-1)),s("div",un,[s("ol",dn,[(r(!0),o(K,null,ne(Z.value,(n,b)=>(r(),o("li",{key:"rec"+b,class:"text-xs leading-relaxed"},[typeof n=="object"&&n.title?(r(),o("div",fn,[s("div",hn,A(n.title),1),s("div",mn,A(n.description),1),n.rationale?(r(),o("div",pn,A(n.rationale),1)):N("",!0)])):(r(),o("div",vn,A(typeof n=="string"?n:n.title),1))]))),128))])])])):N("",!0)],64)):N("",!0)],64)):(r(),o(K,{key:2},[s("div",yn,[t[22]||(t[22]=s("div",{class:"flex items-start justify-between gap-3"},[s("h3",{class:"text-2xl font-bold leading-tight"},"Сон"),s("span",{class:"opacity-70 text-pink-300 text-4xl leading-none",style:{"font-family":"Georgia, ui-serif"}},'"')],-1)),s("div",gn,[s("p",{class:he(["text-lg leading-snug transition-all",Me.dreamText?"":"line-clamp-3"])},A(V.dream.dream_text),3)]),s("div",xn,[s("button",{onClick:t[1]||(t[1]=ue(n=>Ge("dreamText"),["stop"])),class:"text-base opacity-70 hover:opacity-100 transition-opacity"},A(Me.dreamText?"Свернуть ↑":"Развернуть ↓"),1)])]),s("div",_n,[t[29]||(t[29]=s("h2",{class:"text-2xl font-bold"},"Научный подход",-1)),Te.value?(r(),o("div",bn,[t[27]||(t[27]=s("h3",{class:"text-xl font-semibold px-4 py-3"},"Контент анализ",-1)),s("div",wn,[s("div",kn,[(r(!0),o(K,null,ne(vt.value,n=>(r(),o("div",{key:n.key,class:"space-y-1"},[s("div",$n,[s("span",Mn,A(n.label),1),s("span",Sn,[we(A(n.value)+"% ",1),n.norm!==null?(r(),o(K,{key:0},[we(" / "+A(n.norm)+"%",1)],64)):N("",!0),n.delta!==null?(r(),o("span",{key:1,class:he(n.delta>0?"text-green-300":n.delta<0?"text-red-300":"text-white/70")}," ("+A(n.delta>0?"+"+n.delta:n.delta)+"pp) ",3)):N("",!0)])]),s("div",Dn,[n.norm!==null?(r(),o("div",{key:0,class:"absolute inset-y-0 left-0 bg-white/20",style:Qe({width:n.norm+"%"})},null,4)):N("",!0),s("div",{class:"relative h-full bg-white/70",style:Qe({width:n.value+"%"})},null,4)])]))),128)),s("div",Tn,[t[25]||(t[25]=s("span",{class:"inline-flex items-center gap-2"},[s("span",{class:"w-2.5 h-2.5 rounded-full inline-block bg-white/70 shrink-0"}),we(),s("span",{class:"leading-tight"},"ваш сон")],-1)),s("span",Cn,[t[23]||(t[23]=s("span",{class:"w-2.5 h-2.5 rounded-full inline-block bg-white/20 shrink-0"},null,-1)),t[24]||(t[24]=we()),s("span",jn,A(yt.value),1)])]),t[26]||(t[26]=s("div",{class:"text-base opacity-70 flex items-start gap-2 leading-tight"},[s("span",{class:"inline-flex items-center justify-center w-4 h-4 rounded-full bg-white/20 text-white text-[10px] shrink-0 aspect-square mt-0.5"},"i"),s("span",null,"Контент‑анализ по схеме HVdC; сравнение с демографическими нормами (DreamBank, SDDB).")],-1))])])])):N("",!0),(r(!0),o(K,null,ne(qe.value,(n,b)=>(r(),o(K,{key:n.key},[n.key==="func"?(r(),o("div",An,[s("h3",On,A(n.title),1),s("div",Hn,[s("div",{innerHTML:dt(n.html),class:"text-lg leading-snug"},null,8,Ln),Je(n.html)?(r(),o("div",Fn,[s("button",{onClick:t[2]||(t[2]=ue(P=>Ge("funcExercise"),["stop"])),class:"w-full flex items-center justify-between text-left font-semibold hover:opacity-80 transition-opacity"},[t[28]||(t[28]=s("span",null,"Функциональное упражнение",-1)),s("span",Yn,A(Me.funcExercise?"−":"+"),1)]),Dt(s("div",{class:"mt-3",innerHTML:Je(n.html)},null,8,Bn),[[Tt,Me.funcExercise]])])):N("",!0)])])):N("",!0)],64))),128))]),s("div",zn,[t[30]||(t[30]=s("h2",{class:"text-2xl font-bold"},"Психоаналитический подход",-1)),(r(!0),o(K,null,ne(qe.value,(n,b)=>(r(),o(K,{key:`psycho-${n.key}`},[["arch","freud","jung"].includes(n.key)?(r(),o("div",In,[s("h3",Nn,A(n.title),1),s("div",Un,[s("div",{innerHTML:n.html,class:"text-lg leading-snug space-y-2"},null,8,En)])])):N("",!0)],64))),128))])],64)),s("div",Wn,[s("button",{class:he(["flex-1 rounded-xl py-2 text-sm font-medium text-center transition-colors",I.value===1?"bg-green-500/30 text-white ring-2 ring-green-400/60":"bg-white/20 hover:bg-white/30 text-white"]),onClick:ue(g,["stop"])}," 👍 ",2),s("button",{class:he(["flex-1 rounded-xl py-2 text-sm font-medium text-center transition-colors",I.value===2?"bg-red-500/30 text-white ring-2 ring-red-400/60":"bg-white/20 hover:bg-white/30 text-white"]),onClick:ue(f,["stop"])}," 👎 ",2),s("button",{class:"flex-1 bg-red-500/20 hover:bg-red-500/30 text-white rounded-xl py-2 text-sm font-medium text-center transition-colors",onClick:ue(O,["stop"])}," 🗑️ ")]),Xe.value&&Ne.value?(r(),o("div",Rn,[t[31]||(t[31]=s("div",{class:"mb-2 opacity-80"},"Debug payload",-1)),we(" "+A(JSON.stringify(Ne.value,null,2))+" ",1),s("div",Pn,[s("button",{class:"px-3 py-1 rounded bg-white/10 hover:bg-white/20",onClick:ue(ft,["stop"])},"Скопировать")])])):N("",!0),(r(),Ye(st,{to:"body"},[Ue.value?(r(),o("div",{key:0,class:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/70",onClick:ue(Ee,["self"]),onWheel:t[7]||(t[7]=ue(()=>{},["prevent"])),onTouchmove:t[8]||(t[8]=ue(()=>{},["prevent"]))},[s("div",{class:"w-[92vw] max-w-[440px] rounded-2xl bg-[var(--tg-theme-secondary-bg-color,#0c110c)] text-white p-4 shadow-2xl border border-white/10",onClick:t[6]||(t[6]=ue(()=>{},["stop"]))},[t[34]||(t[34]=s("h3",{class:"text-lg font-semibold mb-2"},"Уточнить данные",-1)),Ke.value===1?(r(),o("div",Zn,[t[32]||(t[32]=s("p",{class:"opacity-90"},"Ваш возрастной диапазон:",-1)),s("div",Vn,[(r(),o(K,null,ne(mt,n=>s("button",{key:n,class:he(["px-4 py-3 rounded-xl text-sm",He.value===n?"bg-white/25":"bg-white/10 hover:bg-white/15"]),onClick:b=>He.value=n},A(n),11,qn)),64))]),s("div",Gn,[s("button",{class:"px-4 py-2 rounded-xl bg-white/10",onClick:Ee},"Отмена"),s("button",{class:"px-4 py-2 rounded-xl bg-white/20",disabled:!He.value,onClick:t[3]||(t[3]=n=>Ke.value=2)},"Далее",8,Jn)])])):(r(),o("div",Xn,[t[33]||(t[33]=s("p",{class:"opacity-90"},"Ваш пол:",-1)),s("div",Kn,[s("button",{class:he(["px-4 py-3 rounded-xl text-sm",Se.value==="male"?"bg-white/25":"bg-white/10 hover:bg-white/15"]),onClick:t[4]||(t[4]=n=>Se.value="male")},"Мужской",2),s("button",{class:he(["px-4 py-3 rounded-xl text-sm",Se.value==="female"?"bg-white/25":"bg-white/10 hover:bg-white/15"]),onClick:t[5]||(t[5]=n=>Se.value="female")},"Женский",2)]),s("div",Qn,[s("button",{class:"px-4 py-2 rounded-xl bg-white/10",onClick:Ee},"Отмена"),s("button",{class:"px-4 py-2 rounded-xl bg-white/20",disabled:!Se.value,onClick:pt},"Сохранить",8,ei)])]))])],32)):N("",!0)]))])):N("",!0)],2)}}}),Ze=Ie(si,[["__scopeId","data-v-229afd48"]]),ni={class:"pb-6 overlay-pad"},ii=Be({__name:"DreamOverlay",props:{dream:{},anchorY:{}},emits:["close"],setup(V,{emit:J}){le.locale("ru"),le.extend(ot),le.extend(lt);const l=V,R=J,X=new Set(["и","в","во","не","что","он","на","я","с","со","как","а","то","все","она","так","его","но","да","ты","к","у","же","вы","за","бы","по","ее","мне","было","вот","от","меня","еще","нет","о","из","ему","теперь","когда","даже","ну","вдруг","ли","если","уже","или","ни","быть","был","него","до","вас","нибудь","опять","уж","вам","ведь","там","потом","себя","ничего","ей","может","они","тут","где","есть","надо","ней","для","мы","тебя","их","чем","была","сам","чтоб","без","будто","чего","раз","тоже","себе","под","будет","ж","тогда","кто","этот","того","потому","этого","какой","совсем","ним","здесь","этом","один","почти","мой","тем","чтобы","нее","кажется","сейчас","были","куда","зачем","всех","никогда","можно","при","наконец","два","об","другой","хоть","после","над","больше","тот","через","эти","нас","про","всего","них","какая","много","разве","три","эту","моя","впрочем","хорошо","свою","этой","перед","иногда","лучше","чуть","том","нельзя","такой","им","более","всегда","конечно","всю","между"]),q=u=>String(u||"").replace(/\s+/g," ").trim().split(" ").map(h=>h.charAt(0).toUpperCase()+h.slice(1)).join(" "),j=u=>{if(!u)return"";const h=String(u).split(/[.!?\n]/)[0],L=h.toLowerCase().replace(/[^\p{L}\p{N}\s-]/gu,"").split(/\s+/).filter(U=>U&&!X.has(U)&&U.length>3).slice(0,3);return L.length===0?h.slice(0,40):q(L.join(" "))},F=u=>{if(!u)return"";let h=String(u).toLowerCase().replace(/["'«»]/g,"").trim();h=h.replace(/^(приснилось|снилось|сон о|сон про|сон|мне снится|мне приснилось)\s+/i,""),h=h.replace(/\s+/g," ").trim();const S=h.split(" ").filter(Boolean).slice(0,3);return S.length?S.join(" "):""},_=u=>{if(!u)return"";const h=String(u).toLowerCase();return h.charAt(0).toUpperCase()+h.slice(1)};k(()=>{var D,ve,_e,C,v;const u=F(String(((ve=(D=l.dream)==null?void 0:D.deep_source)==null?void 0:ve.title)||""));if(u)return _(u);const h=(((C=(_e=l.dream)==null?void 0:_e.deep_source)==null?void 0:C.tags)||[]).filter(Boolean),S=d=>{var m;let p=String(d||"").trim();return p=((m=p.split(/[\\/,(;:—–-]/)[0])==null?void 0:m.trim())||"",p?p.charAt(0).toUpperCase()+p.slice(1).toLowerCase():""},L=h.map(S).filter(Boolean);if(L.length){const d=L.slice(0,2).join(" и ");return _(d||"Без названия")}const U=F(j(String(((v=l.dream)==null?void 0:v.dream_text)||"")));return _(U||"Без названия")}),k(()=>{var h;const u=(h=l.dream)==null?void 0:h.created_at;if(!u)return"";try{const S=Intl.DateTimeFormat().resolvedOptions().timeZone||le.tz.guess();return le.utc(u).tz(S).format("D MMMM YYYY, HH:mm")}catch{return u}});function z(){var u,h,S,L,U;try{const D=(u=window==null?void 0:window.Telegram)==null?void 0:u.WebApp;(S=(h=D==null?void 0:D.BackButton)==null?void 0:h.show)==null||S.call(h),(U=(L=D==null?void 0:D.BackButton)==null?void 0:L.onClick)==null||U.call(L,I)}catch{}}function E(){var u,h,S,L,U;try{const D=(u=window==null?void 0:window.Telegram)==null?void 0:u.WebApp;(S=(h=D==null?void 0:D.BackButton)==null?void 0:h.hide)==null||S.call(h),(U=(L=D==null?void 0:D.BackButton)==null?void 0:L.offClick)==null||U.call(L,I)}catch{}}function I(){R("close")}const M=ie(null);function W(u){const h=M.value;h&&h.contains(u.target)||R("close")}Ct(()=>{jt(()=>l.dream,u=>{if(u){try{document.body.style.overflow="hidden"}catch{}z()}else{E();try{document.body.style.overflow=""}catch{}}},{immediate:!0})}),At(()=>{E();try{document.body.style.overflow=""}catch{}});const g=ie(null);let f=0,O=!1,H=!1,c=0;function y(u){try{const h=g.value;if(!h||(H=h.scrollTop<=0,!H))return;f=u.touches[0].clientY,c=0,O=!0}catch{}}function $(u){if(!O||!H)return;const h=u.touches[0].clientY;if(c=Math.max(0,h-f),c>0){u.preventDefault();const S=M.value;S&&(S.style.transform=`translateY(${Math.min(120,c)}px)`)}}function x(){if(O&&H&&c>=120)R("close");else{const u=M.value;u&&(u.style.transform="")}O=!1,H=!1,f=0,c=0}return(u,h)=>(r(),Ye(st,{to:"body"},[V.dream?(r(),o("div",{key:0,class:"fixed inset-0 z-[9998] bg-black/70 backdrop-blur-sm",onClick:W},[s("div",{class:"absolute inset-0 overflow-y-auto",ref_key:"scrollerRef",ref:g,onTouchstart:y,onTouchmove:$,onTouchend:x},[s("div",ni,[s("div",{ref_key:"cardRef",ref:M,onClick:h[0]||(h[0]=ue(()=>{},["stop"]))},[Ae(Ze,{dream:V.dream,active:!0,overlayMode:!0},null,8,["dream"])],512)])],544)])):N("",!0)]))}}),ri=Ie(ii,[["__scopeId","data-v-26f85075"]]),oi={class:"flex items-center gap-8 mb-6 border-b",style:{"border-color":"var(--tg-theme-hint-color, rgba(255,255,255,0.1))"}},ai={key:0,class:"absolute bottom-0 left-0 right-0 h-0.5 rounded-full",style:{"background-color":"var(--tg-theme-text-color, #ffffff)"}},li={key:0,class:"absolute bottom-0 left-0 right-0 h-0.5 rounded-full",style:{"background-color":"var(--tg-theme-text-color, #ffffff)"}},ci={key:0,class:"flex flex-col gap-4 pb-[5vh]"},ui={key:1,class:"text-center text-red-400 py-8"},di={key:2},fi={key:0,class:"text-center text-white/60 py-8"},hi={key:1,class:"flex flex-col gap-4 pb-[5vh]"},mi={key:3},pi={key:0,class:"text-center text-white/60 py-8"},vi={key:1,class:"flex flex-col gap-4 pb-[5vh]"},yi=Be({__name:"AnalysisHistoryList",props:["userStore"],setup(V){const J=V,l=ie(null),R=ie(null),X=ie(5),q=ie(5),j=ie("history"),F=k(()=>{var c;return(c=J.userStore)!=null&&c.history?J.userStore.history.filter(y=>!y.is_deep_analysis):[]}),_=k(()=>{var c;return(c=J.userStore)!=null&&c.history?J.userStore.history.filter(y=>y.is_deep_analysis):[]}),z=k(()=>F.value.slice(0,X.value)),E=k(()=>_.value.slice(0,q.value)),I=k(()=>F.value.length>X.value),M=k(()=>_.value.length>q.value),W=()=>{window.triggerHaptic&&window.triggerHaptic("light"),X.value+=5},g=()=>{window.triggerHaptic&&window.triggerHaptic("light"),q.value+=5},f=c=>{window.triggerHaptic&&window.triggerHaptic("light"),j.value=c,l.value=null},O=(c,y)=>{var $,x,u,h,S;l.value=c,R.value=typeof(y==null?void 0:y.y)=="number"?Math.max(0,Math.round(y.y)):null;try{const L=($=window==null?void 0:window.Telegram)==null?void 0:$.WebApp;(u=(x=L==null?void 0:L.BackButton)==null?void 0:x.onClick)==null||u.call(x,()=>H()),(S=(h=L==null?void 0:L.BackButton)==null?void 0:h.show)==null||S.call(h)}catch{}},H=()=>{var c,y,$;try{const x=(c=window==null?void 0:window.Telegram)==null?void 0:c.WebApp;($=(y=x==null?void 0:x.BackButton)==null?void 0:y.hide)==null||$.call(y)}catch{}l.value=null,R.value=null};return(c,y)=>{var $,x,u,h;return r(),o("div",null,[s("div",oi,[s("button",{onClick:y[0]||(y[0]=S=>f("history")),class:he(["relative pb-3 text-lg font-semibold transition-all duration-200",[j.value==="history"?"tab-active":"tab-inactive"]])},[y[2]||(y[2]=we(" Дневник снов ",-1)),j.value==="history"?(r(),o("div",ai)):N("",!0)],2),s("button",{onClick:y[1]||(y[1]=S=>f("deep")),class:he(["relative pb-3 text-lg font-semibold transition-all duration-200",[j.value==="deep"?"tab-active":"tab-inactive"]])},[y[3]||(y[3]=we(" Глубокий анализ ",-1)),j.value==="deep"?(r(),o("div",li)):N("",!0)],2)]),($=V.userStore)!=null&&$.isLoadingHistory?(r(),o("div",ci,[(r(),o(K,null,ne(3,S=>s("div",{key:S,class:"rounded-xl bg-white/10 px-8 md:px-16 py-6"},[...y[4]||(y[4]=[Ot('<div class="flex justify-between items-center py-2 min-h-[2.5rem]" data-v-832edabc><div class="shimmer h-4 w-32 rounded" data-v-832edabc></div><div class="shimmer h-4 w-12 rounded" data-v-832edabc></div></div><div class="mt-4 space-y-2" data-v-832edabc><div class="shimmer h-3 w-full rounded" data-v-832edabc></div><div class="shimmer h-3 w-5/6 rounded" data-v-832edabc></div><div class="shimmer h-3 w-2/3 rounded" data-v-832edabc></div></div><div class="mt-4 grid grid-cols-3 gap-2" data-v-832edabc><div class="shimmer h-6 rounded-full" data-v-832edabc></div><div class="shimmer h-6 rounded-full" data-v-832edabc></div><div class="shimmer h-6 rounded-full" data-v-832edabc></div></div>',3)])])),64))])):(x=V.userStore)!=null&&x.errorHistory?(r(),o("div",ui," Ошибка загрузки: "+A(V.userStore.errorHistory),1)):j.value==="history"?(r(),o("div",di,[(u=F.value)!=null&&u.length?(r(),o("div",hi,[(r(!0),o(K,null,ne(z.value,S=>(r(),Ye(Ze,{key:S.id,dream:S,onOpen:L=>O(S,L)},null,8,["dream","onOpen"]))),128)),I.value?(r(),o("button",{key:0,class:"self-center rounded-full px-4 py-2 text-sm font-medium transition-colors my-2 themed-button",onClick:W}," Загрузить ещё ")):N("",!0)])):(r(),o("div",fi," У вас пока нет сохраненных анализов "))])):j.value==="deep"?(r(),o("div",mi,[(h=_.value)!=null&&h.length?(r(),o("div",vi,[(r(!0),o(K,null,ne(E.value,S=>(r(),Ye(Ze,{key:S.id,dream:S,onOpen:L=>O(S,L)},null,8,["dream","onOpen"]))),128)),M.value?(r(),o("button",{key:0,class:"self-center rounded-full px-4 py-2 text-sm font-medium transition-colors my-2 themed-button",onClick:g}," Загрузить ещё ")):N("",!0)])):(r(),o("div",pi," Пока нет глубоких анализов "))])):N("",!0),Ae(ri,{dream:l.value,"anchor-y":R.value,onClose:H},null,8,["dream","anchor-y"])])}}}),bi=Ie(yi,[["__scopeId","data-v-832edabc"]]);export{bi as default};
